<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tannenhofs tidtabell</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --brand:#2f7a3f;           /* Tannenhof-gr√∂n */
    --brand-dark:#256333;
    --ink:#213027;
    --muted:#5b6b61;
    --bg:#f5f9f6;
    --card:#ffffff;
    --ring:#cfe5d6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    color:var(--ink);
    background:var(--bg);
  }
  header{
    position:sticky;top:0;z-index:10;
    background:var(--brand);
    color:#fff; padding:14px 18px;
    display:flex; gap:12px; align-items:center;
    box-shadow:0 2px 6px rgb(0 0 0 / .08);
  }
  header .logo{
    width:28px;height:28px;border-radius:6px;display:grid;place-items:center;
    background:#1e5d2a;font-size:18px
  }
  header h1{font-size:18px;line-height:1.2;margin:0;font-weight:600}
  main{max-width:1000px;margin:18px auto; padding:0 14px 80px}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:0 6px 24px rgb(10 40 20/.06)}
  .toolbar{
    padding:12px 12px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between
  }
  .chip{display:inline-flex;align-items:center;gap:8px;background:#e9f3eb;border:1px solid var(--ring);padding:8px 10px;border-radius:10px}
  button,.btn{
    appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;
    background:var(--brand);color:#fff;cursor:pointer
  }
  button.secondary{background:#e8efe9;color:#113; font-weight:600}
  button.ghost{background:transparent;color:var(--brand);border:1px solid var(--ring)}
  button:active{transform:translateY(1px)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .fab{
    position:fixed; right:16px; bottom:18px; z-index:20;
    width:56px;height:56px;border-radius:50%;display:grid;place-items:center;
    background:var(--brand); color:#fff; font-size:22px; box-shadow:0 12px 30px rgb(10 40 20/.22)
  }
  /* Settings drawer */
  .backdrop{position:fixed;inset:0;background:rgb(0 0 0 / .35); display:none; z-index:30}
  .drawer{
    position:fixed; right:-420px; top:0; height:100%; width:min(420px,96vw);
    background:var(--card); border-left:1px solid var(--ring); z-index:31;
    transition:right .25s ease; padding:18px; overflow:auto
  }
  .backdrop.show{display:block}
  .drawer.show{ right:0 }
  .set h3{margin:.4rem 0 .5rem;font-size:15px;color:var(--muted)}
  .set .row{display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:12px}
  .set input[type="text"], .set select, .set input[type="file"], .set input[type="time"], .set input[type="number"]{
    width:100%; border:1px solid var(--ring); background:#fff; color:var(--ink);
    padding:10px 12px; border-radius:10px; font-size:15px
  }
  .set .inline{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid var(--ring);background:#f4faf6}
  /* Times grid */
  .sheet{margin-top:14px}
  .thead, .row{
    display:grid; grid-template-columns:60px 1fr 1fr 120px 120px auto;
    gap:8px; align-items:center
  }
  .thead{padding:12px;font-weight:700;color:var(--muted)}
  .row{padding:10px 12px}
  .row input[type="time"], .row input[type="text"], .row input[type="number"]{
    width:100%; border:1px solid var(--ring); padding:9px 10px; border-radius:10px; background:#fff
  }
  .row .total{font-weight:700; text-align:right}
  .row:nth-child(odd){background:#f8fbf9}
  .footer{
    display:flex; gap:10px; flex-wrap:wrap; padding:14px; border-top:1px solid var(--ring);
    background:#fbfdfc; border-radius:0 0 14px 14px
  }
  .stat{padding:10px 12px; border:1px solid var(--ring); border-radius:10px;background:#fff}
  /* Readonly banner */
  .banner{margin-bottom:12px; padding:10px 12px; background:#fff3c4; border:1px solid #f3e29a; border-radius:10px}
  @media print{
    .fab,.backdrop,.drawer,.toolbar{display:none!important}
    body{background:white} .card{border:0; box-shadow:none}
  }
</style>
</head>
<body>

<header>
  <div class="logo" id="logoBox">üå≤</div>
  <h1 id="title">Tannenhofs tidtabell</h1>
</header>

<main>
  <div class="toolbar">
    <div class="chip" id="companyChip">üè¢ <span id="companyLabel">TH√úRINGER TANNENHOF</span></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="ghost" id="btnShare"></span> Dela / Skicka</button>
      <button id="btnPrint">Skriv ut / PDF</button>
    </div>
  </div>

  <div id="roBanner" class="banner" style="display:none"></div>

  <div class="card sheet" id="sheetCard">
    <div class="thead" id="thead">
      <div data-i18n="day">Dag</div>
      <div data-i18n="from">Fr√•n</div>
      <div data-i18n="to">Till</div>
      <div data-i18n="break">Paus (h:mm)</div>
      <div data-i18n="total">Totalt (h)</div>
      <div data-i18n="note">Anteckning</div>
    </div>
    <div id="rows"></div>
    <div class="footer" id="stats">
      <div class="stat" id="sumBox">Œ£ 0.00 h</div>
      <div class="stat" id="maxBox">L√§ngsta dag: 0.00 h</div>
      <div class="stat" id="avgBox">Snitt: 0.00 h</div>
    </div>
  </div>
</main>

<!-- Floating settings button -->
<button class="fab" id="openFab" title="Inst√§llningar">‚öôÔ∏è</button>

<!-- Settings Drawer -->
<div class="backdrop" id="backdrop"></div>
<aside class="drawer" id="drawer" aria-label="Inst√§llningar">
  <div class="set">
    <h2 style="margin:0 0 8px">Inst√§llningar</h2>
    <div class="pill" style="margin-bottom:12px"><span style="font-weight:700">Tannenhof</span> ‚Äì Timesheet v3</div>

    <h3 data-i18n="company">F√∂retag</h3>
    <div class="row">
      <input id="company" type="text" placeholder="TH√úRINGER TANNENHOF">
    </div>

    <h3 data-i18n="logoLabel">Logga (bild eller emoji)</h3>
    <div class="row">
      <input id="logoEmoji" type="text" placeholder="t.ex. üå≤ eller ü¶å">
      <input id="logoFile" type="file" accept="image/*">
    </div>

    <h3 data-i18n="language">Spr√•k</h3>
    <div class="row">
      <select id="lang">
        <option value="sv">Svenska</option>
        <option value="de">Deutsch</option>
        <option value="en">English</option>
      </select>
    </div>

    <div class="inline">
      <div>
        <h3 data-i18n="month">M√•nad</h3>
        <select id="month"></select>
      </div>
      <div>
        <h3 data-i18n="year">√Ör</h3>
        <input id="year" type="number" min="2000" max="2100">
      </div>
    </div>

    <h3 data-i18n="quickfill">Snabbifyll (vardagar)</h3>
    <div class="inline">
      <input id="qFrom" type="time" value="07:00">
      <input id="qTo" type="time" value="16:00">
    </div>
    <div class="row">
      <label class="pill"><span data-i18n="breakShort">Paus</span> <input id="qBreak" type="time" value="00:30"></label>
    </div>
    <div class="row" style="display:flex; gap:8px">
      <button id="btnApplyQuick" class="secondary" type="button" data-i18n="applyQuick">Fyll i vardagar</button>
      <button id="btnGenerate" type="button" data-i18n="genDays">Skapa dagar</button>
    </div>

    <h3 data-i18n="autosave">Autospara</h3>
    <div class="row" style="display:flex; gap:8px; align-items:center">
      <label class="pill"><input id="autosave" type="checkbox"> <span data-i18n="autosaveLabel">(av/p√•)</span></label>
      <button id="btnClear" class="ghost" type="button" data-i18n="clearAll">Rensa allt</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="closeDrawer" class="ghost" type="button" data-i18n="close">St√§ng</button>
    </div>
  </div>
</aside>

<script>
/* ---------- i18n ---------- */
const I18N = {
  sv: {
    title:"Tannenhofs tidtabell",
    day:"Dag", from:"Fr√•n", to:"Till", break:"Paus (h:mm)", total:"Totalt (h)", note:"Anteckning",
    company:"F√∂retag", logoLabel:"Logga (bild eller emoji)", language:"Spr√•k",
    month:"M√•nad", year:"√Ör", genDays:"Skapa dagar",
    quickfill:"Snabbifyll (vardagar)", applyQuick:"Fyll i vardagar", breakShort:"Paus",
    autosave:"Autospara", autosaveLabel:"(av/p√•)", clearAll:"Rensa allt", close:"St√§ng",
    share:"Dela / Skicka", print:"Skriv ut / PDF",
    readonly:"Skrivskyddad vy (delad l√§nk)."
  },
  de: {
    title:"Tannenhof Stundenliste",
    day:"Tag", from:"Von", to:"Bis", break:"Pause (Std:Min)", total:"Gesamt (Std)", note:"Notiz",
    company:"Arbeitgeber", logoLabel:"Logo (Bild oder Emoji)", language:"Sprache",
    month:"Monat", year:"Jahr", genDays:"Tage erstellen",
    quickfill:"Schnell ausf√ºllen (Werktage)", applyQuick:"Werktage f√ºllen", breakShort:"Pause",
    autosave:"Autom. Speichern", autosaveLabel:"(aus/an)", clearAll:"Alles l√∂schen", close:"Schlie√üen",
    share:"Teilen / Senden", print:"Drucken / PDF",
    readonly:"Schreibgesch√ºtzte Ansicht (geteilter Link)."
  },
  en: {
    title:"Tannenhof Timesheet",
    day:"Day", from:"From", to:"To", break:"Break (h:mm)", total:"Total (h)", note:"Note",
    company:"Company", logoLabel:"Logo (image or emoji)", language:"Language",
    month:"Month", year:"Year", genDays:"Generate days",
    quickfill:"Quick fill (weekdays)", applyQuick:"Fill weekdays", breakShort:"Break",
    autosave:"Autosave", autosaveLabel:"(off/on)", clearAll:"Clear all", close:"Close",
    share:"Share / Send", print:"Print / PDF",
    readonly:"Read-only view (shared link)."
  }
};
const MONTHS = {
  sv:["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"],
  de:["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],
  en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
};

/* ---------- DOM ---------- */
const els = {
  title: document.getElementById('title'),
  logoBox: document.getElementById('logoBox'),
  companyChip: document.getElementById('companyChip'),
  companyLabel: document.getElementById('companyLabel'),
  rows: document.getElementById('rows'),
  sumBox: document.getElementById('sumBox'),
  maxBox: document.getElementById('maxBox'),
  avgBox: document.getElementById('avgBox'),
  btnPrint: document.getElementById('btnPrint'),
  btnShare: document.getElementById('btnShare'),
  roBanner: document.getElementById('roBanner'),

  // drawer
  backdrop: document.getElementById('backdrop'),
  drawer: document.getElementById('drawer'),
  openFab: document.getElementById('openFab'),
  closeDrawer: document.getElementById('closeDrawer'),

  company: document.getElementById('company'),
  logoEmoji: document.getElementById('logoEmoji'),
  logoFile: document.getElementById('logoFile'),
  lang: document.getElementById('lang'),
  month: document.getElementById('month'),
  year: document.getElementById('year'),
  btnGenerate: document.getElementById('btnGenerate'),
  autosave: document.getElementById('autosave'),
  btnClear: document.getElementById('btnClear'),
  qFrom: document.getElementById('qFrom'),
  qTo: document.getElementById('qTo'),
  qBreak: document.getElementById('qBreak'),
  btnApplyQuick: document.getElementById('btnApplyQuick')
};

/* ---------- State ---------- */
const state = {
  lang: localStorage.getItem('tf_lang') || 'sv',
  company: localStorage.getItem('tf_company') || 'TH√úRINGER TANNENHOF',
  logoEmoji: localStorage.getItem('tf_logoEmoji') || 'üå≤',
  logoImg: localStorage.getItem('tf_logoImg') || null,
  month: +(localStorage.getItem('tf_month') ?? (new Date().getMonth())),
  year: +(localStorage.getItem('tf_year') ?? (new Date().getFullYear())),
  autosave: localStorage.getItem('tf_autosave') === '1',
  rows: JSON.parse(localStorage.getItem('tf_rows') || '[]'),
  readonly: false
};

/* ---------- Init ---------- */
function initFromURL(){
  const h = location.hash.slice(1);
  if(!h) return;
  try{
    const obj = JSON.parse(decodeURIComponent(atob(h)));
    Object.assign(state, obj);
    state.readonly = true;
  }catch{}
}
initFromURL();

function applyI18n(){
  const t = I18N[state.lang];
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n');
    if(t[k]) el.textContent = t[k];
  });
  els.title.textContent = t.title;
  document.title = t.title;
  // months
  els.month.innerHTML = MONTHS[state.lang].map((m,i)=>`<option value="${i}">${m}</option>`).join('');
}
function applyHeader(){
  els.companyLabel.textContent = state.company;
  if(state.logoImg){
    els.logoBox.style.backgroundImage = `url(${state.logoImg})`;
    els.logoBox.style.backgroundSize = 'cover';
    els.logoBox.textContent = '';
  }else{
    els.logoBox.style.backgroundImage = '';
    els.logoBox.textContent = state.logoEmoji || 'üå≤';
  }
}
function bindDrawer(){
  els.lang.value = state.lang;
  els.company.value = state.company;
  els.logoEmoji.value = state.logoEmoji;
  els.month.value = state.month;
  els.year.value = state.year;
  els.autosave.checked = state.autosave;

  const open = ()=>{ els.backdrop.classList.add('show'); els.drawer.classList.add('show'); };
  const close = ()=>{ els.backdrop.classList.remove('show'); els.drawer.classList.remove('show'); };
  els.openFab.onclick = open;
  els.closeDrawer.onclick = close;
  els.backdrop.onclick = close;

  els.lang.onchange = ()=>{ state.lang = els.lang.value; localStorage.setItem('tf_lang', state.lang); applyI18n(); render(); };
  els.company.oninput = ()=>{ state.company = els.company.value; localStorage.setItem('tf_company', state.company); applyHeader(); };
  els.logoEmoji.oninput = ()=>{ state.logoEmoji = els.logoEmoji.value; localStorage.setItem('tf_logoEmoji', state.logoEmoji); state.logoImg=null; localStorage.removeItem('tf_logoImg'); applyHeader(); };
  els.logoFile.onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload = ()=>{ state.logoImg = rd.result; localStorage.setItem('tf_logoImg', state.logoImg); applyHeader(); };
    rd.readAsDataURL(f);
  };
  els.month.onchange = ()=>{ state.month = +els.month.value; localStorage.setItem('tf_month', state.month); };
  els.year.oninput = ()=>{ state.year = +els.year.value; localStorage.setItem('tf_year', state.year); };
  els.autosave.onchange = ()=>{ state.autosave = els.autosave.checked; localStorage.setItem('tf_autosave', state.autosave?'1':'0'); };

  els.btnGenerate.onclick = ()=>{ generateDays(); };
  els.btnApplyQuick.onclick = ()=>{ applyQuickFill(); };

  els.btnClear.onclick = ()=>{
    if(!confirm('Rensa alla tider?')) return;
    state.rows = []; saveRows(); renderRows();
  };
}
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

function generateDays(){
  const n = daysInMonth(state.year, state.month);
  const existing = state.rows;
  const next = [];
  for(let d=1; d<=n; d++){
    const found = existing.find(r=>r.day===d);
    next.push(found || {day:d, from:"", to:"", brk:"", note:""});
  }
  state.rows = next;
  saveRows(); renderRows();
}

function applyQuickFill(){
  const wf = els.qFrom.value || "";
  const wt = els.qTo.value || "";
  const wb = els.qBreak.value || "";
  state.rows = state.rows.map((r,i)=>{
    // 0=Sun, 1=Mon ... we treat Mon-Fri as weekdays
    const date = new Date(state.year, state.month, r.day);
    const wd = date.getDay();
    if(wd>=1 && wd<=5){
      return {...r, from: wf, to: wt, brk: wb};
    }
    return r;
  });
  saveRows(); renderRows();
}

function toHours(hmm){
  if(!hmm) return 0;
  const [h,m] = hmm.split(':').map(x=>+x||0);
  return h + (m/60);
}
function diffTime(a,b){ // b - a (HH:MM)
  if(!a||!b) return 0;
  const [ah,am]=a.split(':').map(Number), [bh,bm]=b.split(':').map(Number);
  return (bh+bm/60)-(ah+am/60);
}
function calcRow(r){
  const span = diffTime(r.from, r.to);
  const minus = toHours(r.brk);
  const total = Math.max(0, +(span - minus).toFixed(2));
  return total;
}

function renderRows(){
  els.rows.innerHTML = '';
  state.rows.forEach((r,idx)=>{
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div>${r.day}</div>
      <div><input ${state.readonly?'disabled':''} data-k="from" type="time" value="${r.from||''}"></div>
      <div><input ${state.readonly?'disabled':''} data-k="to" type="time" value="${r.to||''}"></div>
      <div><input ${state.readonly?'disabled':''} data-k="brk" type="time" value="${r.brk||''}"></div>
      <div class="total" id="t${idx}">${calcRow(r).toFixed(2)}</div>
      <div><input ${state.readonly?'disabled':''} data-k="note" type="text" value="${r.note||''}" placeholder="-"></div>
    `;
    row.querySelectorAll('input').forEach(inp=>{
      inp.oninput = ()=>{
        const k = inp.getAttribute('data-k');
        state.rows[idx][k] = inp.value;
        const val = calcRow(state.rows[idx]).toFixed(2);
        document.getElementById('t'+idx).textContent = val;
        if(state.autosave) saveRows();
        renderStats();
      };
    });
    els.rows.appendChild(row);
  });
  renderStats();
}

function renderStats(){
  let sum=0, max=0, count=0;
  state.rows.forEach(r=>{
    const v = calcRow(r);
    if(v>0){ sum+=v; max=Math.max(max,v); count++; }
  });
  const avg = count? (sum/count):0;
  els.sumBox.textContent = `Œ£ ${sum.toFixed(2)} h`;
  els.maxBox.textContent = `${t('longest','sv','L√§ngsta dag:')} ${max.toFixed(2)} h`;
  els.avgBox.textContent = `${t('avg','sv','Snitt:')} ${avg.toFixed(2)} h`;
}

function t(key, fallbackLang, fallbackText){
  // small helper for a few dynamic labels
  const map = {
    longest: {sv:"L√§ngsta dag:", de:"L√§ngster Tag:", en:"Longest day:"},
    avg: {sv:"Snitt:", de:"Durchschnitt:", en:"Average:"}
  };
  return (map[key] && map[key][state.lang]) || (map[key] && map[key][fallbackLang]) || fallbackText || key;
}

/* ---------- Save/Load ---------- */
function saveRows(){ localStorage.setItem('tf_rows', JSON.stringify(state.rows)); }

/* ---------- Share & Print ---------- */
els.btnPrint.onclick = ()=> window.print();

els.btnShare.onclick = async ()=>{
  // Build share payload (read-only)
  const payload = {
    lang: state.lang, company: state.company, logoEmoji: state.logoEmoji, logoImg: state.logoImg,
    month: state.month, year: state.year, rows: state.rows
  };
  const hash = btoa(encodeURIComponent(JSON.stringify(payload)));
  const url = location.origin + location.pathname + '#'+hash;

  // Try Web Share
  const title = I18N[state.lang].title;
  try{
    if(navigator.share){
      await navigator.share({title, text: state.company, url});
      return;
    }
  }catch{}

  // Fallback: show prompt + QR via external API
  const qr = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;
  const txt = (state.lang==='de'?'Link kopiert!':'L√§nk kopierad!');
  await navigator.clipboard.writeText(url).catch(()=>{});
  alert((state.lang==='de'?'Schreibe-gesch√ºtzte Link wird angezeigt.':'Delbar l√§nk & QR-kod visas.'));
  const w = window.open('','_blank');
  w.document.write(`<title>${title}</title><body style="font-family:system-ui;padding:20px"><h2>${title}</h2><p>${state.company}</p><p><a href="${url}">${url}</a></p><img alt="QR" src="${qr}"><p style="opacity:.7">${txt}</p></body>`);
};

/* ---------- Read-only banner ---------- */
function applyReadonly(){
  if(state.readonly){
    els.roBanner.style.display = '';
    els.roBanner.textContent = I18N[state.lang].readonly;
    document.body.classList.add('readonly');
    els.openFab.style.display='none';
  }else{
    els.roBanner.style.display='none';
  }
}

/* ---------- Boot ---------- */
(function boot(){
  applyI18n();
  applyHeader();
  bindDrawer();

  // default month/year rows
  if(state.rows.length===0) generateDays(); else renderRows();

  // apply selected month/year in UI (after i18n)
  els.month.value = state.month; els.year.value = state.year;

  applyReadonly();
})();
</script>
</body>
</html>
