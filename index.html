<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Th√ºringer Tannenhof ‚Äì Tidsrapport</title>
<style>
  :root{
    --brand:#155E3B;           /* Th√ºringer-gr√∂n */
    --brand-2:#0f3f2a;
    --bg:#eef6f1;
    --row:#f4faf6;
    --today:#e6f3ec;
    --ink:#1c2a22;
    --muted:#6a7a72;
    --card:#ffffff;
    --shadow: 0 6px 18px rgba(0,0,0,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:#edf4ef;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .appbar{
    position:sticky;top:0;z-index:20;
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:#fff;padding:.9rem .9rem .8rem;border-bottom:3px solid #0e3423;
  }
  .appbar .row{display:flex;align-items:center;gap:.75rem;max-width:980px;margin:0 auto}
  .logoBadge{width:36px;height:36px;border-radius:50%;background:#e7efe9;color:var(--brand);display:grid;place-items:center;font-weight:700}
  .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .spacer{flex:1}
  .btn{border:0;border-radius:14px;padding:.55rem .9rem;background:#fff;color:#0d1b14;font-weight:600;box-shadow:var(--shadow);cursor:pointer}
  .btn.dark{background:#0f2f22;color:#fff}
  .container{max-width:980px;margin:18px auto;padding:0 12px}
  .summary{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{background:#eaf3ee;border-radius:12px;padding:8px 12px;font-weight:700}
  .navbtn{width:44px;height:44px;border-radius:12px;border:0;background:#eaf3ee;cursor:pointer;font-weight:700}
  .reset{margin-left:auto}
  .table{
    width:100%;overflow:auto;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:6px 6px 2px;margin-top:14px
  }
  .thead,.trow{display:grid;grid-template-columns:56px 110px 110px 84px 1fr 132px 106px 80px;gap:10px;align-items:center}
  .thead{position:sticky;top:64px;background:var(--card);padding:10px;border-bottom:1px solid #e3ebe6;z-index:10}
  .thead b{display:flex;align-items:center;gap:6px}
  .trow{padding:8px 10px;background:var(--row);border-radius:14px;margin:10px 6px}
  .trow.today{background:var(--today);outline:2px solid rgba(21,94,59,.25)}
  .cell-day{font-weight:800;text-align:center;color:var(--brand)}
  input[type=time],input[type=text],input[type=number]{
    width:100%;height:42px;border:1px solid #d9e6df;background:#fff;border-radius:12px;padding:0 10px;font-weight:600;color:#102018
  }
  input[type=time]{padding:0 6px}
  input[type=number]{-moz-appearance:textfield}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none;margin:0}
  .pill{height:42px;border-radius:999px;border:1px solid #d9e6df;background:#f4f9f6;padding:0 12px;display:flex;align-items:center;gap:8px;overflow:hidden}
  .noteBtn,.photoBtn{height:42px;border-radius:12px;border:0;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  .noteBtn{background:#e9f1ed;color:#103020;border:1px solid #dbe8e1}
  .sum{text-align:right;font-weight:800}
  .fab{position:fixed;left:16px;bottom:16px;width:62px;height:62px;border-radius:16px;background:var(--brand);display:grid;place-items:center;box-shadow:var(--shadow);z-index:25;cursor:pointer}
  .gear{width:26px;height:26px;filter:invert(96%) sepia(0%) saturate(0%) hue-rotate(185deg) brightness(106%) contrast(100%)}
  .sheet{
    position:fixed;left:12px;bottom:92px;max-width:320px;background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:12px;display:none;z-index:30
  }
  .sheet h4{margin:.25rem 0 .5rem}
  .sheet .row{display:flex;gap:8px;align-items:center;margin:.35rem 0}
  .range{width:100%}
  .watermark{
    position:fixed;right:16px;bottom:16px;opacity:.25;pointer-events:none;z-index:0;max-width:min(40vw,260px)
  }
  .debug{position:fixed;left:12px;right:12px;bottom:8px;background:#0f2f22;color:#cfe5da;
    border-radius:14px;padding:8px 10px;font-family:ui-monospace,Consolas,monospace;font-size:12px;display:none;z-index:26}
  .debug pre{margin:0;max-height:26vh;overflow:auto;white-space:pre-wrap}
  .signModal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .signCard{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:12px;width:min(96vw,640px)}
  .signHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  canvas{background:#fff;border:1px dashed #cfe1d7;border-radius:12px;touch-action:none}
  .row-actions{display:flex;gap:8px}
  .muted{color:var(--muted)}
  @media (max-width:720px){
    .thead,.trow{grid-template-columns:48px 92px 92px 70px 1fr 108px 92px 66px}
  }
  /* extra botten-marginal s√• FAB inte t√§cker sista rad */
  .bottomPad{height:120px}
</style>
</head>
<body>
  <div class="appbar">
    <div class="row">
      <div class="logoBadge">TN</div>
      <div class="title">Th√ºringer Tannenhof ‚Äì Tidsrapport</div>
      <div class="spacer"></div>
      <button class="btn" id="shareBtn">Dela / Skicka</button>
      <button class="btn dark" id="pdfBtn">PDF</button>
    </div>
  </div>

  <div class="container">
    <div class="summary">
      <div class="chip" id="totalChip">‚è≥ Totalt ‚Äì <b id="totalHours">0.00</b></div>
      <div class="chip">M√•nad: <b id="monthLabel">‚Äî</b></div>
      <button class="navbtn" id="prevM">¬´</button>
      <button class="navbtn" id="nextM">¬ª</button>
      <button class="btn reset" id="clearMonth">Rensa denna m√•nad</button>
    </div>

    <div class="table" id="table">
      <div class="thead">
        <b>Dag</b>
        <b>Fr√•n</b>
        <b>Till</b>
        <b>Paus</b>
        <b>Projekt/plats</b>
        <b>Anteckning</b>
        <b>Foto</b>
        <b class="sum">Sum</b>
      </div>
      <div id="rows"></div>
    </div>

    <div class="row row-actions" style="margin:14px 6px 0">
      <button class="btn" id="signStaffOpen">‚úçÔ∏è Signera Medarbetare</button>
      <button class="btn" id="signBossOpen">‚úçÔ∏è Signera Chef</button>
    </div>
    <div class="bottomPad"></div>
  </div>

  <!-- Vattenst√§mpel -->
  <img id="wm" class="watermark" alt="watermark" />

  <!-- FAB -->
  <button class="fab" id="fab" aria-label="Inst√§llningar">
    <svg class="gear" viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5a3.5 3.5 0 1 1 0-7a3.5 3.5 0 0 1 0 7m8.94-2.88l-1.7-.98c.07-.5.07-1.02 0-1.52l1.7-.98a.5.5 0 0 0 .2-.68l-1.8-3.12a.5.5 0 0 0-.64-.2l-1.7.98a7.1 7.1 0 0 0-1.32-.76V2.5a.5.5 0 0 0-.5-.5h-3.6a.5.5 0 0 0-.5.5v1.96c-.46.18-.9.43-1.31.73l-1.7-.98a.5.5 0 0 0-.68.2L2.86 8.23a.5.5 0 0 0 .2.68l1.7.98a7.3 7.3 0 0 0 0 1.52l-1.7.98a.5.5 0 0 0-.2.68l1.8 3.12c.14.23.44.31.68.2l1.7-.98c.4.3.86.56 1.32.76v1.96c0 .28.22.5.5.5h3.6c.28 0 .5-.22.5-.5v-1.96c.46-.18.9-.43 1.32-.73l1.7.98c.24.12.54.03.68-.2l1.8-3.12a.5.5 0 0 0-.2-.68Z"/></svg>
  </button>

  <!-- Inst√§llningspanel -->
  <div class="sheet" id="sheet">
    <div class="row">
      <label class="btn" style="width:100%">
        V√§lj logga (PNG/JPG)
        <input id="logoPick" type="file" accept="image/*" hidden>
      </label>
    </div>
    <div class="row">
      <label style="font-weight:700">Vattenst√§mpel</label>
      <label style="margin-left:auto;display:flex;gap:6px;align-items:center">
        Synlig <input id="wmToggle" type="checkbox" checked>
      </label>
    </div>
    <div class="row">
      <span class="muted">Genomskinlighet</span>
      <input class="range" id="wmAlpha" type="range" min="10" max="90" value="30">
    </div>
    <hr style="border:0;border-top:1px solid #e5eee8;margin:8px 0">
    <button class="btn" id="toggleDebug">Visa/D√∂lj fels√∂kning</button>
    <button class="btn" id="wipeAll" style="background:#ffe9e9">Rensa ALLT (alla m√•nader)</button>
  </div>

  <!-- Fels√∂kning -->
  <div class="debug" id="debug"><pre id="log"></pre></div>

  <!-- Signeringsmodals -->
  <div class="signModal" id="signStaff">
    <div class="signCard">
      <div class="signHead">
        <b>Signatur ‚Äì Medarbetare</b>
        <div class="row-actions">
          <button class="btn" id="signStaffClear">Rensa</button>
          <button class="btn dark" id="signStaffClose">Klar</button>
        </div>
      </div>
      <canvas id="canvasStaff" width="900" height="260"></canvas>
    </div>
  </div>

  <div class="signModal" id="signBoss">
    <div class="signCard">
      <div class="signHead">
        <b>Signatur ‚Äì Chef</b>
        <div class="row-actions">
          <button class="btn" id="signBossClear">Rensa</button>
          <button class="btn dark" id="signBossClose">Klar</button>
        </div>
      </div>
      <canvas id="canvasBoss" width="900" height="260"></canvas>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const rowsEl = $("#rows");
const monthLabel = $("#monthLabel");
const totalHoursEl = $("#totalHours");
const logEl = $("#log");
const debug = $("#debug");
const wmImg = $("#wm");

const BRAND = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim();

// ‚Äî‚Äî‚Äî‚Äî‚Äî storage helpers
const KEY = m => `tnh:${m}`;     // per-month
const store = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load  = (k,def)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(def));

let viewDate = new Date();  // controls month being shown

function yyyymm(date){
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
}

function daysInMonth(d){
  return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
}

function fmtMonthLabel(d){
  return d.toLocaleDateString('sv-SE',{year:'numeric',month:'long'});
}

// create rows
function build(){
  rowsEl.innerHTML = '';
  const ym = yyyymm(viewDate);
  monthLabel.textContent = fmtMonthLabel(viewDate);

  // data structure: { d:[ {from:"08:00",to:"16:30",pause:0,place:"",note:"",photos:[],sum:0} ...] }
  const totalDays = daysInMonth(viewDate);
  let data = load(KEY(ym), Array.from({length:totalDays},()=>({from:'',to:'',pause:0,place:'',note:'',photos:[],sum:0})));
  // ensure correct length (month change)
  if (data.length !== totalDays){ data = Array.from({length:totalDays},(_,i)=>data[i]||{from:'',to:'',pause:0,place:'',note:'',photos:[],sum:0}); store(KEY(ym),data); }

  const today = new Date();
  const isSameMonth = today.getFullYear()===viewDate.getFullYear() && today.getMonth()===viewDate.getMonth();
  let total = 0;

  for(let i=1;i<=totalDays;i++){
    const row = document.createElement('div');
    row.className = 'trow';
    if(isSameMonth && i===today.getDate()) row.classList.add('today');

    const model = data[i-1];

    row.innerHTML = `
      <div class="cell-day">${i}</div>
      <div><input type="time" value="${model.from||''}" data-k="from"></div>
      <div><input type="time" value="${model.to||''}" data-k="to"></div>
      <div><input type="number" min="0" step="1" value="${model.pause??0}" data-k="pause"></div>
      <div class="pill"><span style="filter:grayscale(1)">üìç</span><input type="text" placeholder="Projekt/plats" value="${escapeHtml(model.place||'')}" data-k="place" style="border:0;background:transparent;width:100%;outline:none;font-weight:600"></div>
      <button class="noteBtn" data-action="note">üìù Anteckning</button>
      <button class="photoBtn" data-action="photo">üì∑ Foto</button>
      <div class="sum"><span data-sum>${model.sum?.toFixed?.(2)||'0.00'}</span></div>
    `;

    // wire inputs
    row.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('change',()=>{
        const k = inp.dataset.k;
        data[i-1][k] = (k==='pause') ? Number(inp.value||0) : inp.value;
        recalc(i-1);
      });
    });

    // note
    row.querySelector('[data-action=note]').addEventListener('click',()=>{
      const txt = prompt('Anteckning', data[i-1].note||'') ?? data[i-1].note;
      if(txt!==undefined){ data[i-1].note = txt; toast(`Rad ${i}: anteckning sparad.`); persist(); }
    });

    // photo
    row.querySelector('[data-action=photo]').addEventListener('click',()=>{
      const pick = document.createElement('input');
      pick.type='file'; pick.accept='image/*'; pick.multiple=false; pick.capture='environment';
      pick.onchange = e=>{
        if(pick.files && pick.files[0]){
          const reader = new FileReader();
          reader.onload = ()=>{ data[i-1].photos=[reader.result]; toast(`Rad ${i}: foto bifogat.`); persist(); };
          reader.readAsDataURL(pick.files[0]);
        }
      };
      pick.click();
    });

    function recalc(idx){
      const m = data[idx];
      let dur = 0;
      if(m.from && m.to){
        const [fh,fm]=m.from.split(':').map(Number);
        const [th,tm]=m.to.split(':').map(Number);
        const start = fh*60+fm, end = th*60+tm;
        dur = Math.max(0, end-start - (Number(m.pause)||0));
      }
      m.sum = dur/60;
      row.querySelector('[data-sum]').textContent = m.sum.toFixed(2);
      persist();
    }

    rowsEl.appendChild(row);
    total += Number(model.sum||0);
  }

  totalHoursEl.textContent = total.toFixed(2);
}

// persist & log
function persist(){
  const ym = yyyymm(viewDate);
  const rows = Array.from(rowsEl.children).map((row,idx)=>{
    const getVal = sel => row.querySelector(sel)?.value || '';
    return {
      from: row.querySelector('input[data-k=from]').value,
      to: row.querySelector('input[data-k=to]').value,
      pause: Number(row.querySelector('input[data-k=pause]').value||0),
      place: row.querySelector('input[data-k=place]').value,
      note: load(KEY(ym),[])[idx]?.note||'',   // keep note unless changed via prompt
      photos: load(KEY(ym),[])[idx]?.photos||[],
      sum: Number(row.querySelector('[data-sum]').textContent||0)
    }
  });
  store(KEY(ym), rows);
  // update total
  const total = rows.reduce((a,b)=>a+Number(b.sum||0),0);
  totalHoursEl.textContent = total.toFixed(2);
  log(`[${new Date().toLocaleTimeString()}] Sparade ${rows.length} rader f√∂r ${ym}.`);
}
function log(s){ logEl.textContent = `${s}\n` + logEl.textContent; }

// month nav
$("#prevM").onclick = ()=>{ viewDate.setMonth(viewDate.getMonth()-1); build(); log('Bytte m√•nad -'); };
$("#nextM").onclick = ()=>{ viewDate.setMonth(viewDate.getMonth()+1); build(); log('Bytte m√•nad +'); };
$("#clearMonth").onclick = ()=>{
  if(confirm('Rensa denna m√•nad?')){ localStorage.removeItem(KEY(yyyymm(viewDate))); build(); log('Rensade m√•nad.'); }
};

// share/pdf stubs
$("#shareBtn").onclick = ()=> alert('Dela/Skicka kommer senare (PDF kan delas).');
$("#pdfBtn").onclick = ()=> alert('PDF-generering √§r inte aktiv i denna fil.');

// FAB sheet
const sheet = $("#sheet");
$("#fab").onclick = ()=> sheet.style.display = sheet.style.display==='block'?'none':'block';
$("#toggleDebug").onclick = ()=> debug.style.display = debug.style.display==='block'?'none':'block';
$("#wipeAll").onclick = ()=>{ if(confirm('Rensa ALLT?')){ Object.keys(localStorage).filter(k=>k.startsWith('tnh:')).forEach(k=>localStorage.removeItem(k)); build(); log('ALLT rensat.'); }};

// watermark controls
$("#logoPick").onchange = e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload = ()=>{ wmImg.src = r.result; log('Vattenst√§mpel inl√§st.'); }; r.readAsDataURL(f);
};
$("#wmToggle").onchange = e=> wmImg.style.display = e.target.checked?'block':'none';
$("#wmAlpha").oninput = e=> wmImg.style.opacity = (Number(e.target.value)/100).toString();

// signature modals
function signModalHook(btnOpenId, modalId, btnClearId, btnCloseId, canvasId){
  const open = $(btnOpenId), modal=$(modalId), clear=$(btnClearId), close=$(btnCloseId), cvs=$(canvasId), ctx=cvs.getContext('2d');
  let drawing=false, last=null;
  const fit = ()=>{ const scale = Math.min((window.innerWidth*0.9)/cvs.width, 1); cvs.style.transform=`scale(${scale})`; cvs.style.transformOrigin='top left'; };
  fit(); addEventListener('resize',fit);
  const pt = e=>{
    const rect=cvs.getBoundingClientRect();
    const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
    const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
    return {x,y};
  };
  function start(e){ drawing=true; last=pt(e); e.preventDefault(); }
  function move(e){
    if(!drawing) return;
    const p=pt(e); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=BRAND; ctx.lineWidth=3.2;
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault();
  }
  function end(){ drawing=false; }
  cvs.addEventListener('mousedown',start); cvs.addEventListener('mousemove',move); addEventListener('mouseup',end);
  cvs.addEventListener('touchstart',start,{passive:false}); cvs.addEventListener('touchmove',move,{passive:false}); cvs.addEventListener('touchend',end);

  open.onclick = ()=> modal.style.display='flex';
  clear.onclick = ()=> ctx.clearRect(0,0,cvs.width,cvs.height);
  close.onclick = ()=> modal.style.display='none';
}
signModalHook("#signStaffOpen","#signStaff","#signStaffClear","#signStaffClose","#canvasStaff");
signModalHook("#signBossOpen","#signBoss","#signBossClear","#signBossClose","#canvasBoss");

// util
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));}

// init
(function init(){
  // default faint watermark text, can be replaced via logga
  wmImg.alt='watermark';
  wmImg.style.opacity=.3;
  build();
  log('App start OK. M√•nad: '+yyyymm(viewDate));
})();
</script>
</body>
</html>
