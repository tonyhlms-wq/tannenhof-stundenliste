<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tannenhofs tidtabell</title>
<link rel="icon" href="favicon.ico">
<style>
:root{
  --bg:#f3f7f4;--card:#ffffff;--ink:#17321d;--ink2:#2d4735;
  --brand:#1f6b39;--brand2:#124928;--ok:#0b8f4d;--muted:#7a9486;
  --gold:#d4af37;--row:#eef5f0;--row2:#e6f0ea;--pill:#f6fbf8;
  --shadow:0 6px 20px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:500 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}
header{
  position:sticky;top:0;z-index:30;background:linear-gradient(180deg,var(--brand),var(--brand2));
  color:#fff;box-shadow:var(--shadow)
}
.header-inner{display:flex;align-items:center;gap:14px;padding:12px 14px}
.logo{
  width:36px;height:36px;border-radius:9px;overflow:hidden;background:#fff;display:grid;place-items:center;
  box-shadow:0 2px 8px rgba(0,0,0,.25)
}
.logo img{max-width:100%;max-height:100%}
.hbrand{font-weight:800;letter-spacing:.2px}
.hsub{font-size:13px;opacity:.9}
.h-actions{margin-left:auto;display:flex;gap:10px}
.btn{
  background:#fff;color:var(--ink2);border:0;border-radius:14px;padding:12px 16px;font-weight:700;
  box-shadow:var(--shadow);display:flex;align-items:center;gap:8px
}
.btn.dark{background:#0a0a0a;color:#fff}
.wrap{max-width:920px;margin:18px auto;padding:0 14px}
.sum{
  background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:14px 16px;margin:6px 0 16px;
  display:flex;align-items:center;justify-content:space-between
}
.table{
  background:var(--card);border-radius:18px;box-shadow:var(--shadow);overflow:auto;padding-bottom:10px
}
.row{display:grid;grid-template-columns:72px 1fr 1fr 120px 86px 120px;
  gap:12px;align-items:center;padding:12px 14px;border-bottom:1px solid #e7efe9;position:relative}
.row:nth-child(odd){background:var(--row)}
.row:nth-child(even){background:var(--row2)}
.head{position:sticky;top:0;z-index:5;background:#e9f4ee;border-bottom:2px solid #e0ece6;font-weight:800}
.cell{display:flex;align-items:center;gap:10px}
.pill{background:var(--pill);border:1px solid #dbe9e2;border-radius:14px;padding:10px 12px;display:flex;align-items:center;gap:10px}
.pill select,.pill input{border:0;background:transparent;outline:none;font:inherit;color:var(--ink2);min-width:0}
.pill input[type="text"]{width:100%}
.right{justify-content:flex-end}
.badge{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #dbe9e2}
.kit{display:flex;gap:10px}
.iconbtn{
  width:52px;height:52px;border-radius:14px;border:0;display:grid;place-items:center;background:#1f6b39;
  color:#fff;box-shadow:var(--shadow);cursor:pointer
}
.iconbtn.gray{background:#456a55}
.iconbtn img{width:26px;height:26px;opacity:.95}
.note-total{font-weight:800;opacity:.9}
.todayStripe{
  position:absolute;left:0;top:0;bottom:0;width:6px;background:#2c7a46;border-radius:0 6px 6px 0
}
.goldStripe{
  position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#fadd72,#d4af37);
  border-radius:4px 4px 0 0
}
.watermark{
  position:fixed;right:12px;bottom:50px;z-index:0;pointer-events:none;opacity:.70; /* 70% as requested */
  filter:grayscale(.2);
}
.watermark img{width:260px;max-width:40vw;opacity:inherit}
.fab{
  position:fixed;left:16px;bottom:16px;z-index:25;background:#235f3a;color:#fff;border:0;border-radius:16px;
  width:64px;height:64px;display:grid;place-items:center;box-shadow:var(--shadow)
}
body{padding-bottom:140px} /* s√• sista raden aldrig t√§cks av knappen */

/* MODALS */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:50}
.modal.open{display:grid;place-items:center}
.sheet{background:#fff;border-radius:20px;box-shadow:var(--shadow);max-width:720px;width:min(92vw,720px);padding:16px}
.sheet h3{margin:0 0 8px}
.sheet .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sbtn{border:1px solid #dbe9e2;border-radius:14px;padding:12px 14px;font-weight:700;background:#f7fbf8}
.sbtn.primary{background:#1f6b39;color:#fff;border-color:#1f6b39}
.close{float:right;border:0;background:#eee;border-radius:10px;padding:6px 10px}

/* small screens tweaks */
@media (max-width:560px){
  .row{grid-template-columns:64px 1fr 1fr 110px 84px 96px}
  .iconbtn{width:48px;height:48px}
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo"><img id="logoImg" alt="logo"></div>
    <div>
      <div class="hbrand" id="brandTitle">Tannenhofs tidtabell</div>
      <div class="hsub" id="monthLabel">oktober 2025</div>
    </div>
    <div class="h-actions">
      <button class="btn" id="shareBtn">üç∞ <span data-i18n="share">Dela / Skicka</span></button>
      <button class="btn dark" id="pdfBtn">üñ®Ô∏è <span data-i18n="print">Skriv ut / PDF</span></button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="sum">
    <div>‚è≥ <b id="totalLabel" data-i18n="total">Totalt ‚Äì oktober 2025</b></div>
    <div class="note-total" id="grandTotal">0.00</div>
  </div>

  <div class="table" id="table">
    <div class="row head">
      <div class="cell" data-i18n="day">Dag</div>
      <div class="cell" data-i18n="from">Fr√•n</div>
      <div class="cell" data-i18n="to">Till</div>
      <div class="cell" data-i18n="break">Paus</div>
      <div class="cell" data-i18n="sum">Totalt</div>
      <div class="cell" data-i18n="proj">Projekt/Plats</div>
    </div>
    <!-- rows will be injected -->
  </div>
</div>

<!-- watermark -->
<div class="watermark" id="wm" aria-hidden="true">
  <img src="tnh-tree-512.png" alt="Th√ºringer Tannenhof">
</div>

<!-- floating settings -->
<button class="fab" id="gear" title="Inst√§llningar">‚öôÔ∏è</button>

<!-- SETTINGS MODAL -->
<div class="modal" id="settings">
  <div class="sheet">
    <button class="close" data-close>St√§ng</button>
    <h3>Inst√§llningar</h3>
    <div class="grid">
      <div>
        <label>F√∂retagsnamn</label>
        <input id="company" class="pill" type="text" placeholder="TH√úRINGER TANNENHOF">
      </div>
      <div>
        <label>Spr√•k</label>
        <select id="lang" class="pill">
          <option value="sv">Svenska</option>
          <option value="de">Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>Vattenst√§mpel</label>
        <select id="wmToggle" class="pill">
          <option value="on">P√• (70%)</option>
          <option value="off">Av</option>
        </select>
      </div>
      <div>
        <label>Byt logga</label>
        <input id="logoPicker" class="pill" type="file" accept="image/*">
      </div>
    </div>
  </div>
</div>

<!-- CAMERA / GALLERY CHOOSER -->
<input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none">
<input id="galleryInput" type="file" accept="image/*" style="display:none">
<div class="modal" id="camChooser">
  <div class="sheet">
    <button class="close" data-close>St√§ng</button>
    <h3 data-i18n="addphoto">L√§gg till foto</h3>
    <div class="grid">
      <button class="sbtn primary" id="camBtn">üì∑ <span data-i18n="camera">Kamera</span></button>
      <button class="sbtn" id="galBtn">üñºÔ∏è <span data-i18n="gallery">Galleri</span></button>
    </div>
  </div>
</div>

<!-- SHARE / QR -->
<div class="modal" id="shareModal">
  <div class="sheet">
    <button class="close" data-close>St√§ng</button>
    <h3 data-i18n="share">Dela / Skicka</h3>
    <div class="grid">
      <button class="sbtn primary" id="shareNative">üîó Web Share</button>
      <button class="sbtn" id="qrBtn">üßæ QR-kod</button>
    </div>
    <div id="qrBox" style="margin-top:12px;display:none;text-align:center"></div>
  </div>
</div>

<script>
/* ========= I18N ========= */
const I18N={
  sv:{share:"Dela / Skicka",print:"Skriv ut / PDF",total:"Totalt ‚Äì ",day:"Dag",from:"Fr√•n",to:"Till",break:"Paus",sum:"Totalt",proj:"Projekt/plats",addphoto:"L√§gg till foto",camera:"Kamera",gallery:"Galleri",monthFmt:(d)=>d.toLocaleString('sv-SE',{month:'long',year:'numeric'})},
  de:{share:"Teilen / Senden",print:"Drucken / PDF",total:"Gesamt ‚Äì ",day:"Tag",from:"Von",to:"Bis",break:"Pause",sum:"Gesamt",proj:"Projekt/Ort",addphoto:"Foto hinzuf√ºgen",camera:"Kamera",gallery:"Galerie",monthFmt:(d)=>d.toLocaleString('de-DE',{month:'long',year:'numeric'})},
  en:{share:"Share / Send",print:"Print / PDF",total:"Total ‚Äì ",day:"Day",from:"From",to:"To",break:"Break",sum:"Total",proj:"Project/site",addphoto:"Add photo",camera:"Camera",gallery:"Gallery",monthFmt:(d)=>d.toLocaleString('en-GB',{month:'long',year:'numeric'})}
};
let LANG=localStorage.getItem('tnh_lang')||'sv';
function tr(){const t=I18N[LANG];document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');el.textContent=t[k]});}

/* ========= STATE ========= */
const today=new Date(); const YEAR=today.getFullYear(); const MONTH=today.getMonth(); // current
let monthDate=new Date(YEAR, MONTH, 1);
const rowsEl=document.getElementById('table');
const brandTitle=document.getElementById('brandTitle');
const monthLabel=document.getElementById('monthLabel');
const totalLabel=document.getElementById('totalLabel');
const grandTotal=document.getElementById('grandTotal');
const wm=document.getElementById('wm');

/* ========= BUILD UI ========= */
function setHeaderTexts(){
  const t=I18N[LANG];
  brandTitle.textContent="Tannenhofs tidtabell";
  const m=t.monthFmt(monthDate);
  monthLabel.textContent=m.charAt(0).toUpperCase()+m.slice(1);
  totalLabel.textContent=t.total + monthLabel.textContent;
}
function timeOptions(){
  let opts=['<option value=""></option>'];
  for(let h=0;h<24;h++){ for(let m=0;m<60;m+=5){
    const v=(h+'').padStart(2,'0')+':'+(m+'').padStart(2,'0');
    opts.push(`<option value="${v}">${v}</option>`);
  }}
  return opts.join('');
}
const timeOpts=timeOptions();

function rowTemplate(day){
  const id='d'+day;
  return `
    <div class="row" id="${id}" data-day="${day}">
      <div class="cell">
        <div class="badge">üìÖ</div><b>${day}</b>
        <div class="todayStripe" hidden></div>
        <div class="goldStripe" hidden></div>
      </div>
      <div class="cell"><div class="pill"><select class="from">${timeOpts}</select></div></div>
      <div class="cell"><div class="pill"><select class="to">${timeOpts}</select></div></div>
      <div class="cell"><div class="pill"><select class="break">
        <option value=""></option>
        <option>00:00</option><option>00:10</option><option>00:15</option>
        <option>00:30</option><option>00:45</option><option>01:00</option>
      </select></div></div>
      <div class="cell right"><div class="note-total" data-sum>0.00</div></div>
      <div class="cell">
        <div class="pill" style="min-width:150px"><input type="text" class="project" placeholder="${I18N[LANG].proj}"></div>
        <div class="kit">
          <button class="iconbtn gray noteBtn" title="Notis">üìù</button>
          <button class="iconbtn camBtn" title="Kamera/Galleri">üì∑</button>
        </div>
      </div>
      <div class="pics" style="grid-column: 2 / -1; display:flex; gap:8px; flex-wrap:wrap; padding:0 0 8px 0"></div>
    </div>`;
}

function buildMonth(){
  // clear old rows except header
  document.querySelectorAll('.row:not(.head)').forEach(e=>e.remove());
  const days=new Date(monthDate.getFullYear(),monthDate.getMonth()+1,0).getDate();
  for(let d=1; d<=days; d++){
    rowsEl.insertAdjacentHTML('beforeend', rowTemplate(d));
  }
  applyTodayHighlight();
  attachRowHandlers();
  restoreState();
  calcTotal();
}

/* ========= TODAY HIGHLIGHT ========= */
function applyTodayHighlight(){
  const d=new Date();
  if(d.getMonth()===monthDate.getMonth() && d.getFullYear()===monthDate.getFullYear()){
    const row=document.getElementById('d'+d.getDate());
    if(row){
      row.querySelector('.todayStripe').hidden=false;
      row.querySelector('.goldStripe').hidden=false;
      // auto-scroll into view centered
      row.scrollIntoView({block:'center'});
    }
  }
}

/* ========= EVENTS / STATE ========= */
function attachRowHandlers(){
  document.querySelectorAll('.row').forEach(row=>{
    const from=row.querySelector('.from');
    const to=row.querySelector('.to');
    const br=row.querySelector('.break');
    [from,to,br].forEach(sel=>sel.addEventListener('change',()=>{saveRow(row);calcRow(row);calcTotal();}));
    row.querySelector('.project').addEventListener('input',()=>saveRow(row));
    row.querySelector('.noteBtn').addEventListener('click',()=> {
      const t=prompt('Anteckning / Notiz / Note:', localGet('note_'+row.id) || '');
      if(t!==null){ localSet('note_'+row.id,t); }
    });
    // camera -> chooser
    row.querySelector('.camBtn').addEventListener('click',()=>{
      openChooser(row.id);
    });
  });
}

function parseHM(v){if(!v) return 0; const [h,m]=v.split(':').map(Number); return h*60+m;}
function toHHMM(min){const h=Math.floor(min/60), m=min%60; return (h+'.' + (m/60).toFixed(2).split('.')[1]);}
function calcRow(row){
  const f=parseHM(row.querySelector('.from').value);
  const t=parseHM(row.querySelector('.to').value);
  const b=parseHM(row.querySelector('.break').value);
  let mins=Math.max(0, t - f - b);
  row.querySelector('[data-sum]').textContent = (mins/60).toFixed(2);
}
function calcTotal(){
  let sum=0;
  document.querySelectorAll('[data-sum]').forEach(e=> sum += parseFloat(e.textContent||'0'));
  grandTotal.textContent=sum.toFixed(2);
}

/* localStorage helpers keyed per month */
const KEY=(monthDate.getFullYear())+'-'+(monthDate.getMonth()+1);
function localSet(k,v){localStorage.setItem('tnh_'+KEY+'_'+k, typeof v==='string'?v:JSON.stringify(v));}
function localGet(k){const v=localStorage.getItem('tnh_'+KEY+'_'+k); if(!v) return null; try{return JSON.parse(v)}catch{return v}}
function saveRow(row){
  const id=row.id;
  localSet(id,{
    from:row.querySelector('.from').value,
    to:row.querySelector('.to').value,
    br:row.querySelector('.break').value,
    proj:row.querySelector('.project').value
  });
}
function restoreState(){
  // logo
  const l=localStorage.getItem('tnh_logo'); if(l) document.getElementById('logoImg').src=l; else document.getElementById('logoImg').src='tnh-tree-192.png';
  // rows
  document.querySelectorAll('.row').forEach(row=>{
    const st=localGet(row.id);
    if(st){
      row.querySelector('.from').value=st.from||'';
      row.querySelector('.to').value=st.to||'';
      row.querySelector('.break').value=st.br||'';
      row.querySelector('.project').value=st.proj||'';
      calcRow(row);
    }
    // load pictures
    const pics=localGet('pics_'+row.id) || [];
    const box=row.querySelector('.pics'); box.innerHTML='';
    pics.forEach((b64,i)=>{
      const img=document.createElement('img');
      img.src=b64; img.style.width='54px'; img.style.height='54px'; img.style.objectFit='cover'; img.style.borderRadius='10px'; img.style.boxShadow='var(--shadow)';
      img.addEventListener('click',()=>window.open(b64,'_blank'));
      img.title='Tryck f√∂r att √∂ppna. H√•ll f√∂r att ta bort.';
      img.addEventListener('contextmenu',e=>{e.preventDefault(); if(confirm('Ta bort bilden?')){pics.splice(i,1);localSet('pics_'+row.id,pics);restoreState();}});
      box.appendChild(img);
    });
  });
}

/* ========= SETTINGS ========= */
const gear=document.getElementById('gear');
const settings=document.getElementById('settings');
gear.onclick=()=>settings.classList.add('open');
settings.addEventListener('click',e=>{ if(e.target.matches('[data-close], .modal')) settings.classList.remove('open'); });

document.getElementById('lang').value=LANG;
document.getElementById('lang').onchange=(e)=>{LANG=e.target.value; localStorage.setItem('tnh_lang',LANG); tr(); setHeaderTexts(); buildMonth();}
document.getElementById('wmToggle').value=localStorage.getItem('tnh_wm')||'on';
document.getElementById('wmToggle').onchange=(e)=>{localStorage.setItem('tnh_wm',e.target.value); wm.style.display=(e.target.value==='off')?'none':'block';};
wm.style.display=((localStorage.getItem('tnh_wm')||'on')==='off')?'none':'block';
document.getElementById('company').value=localStorage.getItem('tnh_company')||'TH√úRINGER TANNENHOF';
document.getElementById('company').oninput=(e)=>{localStorage.setItem('tnh_company',e.target.value);};
document.getElementById('logoPicker').onchange=async(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const b64=await fileToDataURL(file); localStorage.setItem('tnh_logo',b64); document.getElementById('logoImg').src=b64;
};

/* ========= CAMERA / GALLERY ========= */
let activeRowId=null;
const chooser=document.getElementById('camChooser');
function openChooser(rowId){activeRowId=rowId; chooser.classList.add('open');}
chooser.addEventListener('click',e=>{ if(e.target.matches('[data-close], .modal')) chooser.classList.remove('open'); });
document.getElementById('camBtn').onclick=()=>{chooser.classList.remove('open'); document.getElementById('cameraInput').click();}
document.getElementById('galBtn').onclick=()=>{chooser.classList.remove('open'); document.getElementById('galleryInput').click();}
document.getElementById('cameraInput').onchange=(e)=>handlePicked(e);
document.getElementById('galleryInput').onchange=(e)=>handlePicked(e);
async function handlePicked(e){
  const f=e.target.files[0]; if(!f||!activeRowId) return;
  const b64=await fileToDataURL(f);
  const key='pics_'+activeRowId; const arr=localGet(key)||[]; arr.push(b64); localSet(key,arr); restoreState();
}
function fileToDataURL(file){return new Promise(res=>{const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file);});}

/* ========= SHARE / PDF / QR ========= */
document.getElementById('shareBtn').onclick=()=>document.getElementById('shareModal').classList.add('open');
document.getElementById('shareModal').addEventListener('click',e=>{ if(e.target.matches('[data-close], .modal')) e.currentTarget.classList.remove('open'); });
document.getElementById('shareNative').onclick=async()=>{
  const text=brandTitle.textContent+' ‚Äì '+monthLabel.textContent+' ('+grandTotal.textContent+' h)';
  const url=location.href;
  if(navigator.share){await navigator.share({title:document.title,text,url});}
  else{prompt('Kopiera l√§nk:', url);}
};
document.getElementById('qrBtn').onclick=()=>{
  const box=document.getElementById('qrBox'); box.style.display='block';
  box.innerHTML=''; // simple QR via canvas ‚Äì lightweight
  const c=document.createElement('canvas'); c.width=c.height=220; box.appendChild(c);
  // tiny QR algorithm replacement (fallback): draw URL text if QR lib not present
  const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,220,220);
  ctx.fillStyle='#000'; ctx.font='16px monospace'; wrapText(ctx, location.href, 10, 30, 200, 18);
  function wrapText(ctx,text,x,y,maxWidth,lineHeight){const words=text.split(' ');let line='';for(let n=0;n<words.length;n++){const test=line+words[n]+' ';const w=ctx.measureText(test).width;if(w>maxWidth&&n>0){ctx.fillText(line,x,y);line=words[n]+' ';y+=lineHeight;}else{line=test}}ctx.fillText(line,x,y)}
};
document.getElementById('pdfBtn').onclick=()=>window.print();

/* ========= INIT ========= */
function init(){
  tr(); setHeaderTexts(); buildMonth();
}
init();

/* change i18n placeholders live when language switches */
const langObserver=new MutationObserver(()=>document.querySelectorAll('.project').forEach(i=>i.placeholder=I18N[LANG].proj));
langObserver.observe(document.body,{childList:true,subtree:true});

</script>
</body>
</html>
