<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tannenhofs tidtabell</title>
<style>
  :root{
    --green:#2f6f3a;
    --green-2:#3d8f4a;
    --bg:#f4f8f4;
    --ink:#1f3322;
    --muted:#6b7d6f;
    --row:#ffffff;
    --row-alt:#f1f6f1;
    --row-today:#eaf6e9;
    --focus:#2f6f3a33;
    --accent:#e9f2ea;
    --pill:#1c4f2a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{
    position:sticky;top:0;z-index:10;
    background:var(--green);color:#fff;
    padding:10px 12px;display:flex;align-items:center;gap:12px
  }
  header img.logo{
    width:40px;height:40px;object-fit:contain;background:#fff;border-radius:8px;flex:0 0 auto
  }
  header .title{font-weight:700;font-size:18px;line-height:1.1}
  header .title small{display:block;font-weight:500;opacity:.85}
  header .actions{margin-left:auto;display:flex;gap:10px}
  .btn{
    background:#fff;color:var(--green);border:none;border-radius:10px;
    padding:10px 14px;font-weight:700
  }

  main{max-width:980px;margin:16px auto;padding:0 12px}
  .panel{
    background:#fff;border:1px solid #e3e9e3;border-radius:14px;padding:14px;margin-bottom:14px
  }
  .row{display:grid;grid-template-columns:56px 1fr 1fr 1fr 90px 56px;gap:10px;
       align-items:center;background:var(--row);padding:12px;border-bottom:1px solid #e8eee9}
  .row:nth-child(even){background:var(--row-alt)}
  .row.today{background:var(--row-today);box-shadow:inset 0 0 0 3px #2f6f3a22}
  .row .daycell{font-weight:700}
  .row input, .row select{
    width:100%;height:44px;border:1px solid #cfd8cf;border-radius:10px;
    padding:0 12px;background:#fff;font-size:16px
  }
  .row input:focus, .row select:focus{outline:none;box-shadow:0 0 0 3px var(--focus)}
  .row .tot{font-weight:800;text-align:right;padding-right:6px}

  .sticky-month{
    position:sticky;top:58px;z-index:5;background:var(--bg);
    color:var(--muted);padding:8px 12px;font-weight:800;border-bottom:1px solid #e2e9e2
  }

  /* flytande inst√§llningar */
  .fab{
    position:fixed;right:16px;bottom:16px;background:var(--green);color:#fff;
    width:58px;height:58px;border-radius:50%;display:grid;place-items:center;
    box-shadow:0 10px 24px rgba(0,0,0,.18);border:none;font-size:24px;z-index:20
  }
  dialog{
    border:none;border-radius:16px;max-width:640px;width:92vw;padding:0
  }
  dialog .sheet{padding:16px}
  .sheet h3{margin:6px 0 14px}
  .grid{display:grid;gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .field{display:grid;gap:6px}
  .field input[type="text"], .field input[type="file"], .field select{
    border:1px solid #cfd8cf;border-radius:10px;padding:10px 12px;background:#fff
  }
  .switch{display:flex;align-items:center;gap:10px}
  .switch input{width:20px;height:20px}

  /* vattenst√§mpel som anv√§nder samma logga */
  .watermark{position:fixed;right:14px;bottom:14px;opacity:.18;z-index:0;pointer-events:none}
  .watermark img{display:block;max-width:180px;max-height:120px;width:auto;height:auto;filter:grayscale(15%)}

  /* lite kompaktare p√• smala sk√§rmar */
  @media (max-width:520px){
    .row{grid-template-columns:46px 1fr 1fr 1fr 74px 44px;gap:8px;padding:10px}
    header img.logo{width:36px;height:36px}
    .btn{padding:8px 12px}
  }
</style>
</head>
<body>

<header>
  <img id="logoImg" class="logo" alt="Logga" />
  <div class="title">
    Tannenhofs tidtabell
    <small id="monthLabel"></small>
  </div>
  <div class="actions">
    <button class="btn" id="btnShare">Dela / Skicka</button>
    <button class="btn" id="btnPdf">Skriv ut / PDF</button>
  </div>
</header>

<main id="app">
  <div class="panel" id="monthPicker" style="display:none"></div>
  <div id="monthSticky" class="sticky-month"></div>
  <div id="list"></div>
</main>

<!-- flytande knapp till inst√§llningar -->
<button class="fab" id="btnSettings">‚öôÔ∏è</button>

<!-- inst√§llningar -->
<dialog id="settingsDlg">
  <div class="sheet">
    <h3>Inst√§llningar</h3>
    <div class="grid">
      <div class="field">
        <label>F√∂retag</label>
        <input id="inpCompany" type="text" placeholder="TH√úRINGER TANNENHOF" />
      </div>
      <div class="field">
        <label>Spr√•k</label>
        <select id="inpLang">
          <option value="sv">Svenska</option>
          <option value="de">Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="field">
        <label>Logga (emoji eller text, t.ex. üå≤ eller ü¶å)</label>
        <input id="inpLogoText" type="text" placeholder="üå≤" />
      </div>
      <div class="field">
        <label>Eller ladda upp bild</label>
        <input id="inpLogoFile" type="file" accept="image/*" />
      </div>

      <div class="field">
        <label>M√•nad</label>
        <select id="inpMonth"></select>
      </div>
      <div class="field">
        <label>√Ör</label>
        <select id="inpYear"></select>
      </div>

      <div class="field switch">
        <input id="chkAutosave" type="checkbox" />
        <label for="chkAutosave">Autospara</label>
      </div>
      <div class="field switch">
        <input id="chkWatermark" type="checkbox" />
        <label for="chkWatermark">Visa vattenst√§mpel</label>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn" id="applySettings">Spara & st√§ng</button>
      <button class="btn" id="clearAll">Rensa allt</button>
      <button class="btn" id="closeDlg" style="margin-left:auto">St√§ng</button>
    </div>
  </div>
</dialog>

<!-- vattenst√§mpel (samma som loggan) -->
<div class="watermark" id="wm" aria-hidden="true"><img id="wmImg" alt=""></div>

<script>
/* ---------- hj√§lp ---------- */
const $ = sel => document.querySelector(sel);
const list = $('#list');
const monthSticky = $('#monthSticky');
const monthLabel = $('#monthLabel');

const monthsSV = ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];
const pad = n => String(n).padStart(2,'0');
const metaKey = () => 'th-meta';
const dataKey = (y,m) => `th-data-${y}-${pad(m+1)}`;

function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

function timeToMinutes(v){
  if(!v) return 0;
  const [h,m]=v.split(':').map(x=>parseInt(x,10)||0);
  return h*60+m;
}
function minutesToHHMM(min){
  const h=Math.floor(min/60), m=min%60;
  return `${pad(h)}:${pad(m)}`;
}

/* ---------- metadata ---------- */
let meta = {
  company: "TH√úRINGER TANNENHOF",
  lang: "sv",
  month: (new Date()).getMonth(),
  year: (new Date()).getFullYear(),
  autosave: true,
  watermark: true,
  logoData: "" // dataURL
};

function loadMeta(){
  try{
    const m = JSON.parse(localStorage.getItem(metaKey()));
    if(m) Object.assign(meta,m);
  }catch(e){}
}
function saveMeta(){
  localStorage.setItem(metaKey(), JSON.stringify(meta));
}

/* ---------- logo / watermark ---------- */
const logoImg = $('#logoImg'), wmImg = $('#wmImg'), wm = $('#wm');

function setLogoFromText(txt){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'>
    <rect rx='20' ry='20' width='120' height='120' fill='white'/>
    <text x='50%' y='60%' font-size='82' text-anchor='middle'>${txt}</text>
  </svg>`;
  const url = 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  logoImg.src = url;
  meta.logoData = url; saveMeta(); updateWatermark();
}
function setLogoFromFile(file){
  const r=new FileReader();
  r.onload=e=>{ logoImg.src=e.target.result; meta.logoData=e.target.result; saveMeta(); updateWatermark(); };
  r.readAsDataURL(file);
}
function updateWatermark(){
  if(meta.watermark && meta.logoData){
    wmImg.src = meta.logoData;
    wm.style.display='block';
  }else{
    wmImg.removeAttribute('src');
    wm.style.display='none';
  }
}

/* ---------- data ---------- */
let rows = []; // [{from,to,break,notes,total}]
function loadData(){
  const key = dataKey(meta.year, meta.month);
  try{
    const d = JSON.parse(localStorage.getItem(key));
    if(d && Array.isArray(d)) rows = d; else rows = [];
  }catch(e){ rows=[]; }
}
function saveData(){
  if(!meta.autosave) return;
  localStorage.setItem(dataKey(meta.year, meta.month), JSON.stringify(rows));
}

/* ---------- rendering ---------- */
function buildMonthPicker(){
  const mSel = $('#inpMonth'), ySel = $('#inpYear');
  mSel.innerHTML = monthsSV.map((n,i)=>`<option value="${i}">${n}</option>`).join('');
  const yNow = (new Date()).getFullYear();
  const ys = [];
  for(let y=yNow-2;y<=yNow+3;y++) ys.push(`<option value="${y}">${y}</option>`);
  ySel.innerHTML = ys.join('');
}
function labelMonth(){
  const label = `${monthsSV[meta.month]} ${meta.year}`;
  monthSticky.textContent = label;
  monthLabel.textContent = label;
}
function defaultRow(){
  return {from:"", to:"", break:"00:00", notes:"", total:0};
}
function render(){
  const n = daysInMonth(meta.year, meta.month);
  if(rows.length!==n){ rows = Array.from({length:n}, (_,i)=>rows[i]||defaultRow()); saveData(); }

  labelMonth();
  list.innerHTML = "";
  const today = new Date();
  const isThisMonth = (today.getMonth()===meta.month && today.getFullYear()===meta.year);
  let todaysEl = null;

  for(let d=1; d<=n; d++){
    const r = rows[d-1];
    const row = document.createElement('div');
    row.className = 'row';
    if(isThisMonth && d===today.getDate()){ row.classList.add('today'); todaysEl=row; }

    const calc = ()=>{
      const total = Math.max(0, timeToMinutes(r.to)-timeToMinutes(r.from)-timeToMinutes(r.break));
      r.total = total;
      tot.textContent = minutesToHHMM(total/1|0).replace(/^0+(\d)/,'$1');
      saveData();
    };

    const daycell = document.createElement('div');
    daycell.className='daycell';
    daycell.textContent = d;

    const f = document.createElement('input');
    f.type='time'; f.inputMode='numeric'; f.placeholder=""; f.value=r.from;
    f.addEventListener('change', ()=>{ r.from=f.value; calc(); });

    const t = document.createElement('input');
    t.type='time'; t.inputMode='numeric'; t.placeholder=""; t.value=r.to;
    t.addEventListener('change', ()=>{ r.to=t.value; calc(); });

    const br = document.createElement('input');
    br.type='time'; br.step=60; br.value=r.break||"00:00";
    br.addEventListener('change', ()=>{ r.break=br.value||"00:00"; calc(); });

    const tot = document.createElement('div');
    tot.className='tot';
    tot.textContent = r.total ? minutesToHHMM(r.total) : "0.00";

    const noteBtn = document.createElement('button');
    noteBtn.className='btn'; noteBtn.textContent='üìù';
    noteBtn.style.height='44px';
    noteBtn.addEventListener('click', ()=>{
      const txt = prompt(`Anteckningar f√∂r dag ${d}`, r.notes || "");
      if(txt!==null){ r.notes = txt; saveData(); }
    });

    row.append(daycell,f,t,br,tot,noteBtn);
    list.append(row);

    // initialization
    calc();
  }

  // scrolla till dagens rad
  if(todaysEl){
    setTimeout(()=>todaysEl.scrollIntoView({block:'center',behavior:'smooth'}), 50);
  }
}

/* ---------- PDF/Share (enkla platsh√•llare) ---------- */
$('#btnPdf').addEventListener('click', ()=>window.print());
$('#btnShare').addEventListener('click', async ()=>{
  const msg = `${meta.company} ‚Äì ${monthsSV[meta.month]} ${meta.year}`;
  if(navigator.share){ try{ await navigator.share({title:document.title,text:msg,url:location.href}); }catch(e){} }
  else { alert('Dela-l√§nkar st√∂ds inte i denna webbl√§sare.'); }
});

/* ---------- inst√§llningar ---------- */
const dlg = $('#settingsDlg');
$('#btnSettings').addEventListener('click', ()=>{
  // fyll form
  $('#inpCompany').value = meta.company||"";
  $('#inpLang').value = meta.lang||"sv";
  $('#inpLogoText').value = "";
  $('#inpLogoFile').value = "";
  $('#inpMonth').value = String(meta.month);
  $('#inpYear').value = String(meta.year);
  $('#chkAutosave').checked = !!meta.autosave;
  $('#chkWatermark').checked = !!meta.watermark;
  dlg.showModal();
});
$('#closeDlg').addEventListener('click', ()=>dlg.close());

$('#applySettings').addEventListener('click', ()=>{
  meta.company = $('#inpCompany').value.trim() || meta.company;
  meta.lang = $('#inpLang').value;
  meta.month = parseInt($('#inpMonth').value,10);
  meta.year = parseInt($('#inpYear').value,10);
  meta.autosave = $('#chkAutosave').checked;
  meta.watermark = $('#chkWatermark').checked;

  const txt = $('#inpLogoText').value.trim();
  const file = $('#inpLogoFile').files[0];
  if(file){ setLogoFromFile(file); }
  else if(txt){ setLogoFromText(txt); }
  else { updateWatermark(); }

  saveMeta();
  dlg.close();
  loadData(); render();
});

$('#clearAll').addEventListener('click', ()=>{
  if(confirm('Rensa alla tider f√∂r aktuell m√•nad?')){
    rows = Array.from({length:daysInMonth(meta.year, meta.month)}, ()=>defaultRow());
    saveData(); render();
  }
});

/* ---------- init ---------- */
(function start(){
  loadMeta();
  buildMonthPicker();
  if(meta.logoData) logoImg.src = meta.logoData;
  updateWatermark();
  loadData();
  render();
})();
</script>
</body>
</html>
