<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tannenhof ‚Äì Stundenliste</title>
<meta name="theme-color" content="#1f5634">
<style>
  :root{
    --green:#1f5634;
    --green-700:#154128;
    --green-100:#ecf6ee;
    --ink:#0b2a10;
    --muted:#6b7a6c;
    --ring:#a5d6a7;
    --shadow:0 10px 30px rgba(0,0,0,.12);
    --radius:16px;
  }
  html,body{height:100%}
  body{
    margin:0; background:#f4f7f5; color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    -webkit-font-smoothing:antialiased; font-variant-numeric:tabular-nums;
  }

  /* Header */
  .appbar{position:sticky;top:0;z-index:30;
    background:linear-gradient(0deg,var(--green) 0%,var(--green-700) 100%); color:#fff; box-shadow:var(--shadow)}
  .appbar-inner{max-width:1100px;margin:auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;gap:12px;min-width:0}
  .brand img{width:36px;height:36px;object-fit:cover;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .brand h1{margin:0;font-size:22px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .brand small{display:block;font-size:12px;opacity:.9}
  .spacer{flex:1}
  .btn{appearance:none;border:0;border-radius:14px;padding:10px 14px;background:#fff;color:var(--ink);font-weight:700;box-shadow:var(--shadow);min-width:168px;text-align:center}
  .btn--dark{background:#0e1a11;color:#fff}
  .btn:active{transform:translateY(1px)}

  /* Totals */
  .total{max-width:1100px;margin:14px auto;padding:14px 16px}
  .total-box{background:#fff;border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow);
    display:flex;align-items:center;justify-content:space-between;gap:10px}
  .total-title{font-weight:800;letter-spacing:.2px}
  .total-sum{font-size:20px;font-weight:800}

  /* Table wrapper */
  .table-wrap{max-width:1100px;margin:0 auto 18px;background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
    overflow-x:auto;-webkit-overflow-scrolling:touch;touch-action:pan-x pan-y;overscroll-behavior:contain}
  table{border-collapse:separate;border-spacing:0;width:1024px;table-layout:fixed}
  thead th{position:sticky;top:0;z-index:5;background:var(--green-100);color:var(--ink);
    text-align:left;padding:14px;font-size:14px;border-bottom:1px solid #dfe8e1}
  tbody td{padding:10px 12px;border-bottom:1px solid #eef2ee;background:#fff}
  tbody tr:nth-child(2n) td{background:#fafdfb}
  .daycol{width:70px;text-align:center;font-weight:800}
  .timecol{width:160px}
  .breakcol{width:160px}
  .totalcol{width:120px;font-weight:800}
  .projcol{width:240px}
  .actcol{width:170px}

  /* Inputs */
  .t{width:100%;height:44px;border-radius:12px;border:2px solid #dfe8e1;padding:0 10px;font-size:16px;background:#fff;box-sizing:border-box}
  .t:focus{outline:3px solid var(--ring);border-color:transparent}
  .pill{height:44px;border-radius:12px;background:#fff;border:2px solid #dfe8e1;display:flex;align-items:center;gap:8px;padding:0 10px}
  .pill span{opacity:.7}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#e8f3ea;font-weight:700}

  .btn-icon{width:44px;height:44px;display:inline-grid;place-items:center;border-radius:12px;
    background:var(--green);color:#fff;border:0;box-shadow:var(--shadow);position:relative}
  .btn-icon.secondary{background:#2b7a48}
  .btn-icon .bubble{position:absolute;top:-6px;right:-6px;min-width:18px;height:18px;padding:0 4px;
    background:#d32f2f;color:#fff;border-radius:9px;font-size:12px;display:grid;place-items:center}

  .today td{background:#f0fbf3!important;box-shadow:inset 3px 0 0 0 var(--green)}

  /* Watermark */
  .wm{position:fixed;right:16px;bottom:18px;width:260px;max-width:42vw;opacity:.7;z-index:0;pointer-events:none;filter:grayscale(.1)}

  /* FAB */
  .fab{position:fixed;left:16px;bottom:18px;z-index:20;width:64px;height:64px;display:grid;place-items:center;
    background:var(--green);color:#fff;border-radius:18px;box-shadow:var(--shadow);border:0}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;place-items:center;z-index:40}
  .modal.open{display:grid}
  .sheet{width:min(720px,92vw);max-height:88vh;overflow:auto;background:#fff;border-radius:20px;box-shadow:var(--shadow);padding:18px}
  .sheet h3{margin:0 0 8px 0}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:1fr 1fr}
  .row{display:flex;gap:10px;align-items:center}
  .muted{color:var(--muted);font-size:13px}

  /* Photo grid */
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:10px}
  .thumb{position:relative;border-radius:10px;overflow:hidden;box-shadow:var(--shadow)}
  .thumb img{display:block;width:100%;height:84px;object-fit:cover}
  .thumb button{position:absolute;top:6px;right:6px;border:0;border-radius:999px;background:#0008;color:#fff;width:26px;height:26px}

  /* Signatures footer */
  .sign-footer{max-width:1100px;margin:0 auto 100px;padding:0 16px}
  .sign-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .sign-mini{display:flex;align-items:center;gap:10px}
  .sign-mini img{width:120px;height:60px;object-fit:contain;background:#fff;border:2px dashed #dfe8e1;border-radius:10px}
  .sign-actions{display:flex;gap:10px;flex-wrap:wrap}

  /* Debug panel */
  .debug{position:fixed;right:12px;bottom:92px;z-index:15;max-width:60vw;background:#111;color:#d2f1d6;
    border-radius:12px;box-shadow:var(--shadow);padding:10px;display:none;font-size:12px;line-height:1.35;max-height:40vh;overflow:auto}
  .debug.show{display:block}

  @media print{
    .appbar,.fab,.modal,.wm,.debug{display:none!important}
    body{background:#fff}
    .table-wrap{box-shadow:none}
    .sign-card{box-shadow:none;border:1px solid #e5ebe7}
    .sign-mini img{border:1px solid #dfe8e1}
  }
</style>
</head>
<body>

<header class="appbar">
  <div class="appbar-inner">
    <div class="brand">
      <img id="brandLogo" alt="logo" src="" />
      <div style="min-width:0">
        <h1 id="titleTxt">Tannenhof Stundenliste</h1>
        <small class="subtitle" id="monthSub">Oktober 2025</small>
      </div>
    </div>
    <div class="spacer"></div>
    <button class="btn" id="shareBtn">üì§ <span data-i="share">Teilen / Senden</span></button>
    <button class="btn btn--dark" id="printBtn">üñ®Ô∏è <span data-i="print">Drucken / PDF</span></button>
  </div>
</header>

<main>
  <section class="total">
    <div class="total-box">
      <div class="total-title">‚è≥ <span id="totalTitle">Gesamt ‚Äì Oktober 2025</span></div>
      <div class="total-sum" id="grandTotal">0.00</div>
    </div>
  </section>

  <section class="table-wrap" id="hScroll">
    <table id="sheet">
      <thead>
        <tr>
          <th class="daycol" data-i="day">Tag</th>
          <th class="timecol" data-i="from">Von</th>
          <th class="timecol" data-i="to">Bis</th>
          <th class="breakcol" data-i="break">Pause</th>
          <th class="totalcol" data-i="totalCol">Gesamt</th>
          <th class="projcol" data-i="project">Projekt/Ort</th>
          <th class="actcol" data-i="actions">Aktion</th>
        </tr>
      </thead>
      <tbody id="bodyRows"></tbody>
    </table>
  </section>

  <!-- Signatures footer -->
  <section class="sign-footer">
    <div class="sign-card">
      <div class="sign-mini">
        <div>
          <div style="font-weight:800" data-i="empSig">Mitarbeiter-Signatur</div>
          <div class="muted" id="empDate"></div>
        </div>
        <img id="empThumb" alt="Mitarbeiter" />
      </div>
      <div class="sign-actions">
        <button class="btn" id="empOpen">üë§ <span data-i="empOpen">Unterschreiben</span></button>
        <button class="btn" id="empClear">üßπ <span data-i="clear">L√∂schen</span></button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="sign-card">
      <div class="sign-mini">
        <div>
          <div style="font-weight:800" data-i="mgrSig">Unterschrift Vorgesetzte/r</div>
          <div class="muted" id="mgrDate"></div>
        </div>
        <img id="mgrThumb" alt="Vorgesetzte/r" />
      </div>
      <div class="sign-actions">
        <button class="btn" id="mgrOpen">üñäÔ∏è <span data-i="mgrOpen">Unterschreiben</span></button>
        <button class="btn" id="mgrClear">üßπ <span data-i="clear">L√∂schen</span></button>
      </div>
    </div>
  </section>
</main>

<img id="wm" class="wm" alt="watermark"/>

<button class="fab" id="settingsBtn">‚öôÔ∏è</button>
<div class="debug" id="debug"></div>

<!-- Settings -->
<div class="modal" id="settingsModal" aria-hidden="true">
  <div class="sheet">
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
      <h3 data-i="settings">Einstellungen</h3>
      <button class="btn" id="closeSettings">‚úñ</button>
    </div>

    <div class="grid">
      <label class="grid">
        <span data-i="company">Arbeitgeber</span>
        <input id="company" class="t" placeholder="TH√úRINGER TANNENHOF">
      </label>

      <div class="grid">
        <span data-i="logo">Logo (Bild oder Emoji)</span>
        <div class="row">
          <input id="logoFile" type="file" accept="image/*" class="t"/>
          <button class="btn" id="clearLogo" data-i="clearLogo">Logo l√∂schen</button>
        </div>
        <div class="muted" data-i="logoHint">Dein Logo wird lokal auf diesem Ger√§t gespeichert.</div>
      </div>

      <div class="grid grid-2">
        <label class="grid">
          <span data-i="language">Sprache</span>
          <select id="lang" class="t">
            <option value="de">Deutsch</option>
            <option value="sv">Svenska</option>
            <option value="en">English</option>
          </select>
        </label>

        <label class="grid">
          <span>Farbton (HEX)</span>
          <div class="row">
            <input id="brandHex" class="t" placeholder="#1f5634" style="flex:1">
            <input id="brandPick" type="color" class="t" style="width:64px;padding:0">
          </div>
        </label>

        <label class="grid">
          <span data-i="month">Monat</span>
          <select id="month" class="t"></select>
        </label>

        <label class="grid">
          <span data-i="year">Jahr</span>
          <select id="year" class="t"></select>
        </label>

        <label class="grid">
          <span data-i="autosave">Autospeichern</span>
          <select id="autosave" class="t">
            <option value="on" selected data-i="on">Ein</option>
            <option value="off" data-i="off">Aus</option>
          </select>
        </label>

        <label class="grid">
          <span>Fels√∂kning / Debug</span>
          <select id="debugToggle" class="t">
            <option value="off">Aus</option>
            <option value="on">Ein</option>
          </select>
        </label>
      </div>

      <div class="grid grid-2">
        <label class="grid">
          <span data-i="wmToggle">Wasserzeichen</span>
          <select id="wmToggle" class="t">
            <option value="on" selected data-i="on">Ein</option>
            <option value="off" data-i="off">Aus</option>
          </select>
        </label>
        <label class="grid">
          <span data-i="wmOpacity">Deckkraft</span>
          <input id="wmOpacity" type="range" min="0" max="100" value="40"/>
        </label>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" id="regenBtn" data-i="genDays">Tage erstellen</button>
        <button class="btn btn--dark" id="saveClose" data-i="saveClose">Speichern & schlie√üen</button>
      </div>
    </div>
  </div>
</div>

<!-- Notes / Photos -->
<div class="modal" id="notesModal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3 id="notesTitle">Tag 1</h3>
      <button class="btn" id="closeNotes">‚úñ</button>
    </div>
    <div class="grid">
      <textarea id="notesArea" class="t" style="height:160px" placeholder="Notiz‚Ä¶"></textarea>
      <div class="grid">
        <span>üì∑ <span data-i="photos">Fotos (optional)</span></span>
        <input id="photosInput" type="file" accept="image/*" multiple class="t">
        <div id="photoGrid" class="thumbs"></div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn btn--dark" id="saveNotes" data-i="save">Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- Share -->
<div class="modal" id="shareModal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3 data-i="share">Teilen / Senden</h3>
      <button class="btn" id="closeShare">‚úñ</button>
    </div>
    <div class="grid">
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <button class="btn" id="nativeShare">üì§ <span>System teilen</span></button>
        <button class="btn" id="copyLink">üîó <span data-i="copyLink">Link kopieren</span></button>
        <a class="btn" id="mailLink" href="#">‚úâÔ∏è <span data-i="email">E-Mail</span></a>
        <a class="btn" id="waLink" href="#" target="_blank">üü¢ WhatsApp</a>
      </div>
      <div class="grid" style="place-items:center">
        <img id="qrImg" alt="QR" style="width:min(240px,60vw);border-radius:16px;box-shadow:var(--shadow)">
        <div class="muted" data-i="scan">QR-Code scannen, um die Seite zu √∂ffnen.</div>
      </div>
    </div>
  </div>
</div>

<!-- Signature modal (shared) -->
<div class="modal" id="signModal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3 id="signTitle">Signieren</h3>
      <button class="btn" id="closeSign">‚úñ</button>
    </div>
    <div class="grid">
      <canvas id="signPad" style="width:100%;height:260px;background:#fff;border:2px solid #dfe8e1;border-radius:12px"></canvas>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn" id="signClear">üßπ <span data-i="clear">L√∂schen</span></button>
        <button class="btn btn--dark" id="signSave">üíæ <span data-i="save">Speichern</span></button>
      </div>
    </div>
  </div>
</div>

<script>
/*** i18n ***/
const I = {
  sv:{ appTitle:"Tannenhofs tidtabell", share:"Dela / Skicka", print:"Skriv ut / PDF",
    total:"Totalt ‚Äì {month} {year}", day:"Dag", from:"Fr√•n", to:"Till", break:"Paus", totalCol:"Totalt",
    project:"Projekt/plats", actions:"√Ötg√§rd", settings:"Inst√§llningar", company:"F√∂retag",
    logo:"Logga (bild eller emoji)", logoHint:"Din logga sparas lokalt p√• den h√§r enheten.",
    language:"Spr√•k", month:"M√•nad", year:"√Ör", autosave:"Autospara", on:"P√•", off:"Av",
    genDays:"Skapa dagar", saveClose:"Spara & st√§ng", wmToggle:"Vattenst√§mpel", wmOpacity:"St√§mpel opacitet",
    notes:"Anteckning", edit:"Redigera", photos:"Foton (valfritt)", save:"Spara",
    copyLink:"Kopiera l√§nk", email:"E-post", scan:"Skanna QR-koden f√∂r att √∂ppna sidan.", clear:"Rensa",
    clearLogo:"Rensa logga",
    empSig:"Medarbetarens signatur", mgrSig:"Chefens signatur", empOpen:"Signera (medarbetare)", mgrOpen:"Signera (chef)" },
  de:{ appTitle:"Tannenhof Stundenliste", share:"Teilen / Senden", print:"Drucken / PDF",
    total:"Gesamt ‚Äì {month} {year}", day:"Tag", from:"Von", to:"Bis", break:"Pause", totalCol:"Gesamt",
    project:"Projekt/Ort", actions:"Aktion", settings:"Einstellungen", company:"Arbeitgeber",
    logo:"Logo (Bild oder Emoji)", logoHint:"Dein Logo wird lokal auf diesem Ger√§t gespeichert.",
    language:"Sprache", month:"Monat", year:"Jahr", autosave:"Autospeichern", on:"Ein", off:"Aus",
    genDays:"Tage erstellen", saveClose:"Speichern & schlie√üen", wmToggle:"Wasserzeichen", wmOpacity:"Deckkraft",
    notes:"Notiz", edit:"Bearbeiten", photos:"Fotos (optional)", save:"Speichern",
    copyLink:"Link kopieren", email:"E-Mail", scan:"QR-Code scannen, um die Seite zu √∂ffnen.", clear:"L√∂schen",
    clearLogo:"Logo l√∂schen",
    empSig:"Mitarbeiter-Signatur", mgrSig:"Unterschrift Vorgesetzte/r", empOpen:"Unterschreiben (Mitarb.)", mgrOpen:"Unterschreiben (Vorges.)" },
  en:{ appTitle:"Tannenhof Timesheet", share:"Share / Send", print:"Print / PDF",
    total:"Total ‚Äì {month} {year}", day:"Day", from:"From", to:"To", break:"Break", totalCol:"Total",
    project:"Project/site", actions:"Action", settings:"Settings", company:"Company",
    logo:"Logo (image or emoji)", logoHint:"Your logo is stored locally on this device.",
    language:"Language", month:"Month", year:"Year", autosave:"Autosave", on:"On", off:"Off",
    genDays:"Generate days", saveClose:"Save & close", wmToggle:"Watermark", wmOpacity:"Opacity",
    notes:"Note", edit:"Edit", photos:"Photos (optional)", save:"Save",
    copyLink:"Copy link", email:"Email", scan:"Scan the QR to open this page.", clear:"Clear",
    clearLogo:"Clear logo",
    empSig:"Employee Signature", mgrSig:"Supervisor Signature", empOpen:"Sign (Employee)", mgrOpen:"Sign (Supervisor)" }
};
const MONTHS = {
  sv:["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"],
  de:["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],
  en:["January","February","March","April","May","June","July","August","September","October","November","December"]
};
const S = JSON.parse(localStorage.getItem("tnh_settings")||"{}");

/*** Elements ***/
const $ = s=>document.querySelector(s);
const bodyRows=$("#bodyRows"), titleTxt=$("#titleTxt"), monthSub=$("#monthSub"),
      totalTitle=$("#totalTitle"), grandTotal=$("#grandTotal"),
      wmImg=$("#wm"), brandLogo=$("#brandLogo"),
      settingsBtn=$("#settingsBtn"), settingsModal=$("#settingsModal"),
      closeSettings=$("#closeSettings"), saveClose=$("#saveClose"), regenBtn=$("#regenBtn"),
      langSel=$("#lang"), monthSel=$("#month"), yearSel=$("#year"),
      autosaveSel=$("#autosave"), wmToggleSel=$("#wmToggle"), wmOpacity=$("#wmOpacity"),
      companyInput=$("#company"), logoFile=$("#logoFile"), clearLogo=$("#clearLogo"),
      debugPanel=$("#debug"), debugToggle=$("#debugToggle"),
      brandHex=$("#brandHex"), brandPick=$("#brandPick"),
      notesModal=$("#notesModal"), notesArea=$("#notesArea"), notesTitle=$("#notesTitle"),
      closeNotes=$("#closeNotes"), saveNotes=$("#saveNotes"),
      photosInput=$("#photosInput"), photoGrid=$("#photoGrid"),
      shareBtn=$("#shareBtn"), printBtn=$("#printBtn"), shareModal=$("#shareModal"),
      closeShare=$("#closeShare"), qrImg=$("#qrImg"), copyLink=$("#copyLink"),
      mailLink=$("#mailLink"), waLink=$("#waLink"), nativeShare=$("#nativeShare"),
      empOpen=$("#empOpen"), empClear=$("#empClear"), empThumb=$("#empThumb"), empDate=$("#empDate"),
      mgrOpen=$("#mgrOpen"), mgrClear=$("#mgrClear"), mgrThumb=$("#mgrThumb"), mgrDate=$("#mgrDate"),
      signModal=$("#signModal"), signTitle=$("#signTitle"), closeSign=$("#closeSign"),
      signPad=$("#signPad"), signClear=$("#signClear"), signSave=$("#signSave");

/*** State ***/
let currentLang = S.lang || "de";
let currentYear = S.year || new Date().getFullYear();
let currentMonth = (S.month ?? new Date().getMonth());
let autosave = S.autosave ?? "on";
let wmOn = S.wmOn ?? "on";
let wmAlpha = S.wmAlpha ?? 40;
let company = S.company || "TH√úRINGER TANNENHOF";
let logoData = S.logoData || "";
let themeHex = S.themeHex || "#1f5634";
let activeRow = 1;
let dbg = S.debug || "off";

/*** Helpers ***/
function t(k){return I[currentLang][k]}
function fmtMonth(m){return MONTHS[currentLang][m]}
function pad(n){return String(n).padStart(2,"0")}
function mins(hm){ if(!hm) return 0; const [h,m]=hm.split(":").map(Number); return h*60+m }
function diff(fr,to,brk){ if(!fr||!to) return 0; let m=mins(to)-mins(fr)-(brk?mins(brk):0); if(m<0) m+=1440; return Math.max(0,m)}
function msToH(m){return (m/60).toFixed(2)}
function log(s){ if(dbg!=="on") return; const ts=new Date().toLocaleTimeString(); const line=`[${ts}] ${s}`; debugPanel.insertAdjacentHTML("afterbegin", line+"<br>")}

/*** Month/Year selects ***/
function fillMonthYear(){
  monthSel.innerHTML = MONTHS[currentLang].map((n,i)=>`<option value="${i}">${n}</option>`).join("");
  const yNow = new Date().getFullYear(); let ys=[];
  for(let y=yNow-1;y<=yNow+2;y++) ys.push(`<option value="${y}">${y}</option>`);
  yearSel.innerHTML = ys.join("");
  monthSel.value=String(currentMonth); yearSel.value=String(currentYear);
}

/*** Rows ***/
function daysInMonth(y,m){return new Date(y,m+1,0).getDate()}
function val(tr,f){ return tr.querySelector(`[data-f="${f}"]`)?.value||"" }

function buildRows(){
  bodyRows.innerHTML="";
  const dcount = daysInMonth(currentYear,currentMonth);
  for(let d=1; d<=dcount; d++){
    const tr=document.createElement("tr"); tr.dataset.day=d;
    const today=new Date();
    if(today.getFullYear()===currentYear && today.getMonth()===currentMonth && today.getDate()===d){
      tr.classList.add("today"); activeRow=d; setTimeout(()=>tr.scrollIntoView({behavior:"smooth",block:"center"}),250);
    }
    tr.innerHTML=`
      <td class="daycol"><div class="badge">üìÖ ${d}</div></td>
      <td class="timecol"><input class="t time" type="time" step="300" data-f="from" data-d="${d}"></td>
      <td class="timecol"><input class="t time" type="time" step="300" data-f="to" data-d="${d}"></td>
      <td class="breakcol"><div class="pill"><span>‚òï</span><input class="t" style="border:0;flex:1" type="time" step="300" value="00:00" data-f="break" data-d="${d}"></div></td>
      <td class="totalcol"><div class="badge">‚è≥ <span id="tot-${d}">0.00</span></div></td>
      <td class="projcol"><div class="pill"><span>üß±</span><input class="t" style="border:0;flex:1" type="text" placeholder="${t('project')}" data-f="project" data-d="${d}"></div></td>
      <td class="actcol">
        <button class="btn-icon" data-note="${d}" title="${t('notes')}">üìù</button>
        <button class="btn-icon" data-photo-camera="${d}" title="Kamera">üì∑</button>
        <button class="btn-icon secondary" data-photo-gallery="${d}" title="Galerie">üñºÔ∏è<span class="bubble" id="pb-${d}" style="display:none">0</span></button>
      </td>`;
    bodyRows.appendChild(tr);
  }
  restoreData(); updatePhotoBubbles(); computeAll();
}

/*** Persistence ***/
function key(){return `tnh_data_${currentYear}_${currentMonth}`}
function readData(){return JSON.parse(localStorage.getItem(key())||"{}")}
function saveData(){
  if(autosave!=="on") return;
  const obj={};
  bodyRows.querySelectorAll("tr").forEach(tr=>{
    const d=tr.dataset.day;
    obj[d]={from:val(tr,"from"),to:val(tr,"to"),break:val(tr,"break")||"00:00",project:val(tr,"project")||""};
  });
  localStorage.setItem(key(), JSON.stringify(obj));
}
function restoreData(){
  const obj=readData();
  bodyRows.querySelectorAll("tr").forEach(tr=>{
    const d=tr.dataset.day, r=obj[d]||{};
    ["from","to","break","project"].forEach(f=>{
      const el=tr.querySelector(`[data-f="${f}"]`); if(el && r[f]!=null) el.value=r[f];
    });
    computeRow(d);
  });
}
function noteKey(d){return `tnh_note_${currentYear}_${currentMonth}_${d}`}
function photoKey(d){return `tnh_photos_${currentYear}_${currentMonth}_${d}`}
function empSigKey(){return `tnh_sig_emp_${currentYear}_${currentMonth}`}
function mgrSigKey(){return `tnh_sig_mgr_${currentYear}_${currentMonth}`}
function empDateKey(){return `tnh_sig_emp_date_${currentYear}_${currentMonth}`}
function mgrDateKey(){return `tnh_sig_mgr_date_${currentYear}_${currentMonth}`}

/*** Watermark & logo ***/
function setTheme(hex){
  if(!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(hex)) return;
  document.documentElement.style.setProperty('--green', hex);
  document.documentElement.style.setProperty('--green-700', hex);
  S.themeHex=hex; localStorage.setItem("tnh_settings", JSON.stringify(S));
  document.querySelector('meta[name="theme-color"]').setAttribute('content',hex);
}
function applyLogo(){
  if(logoData){brandLogo.src=logoData; wmImg.src=logoData}
  else{
    const svg=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'><g fill='#2e7d32'><path d='M64 210h128v20H64z'/><path d='M128 30l40 60h-20l30 45h-20l25 38h-50v-30h-10v30H83l25-38H88l30-45H98z'/></g></svg>`);
    const url=`data:image/svg+xml;utf8,${svg}`; brandLogo.src=url; wmImg.src=url;
  }
  wmImg.style.opacity=(wmOn==="on")?(wmAlpha/100):0;
}

/*** Language ***/
function applyLanguage(){
  document.querySelectorAll("[data-i]").forEach(el=>el.textContent=t(el.dataset.i));
  titleTxt.textContent = company || t("appTitle");
  monthSub.textContent = `${fmtMonth(currentMonth)} ${currentYear}`;
  totalTitle.textContent = t("total").replace("{month}", fmtMonth(currentMonth)).replace("{year}", currentYear);
  bodyRows.querySelectorAll('[data-f="project"]').forEach(i=>i.placeholder=t('project'));
  fillMonthYear();
}

/*** Compute ***/
function computeRow(d){
  const tr=bodyRows.querySelector(`tr[data-day="${d}"]`);
  if(!tr) return;
  const m=diff(val(tr,'from'),val(tr,'to'),val(tr,'break')||"00:00");
  tr.querySelector(`#tot-${d}`).textContent=msToH(m);
}
function computeAll(){
  let sum=0;
  bodyRows.querySelectorAll("tr").forEach(tr=>{
    const d=tr.dataset.day;
    sum += parseFloat(tr.querySelector(`#tot-${d}`).textContent)||0;
  });
  grandTotal.textContent=sum.toFixed(2);
}

/*** Events ‚Äì rows ***/
bodyRows.addEventListener("input",e=>{
  const tr=e.target.closest("tr"); if(!tr) return; const d=Number(tr.dataset.day);
  computeRow(d); saveData();
});
bodyRows.addEventListener("click", async e=>{
  const n=e.target.closest("[data-note]"); const c=e.target.closest("[data-photo-camera]"); const g=e.target.closest("[data-photo-gallery]");
  if(n){ openNotes(n.dataset.note); return;}
  if(c){ await addPhotos(c.dataset.photoCamera,{capture:true}); return;}
  if(g){ await addPhotos(g.dataset.photoGallery,{capture:false}); return;}
});

/*** Settings modal ***/
function openSettings(){settingsModal.classList.add("open")}
function closeSettingsModal(){settingsModal.classList.remove("open")}
settingsBtn.onclick=openSettings; closeSettings.onclick=closeSettingsModal;
saveClose.onclick=()=>{
  company=companyInput.value.trim()||company; S.company=company;
  S.lang=currentLang; S.month=currentMonth; S.year=currentYear;
  S.autosave=autosave; S.wmOn=wmOn; S.wmAlpha=wmAlpha; S.logoData=logoData; S.debug=dbg;
  localStorage.setItem("tnh_settings", JSON.stringify(S));
  closeSettingsModal(); applyLanguage(); applyLogo(); computeAll();
}
regenBtn.onclick=()=>{buildRows(); computeAll()}

/*** Notes modal + photos with delete ***/
let currentNoteDay=1;
function openNotes(d){
  currentNoteDay=Number(d);
  notesTitle.textContent = `${t('notes')} ‚Äì ${fmtMonth(currentMonth)} ${d}, ${currentYear}`;
  notesArea.value = localStorage.getItem(noteKey(d)) || "";
  renderPhotoGrid(d);
  notesModal.classList.add("open");
}
function closeNotesModal(){notesModal.classList.remove("open")}
closeNotes.onclick=closeNotesModal;
saveNotes.onclick=()=>{localStorage.setItem(noteKey(currentNoteDay), notesArea.value); saveData(); closeNotesModal()}
photosInput.onchange=async (e)=>{await addFilesToDay(currentNoteDay, e.target.files)};

function renderPhotoGrid(day){
  const arr=JSON.parse(localStorage.getItem(photoKey(day))||"[]");
  photoGrid.innerHTML = arr.map((src,i)=>`
    <div class="thumb">
      <img src="${src}" alt="photo ${i+1}">
      <button title="Ta bort" data-del="${i}">‚úñ</button>
    </div>`).join("");
  photoGrid.onclick=(e)=>{
    const b=e.target.closest("[data-del]"); if(!b) return;
    const idx=Number(b.dataset.del); const arr=JSON.parse(localStorage.getItem(photoKey(day))||"[]");
    arr.splice(idx,1); localStorage.setItem(photoKey(day), JSON.stringify(arr));
    renderPhotoGrid(day); updatePhotoBubbles();
  };
}

/*** Foto-hj√§lpare ***/
async function addPhotos(day,{capture}){
  const input=document.createElement('input');
  input.type='file'; input.accept='image/*'; input.multiple=true;
  if(capture){ input.setAttribute('capture','environment') }
  input.onchange=async ev=>{ await addFilesToDay(day, ev.target.files); if(Number(day)===currentNoteDay) renderPhotoGrid(day) };
  input.click();
}
function updatePhotoBubbles(){
  const dcount=daysInMonth(currentYear,currentMonth);
  for(let d=1; d<=dcount; d++){
    const arr=JSON.parse(localStorage.getItem(photoKey(d))||"[]");
    const b=document.getElementById('pb-'+d); if(!b) continue;
    if(arr.length){b.style.display='grid'; b.textContent=arr.length}else{b.style.display='none'}
  }
}
async function addFilesToDay(day,fileList){
  const prev=JSON.parse(localStorage.getItem(photoKey(day))||"[]");
  const files=[...fileList].slice(0,10-prev.length);
  for(const f of files){ const data=await fileToDataURL(f,1600); prev.push(data) }
  localStorage.setItem(photoKey(day), JSON.stringify(prev));
  updatePhotoBubbles();
}

/*** Share / QR ***/
function openShare(){
  const url=location.href;
  qrImg.src=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;
  mailLink.href=`mailto:?subject=${encodeURIComponent(t('appTitle'))}&body=${encodeURIComponent(url)}`;
  waLink.href=`https://wa.me/?text=${encodeURIComponent(url)}`;
  shareModal.classList.add("open");
}
function closeShareModal(){shareModal.classList.remove("open")}
shareBtn.onclick=openShare; closeShare.onclick=closeShareModal;
nativeShare.onclick=async()=>{
  try{
    if(navigator.share){ await navigator.share({title:t('appTitle'), text:company, url:location.href}); }
    else{ await navigator.clipboard.writeText(location.href) }
  }catch(e){ log("Share abgebrochen") }
};
copyLink.onclick=async()=>{await navigator.clipboard.writeText(location.href); copyLink.textContent="‚úîÔ∏è"; setTimeout(()=>copyLink.textContent="üîó "+t('copyLink'),800)}
printBtn.onclick=()=>window.print();

/*** Logo input + tema ***/
logoFile.onchange=async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  logoData = await fileToDataURL(f,512); S.logoData=logoData; localStorage.setItem("tnh_settings", JSON.stringify(S)); applyLogo();
}
clearLogo.onclick=()=>{logoData=""; S.logoData=""; localStorage.setItem("tnh_settings", JSON.stringify(S)); applyLogo()}

brandHex.oninput=()=>{ setTheme(brandHex.value) }
brandPick.oninput=()=>{ brandHex.value=brandPick.value; setTheme(brandPick.value) }

/*** Bind settings controls ***/
langSel.onchange=()=>{ currentLang=langSel.value; applyLanguage() }
monthSel.onchange=()=>{ currentMonth=Number(monthSel.value); applyLanguage(); buildRows() }
yearSel.onchange=()=>{ currentYear=Number(yearSel.value); applyLanguage(); buildRows() }
autosaveSel.onchange=()=>{ autosave=autosaveSel.value }
wmToggleSel.onchange=()=>{ wmOn=wmToggleSel.value; applyLogo() }
wmOpacity.oninput=()=>{ wmAlpha=Number(wmOpacity.value); applyLogo() }
companyInput.oninput=()=>{ company=companyInput.value; titleTxt.textContent=company?company:t('appTitle') }
debugToggle.onchange=()=>{ dbg=debugToggle.value; if(dbg==="on") debugPanel.classList.add("show"); else debugPanel.classList.remove("show"); }

/*** File -> dataURL downscale ***/
function fileToDataURL(file,maxSide){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onerror=reject;
    reader.onload=()=>{
      const img=new Image();
      img.onload=()=>{
        const c=document.createElement('canvas');
        let {width:w,height:h}=img; const m=Math.max(w,h);
        if(m>maxSide){const k=maxSide/m; w=Math.round(w*k); h=Math.round(h*k)}
        c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        resolve(c.toDataURL('image/jpeg',0.85));
      };
      img.src=reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/*** Signatures ***/
function loadSignature(which){
  const k = which==="emp" ? empSigKey() : mgrSigKey();
  return localStorage.getItem(k)||"";
}
function loadSigDate(which){
  const k = which==="emp" ? empDateKey() : mgrDateKey();
  return localStorage.getItem(k)||"";
}
function saveSignature(which, dataUrl){
  localStorage.setItem(which==="emp"?empSigKey():mgrSigKey(), dataUrl);
  const dateStr = new Date().toLocaleString();
  localStorage.setItem(which==="emp"?empDateKey():mgrDateKey(), dateStr);
  if(which==="emp"){ empThumb.src=dataUrl; empDate.textContent=dateStr; }
  else{ mgrThumb.src=dataUrl; mgrDate.textContent=dateStr; }
}

let signCtx, drawing=false, sigWho="emp", scale=1, rect=null;
function openSignModal(which){
  sigWho=which;
  signTitle.textContent = which==="emp" ? t('empSig') : t('mgrSig');
  signModal.classList.add("open");
  setupCanvas();
  // If existing signature, load into pad as background (optional). We keep pad empty to avoid overwriting; thumb shows current.
}
function closeSignModal(){ signModal.classList.remove("open") }

function setupCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssW = signPad.clientWidth;
  const cssH = 260;
  signPad.width = Math.floor(cssW * dpr);
  signPad.height = Math.floor(cssH * dpr);
  signPad.style.height = cssH+"px";
  signCtx = signPad.getContext('2d');
  signCtx.scale(dpr,dpr);
  signCtx.fillStyle="#fff"; signCtx.fillRect(0,0,cssW,cssH);
  signCtx.lineWidth=2; signCtx.lineCap="round"; signCtx.strokeStyle="#111";
  rect = signPad.getBoundingClientRect();
}

function startDraw(x,y){ drawing=true; signCtx.beginPath(); signCtx.moveTo(x,y) }
function moveDraw(x,y){ if(!drawing) return; signCtx.lineTo(x,y); signCtx.stroke() }
function endDraw(){ drawing=false }

function getPos(e){
  const r=signPad.getBoundingClientRect();
  if(e.touches && e.touches[0]) return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top};
  return {x:e.clientX-r.left, y:e.clientY-r.top};
}

signPad.addEventListener('mousedown',e=>{const p=getPos(e); startDraw(p.x,p.y)});
signPad.addEventListener('mousemove',e=>{const p=getPos(e); moveDraw(p.x,p.y)});
['mouseup','mouseleave'].forEach(ev=>signPad.addEventListener(ev, endDraw));
signPad.addEventListener('touchstart',e=>{const p=getPos(e); startDraw(p.x,p.y); e.preventDefault()},{passive:false});
signPad.addEventListener('touchmove',e=>{const p=getPos(e); moveDraw(p.x,p.y); e.preventDefault()},{passive:false});
signPad.addEventListener('touchend',endDraw);

signClear.onclick=()=>{ setupCanvas() }
signSave.onclick=()=>{
  const dataUrl = signPad.toDataURL('image/png');
  saveSignature(sigWho, dataUrl);
  closeSignModal();
}

empOpen.onclick=()=>openSignModal("emp");
mgrOpen.onclick=()=>openSignModal("mgr");
empClear.onclick=()=>{ localStorage.removeItem(empSigKey()); localStorage.removeItem(empDateKey()); empThumb.src=""; empDate.textContent="" }
mgrClear.onclick=()=>{ localStorage.removeItem(mgrSigKey()); localStorage.removeItem(mgrDateKey()); mgrThumb.src=""; mgrDate.textContent="" }
closeSign.onclick=closeSignModal;

/*** Init ***/
function init(){
  // Theme
  brandHex.value=themeHex; brandPick.value=themeHex; setTheme(themeHex);

  companyInput.value=company; titleTxt.textContent=company||t('appTitle');
  langSel.value=currentLang; autosaveSel.value=autosave;
  wmToggleSel.value=wmOn; wmOpacity.value=wmAlpha; debugToggle.value=dbg;
  if(dbg==="on") debugPanel.classList.add("show");

  fillMonthYear(); applyLanguage(); applyLogo(); buildRows(); computeAll();

  // drag-to-scroll (desktop)
  const scroller=document.getElementById("hScroll");
  let startX,scrollLeft,isDown=false;
  scroller.addEventListener('mousedown',e=>{isDown=true; startX=e.pageX-scroller.offsetLeft; scrollLeft=scroller.scrollLeft});
  ['mouseleave','mouseup'].forEach(ev=>scroller.addEventListener(ev,()=>isDown=false));
  scroller.addEventListener('mousemove',e=>{ if(!isDown) return; e.preventDefault(); const x=e.pageX-scroller.offsetLeft; const walk=(x-startX)*1; scroller.scrollLeft=scrollLeft-walk });

  // Load signatures (thumbs + dates)
  const emp = loadSignature("emp"); if(emp) empThumb.src=emp;
  const mgr = loadSignature("mgr"); if(mgr) mgrThumb.src=mgr;
  const ed = loadSigDate("emp"); if(ed) empDate.textContent=ed;
  const md = loadSigDate("mgr"); if(md) mgrDate.textContent=md;

  log("Init ok");
}
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
