<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Th√ºringer Tannenhof ‚Äì Stundennachweis</title>
<style>
:root{
  --brand:#1f5634; --bg:#eef6f1; --text:#0f172a;
  --card:#ffffff; --muted:#f2f7f4; --line:#e2e8e4;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
/* HEADER */
header{position:sticky;top:0;z-index:20;background:var(--brand);color:#fff;
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
header .left{display:flex;align-items:center;gap:10px}
#brandmark{width:36px;height:36px;border-radius:50%;background:#fff;color:var(--brand);
  font-weight:800;display:grid;place-items:center;background-size:cover;background-position:center}
header .actions{display:flex;gap:10px}
header .actions button{background:#fff;border:0;border-radius:14px;padding:10px 16px;
  font-weight:800;color:#111;width:140px}
/* MAIN */
main{padding:12px;max-width:980px;margin:auto;padding-bottom:160px}
.toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:var(--card);
  border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.08);padding:10px;margin-bottom:10px}
.toolbar .block{background:#f6faf7;border-radius:8px;padding:8px 12px;font-weight:700}
/* TABELL */
.sheet{background:var(--card);border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.08);overflow:hidden}
.thead,.row{display:grid;align-items:center;gap:8px;
  grid-template-columns:72px 120px 120px 84px 1fr 70px}
.thead{background:var(--muted);font-weight:800;padding:10px}
.row{padding:10px;border-top:1px solid var(--line)}
.row.today{outline:2px solid #cde6d5;background:#f9fefb}
.cell{display:flex;align-items:center}
input[type="time"],input[type="number"],input[type="text"]{
  width:100%;height:42px;padding:8px 10px;border:1px solid #d6ded9;border-radius:8px;font-size:16px;background:#fff}
input[type="number"]{appearance:textfield}
.tiny{width:44px;height:44px;border:0;border-radius:10px;background:var(--brand);color:#fff;font-size:20px}
.tiny.has{outline:2px solid #9ad1aa}
.note-chip{max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#334}
/* FAB & PANEL */
.fab{position:fixed;left:18px;bottom:18px;background:var(--brand);color:#fff;width:64px;height:64px;
  border:0;border-radius:18px;font-size:26px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:30}
.panel{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:20px;border-top-right-radius:20px;
  padding:16px;box-shadow:0 -10px 30px rgba(0,0,0,.3);display:none;z-index:40}
.panel.show{display:block}
.panel h3{margin:0 0 6px 0}
.panel .theme button{border:0;border-radius:8px;padding:8px 14px;margin:4px;color:#fff;font-weight:800}
.theme .g{background:#1f5634}.theme .l{background:#d1d5db;color:#111}.theme .d{background:#111}
select, .panel input[type="range"]{width:100%;margin:6px 0 12px}
/* MODALS */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:60}
.modal .box{background:#fff;margin:8dvh auto;max-width:640px;border-radius:16px;padding:14px}
.modal.show{display:block}
textarea{width:100%;min-height:160px;padding:10px;border:1px solid #d6ded9;border-radius:10px;font-size:16px}
.modal .rowbtns{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.modal .rowbtns button{border:0;border-radius:10px;padding:10px 14px;font-weight:800}
.btn{background:var(--brand);color:#fff}.btn.ghost{background:#eef2f1;color:#111}
/* Watermark */
.wm{position:fixed;bottom:14px;right:12px;opacity:.4;pointer-events:none}
.wm img{max-width:220px;max-height:160px;opacity:var(--wm-alpha,.4)}
/* Small helpers */
.hidden{display:none}
@media (max-width:420px){
  .thead,.row{grid-template-columns:60px 110px 110px 72px 1fr 64px}
}
</style>
</head>
<body>
<header>
  <div class="left">
    <div id="brandmark">TN</div>
    <div><strong id="titleA">Th√ºringer Tannenhof</strong><div id="titleB">‚Äì <span data-i18n="tidsrapport">Stundennachweis</span></div></div>
  </div>
  <div class="actions">
    <button id="shareBtn" data-i18n="dela">Teilen / Senden</button>
    <button id="pdfBtn" data-i18n="pdf">PDF</button>
  </div>
</header>

<main>
  <div class="toolbar">
    <div class="block">‚è≥ <span data-i18n="totalt">Gesamt</span>: <span id="total">0.00</span></div>
    <div class="block"><span data-i18n="manad">Monat</span>: <span id="month"></span></div>
    <button id="prev">¬´</button>
    <button id="next">¬ª</button>
    <button id="clear" title="Rensa denna m√•nad">üóë</button>
  </div>

  <div class="sheet" id="sheet">
    <div class="thead">
      <div data-i18n="dag">Tag</div>
      <div data-i18n="fran">Von</div>
      <div data-i18n="till">Bis</div>
      <div data-i18n="paus">Pause</div>
      <div data-i18n="anteckn">Notiz</div>
      <div data-i18n="foto">Foto</div>
    </div>
    <div id="rows"></div>
  </div>
</main>

<!-- Settings -->
<button class="fab" id="gear">‚öôÔ∏è</button>
<div class="panel" id="settings">
  <h3 data-i18n="install">Einstellungen</h3>
  <label data-i18n="valjlogga">Logo w√§hlen (PNG/JPG)</label>
  <input type="file" id="logo" accept="image/*"><br>
  <label data-i18n="sprak">Sprache</label>
  <select id="lang">
    <option value="sv">Svenska</option>
    <option value="de">Deutsch</option>
    <option value="en">English</option>
  </select>
  <label data-i18n="vatten">Wasserzeichen</label>
  <div><input type="checkbox" id="wmOn" checked> <span data-i18n="synlig">Sichtbar</span></div>
  <div style="margin-top:6px">
    <label data-i18n="genom">Transparenz</label>
    <input type="range" id="wmAlpha" min="0" max="100" value="40"><span id="alphaVal">40%</span>
  </div>
  <h4 data-i18n="tema">Farbschema</h4>
  <div class="theme">
    <button class="g" data-t="green">üå≤</button>
    <button class="l" data-t="light">‚òÄÔ∏è</button>
    <button class="d" data-t="dark">üåë</button>
  </div>
  <div style="margin-top:8px">
    <button id="closeSet" class="btn" data-i18n="stang">Schlie√üen</button>
  </div>
</div>

<!-- Note modal -->
<div class="modal" id="noteModal">
  <div class="box">
    <h3><span data-i18n="anteckn">Notiz</span> ‚Äì <span id="noteDay"></span></h3>
    <textarea id="noteText" placeholder="Notiz schreiben‚Ä¶"></textarea>
    <div class="rowbtns">
      <button class="ghost btn" id="noteDel" data-i18n="radera">L√∂schen</button>
      <button class="btn" id="noteSave" data-i18n="spara">Speichern</button>
    </div>
  </div>
</div>

<!-- Watermark -->
<div class="wm"><img id="wmImg" alt=""></div>

<script>
/* ======= I18N ======= */
const I18N = {
  sv:{pdf:"PDF",tidsrapport:"Tidsrapport",dela:"Dela / Skicka",totalt:"Totalt",manad:"M√•nad",dag:"Dag",fran:"Fr√•n",till:"Till",paus:"Paus",anteckn:"Anteckn.",foto:"Foto",install:"Inst√§llningar",valjlogga:"V√§lj logga (PNG/JPG)",sprak:"Spr√•k",vatten:"Vattenst√§mpel",synlig:"Synlig",genom:"Genomskinlighet",tema:"F√§rgtema",stang:"St√§ng",radera:"Radera",spara:"Spara",confirm_clear:"Rensa denna m√•nad?",confirm_del_photo:"Radera foto?"},
  de:{pdf:"PDF",tidsrapport:"Stundennachweis",dela:"Teilen / Senden",totalt:"Gesamt",manad:"Monat",dag:"Tag",fran:"Von",till:"Bis",paus:"Pause",anteckn:"Notiz",foto:"Foto",install:"Einstellungen",valjlogga:"Logo w√§hlen (PNG/JPG)",sprak:"Sprache",vatten:"Wasserzeichen",synlig:"Sichtbar",genom:"Transparenz",tema:"Farbschema",stang:"Schlie√üen",radera:"L√∂schen",spara:"Speichern",confirm_clear:"Diesen Monat l√∂schen?",confirm_del_photo:"Foto l√∂schen?"},
  en:{pdf:"PDF",tidsrapport:"Timesheet",dela:"Share / Send",totalt:"Total",manad:"Month",dag:"Day",fran:"From",till:"To",paus:"Break",anteckn:"Notes",foto:"Photo",install:"Settings",valjlogga:"Pick logo (PNG/JPG)",sprak:"Language",vatten:"Watermark",synlig:"Visible",genom:"Opacity",tema:"Theme",stang:"Close",radera:"Delete",spara:"Save",confirm_clear:"Clear this month?",confirm_del_photo:"Delete photo?"}
};
// Default: DE + green theme
let LANG = localStorage.getItem('lang') || 'de';
function tr(){
  const t = I18N[LANG];
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.dataset.i18n; if(t[k]) el.textContent = t[k];
  });
  document.documentElement.lang = LANG;
}
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
$('#lang').value = LANG;
$('#lang').onchange = e=>{LANG=e.target.value;localStorage.setItem('lang',LANG);tr();};

/* ======= HELPERS ======= */
let month = new Date(); month.setDate(1);
const key=()=>`tt-${month.getFullYear()}-${month.getMonth()+1}`;
const load=()=>JSON.parse(localStorage.getItem(key())||'{}');
const save=o=>localStorage.setItem(key(),JSON.stringify(o));
const days=()=>new Date(month.getFullYear(),month.getMonth()+1,0).getDate();

/* ======= RENDER ======= */
function render(){
  tr();
  $('#month').textContent = month.toLocaleDateString(LANG, {month:'long', year:'numeric'});
  const data=load();
  const cont=$('#rows'); cont.innerHTML='';
  const today = new Date();
  const sameMonth = today.getMonth()===month.getMonth() && today.getFullYear()===month.getFullYear();

  for(let i=1;i<=days();i++){
    const rec=data[i]||{};
    const row=document.createElement('div');
    row.className='row';
    if(sameMonth && i===today.getDate()) row.classList.add('today');

    const fileId = `file-${i}`;
    row.innerHTML = `
      <div class="cell">${i}</div>
      <div class="cell"><input type="time" id="f${i}" value="${rec.f||''}"></div>
      <div class="cell"><input type="time" id="t${i}" value="${rec.t||''}"></div>
      <div class="cell"><input type="number" id="p${i}" min="0" step="1" value="${rec.p??0}"></div>
      <div class="cell">
         <button class="tiny ${rec.n?'has':''}" id="note-${i}" title="Notiz">üìù</button>
         <div class="note-chip" id="note-chip-${i}">${rec.n?escapeHtml(rec.n):''}</div>
      </div>
      <div class="cell">
         <input class="hidden" id="${fileId}" type="file" accept="image/*" capture="environment">
         <button class="tiny ${rec.img?'has':''}" id="cam-${i}" title="Foto">üì∑</button>
      </div>`;
    cont.append(row);

    ['f','t','p'].forEach(k=>{
      row.querySelector(`#${k}${i}`).addEventListener('change',()=>updateDay(i));
    });
    row.querySelector(`#note-${i}`).onclick=()=>openNote(i);
    row.querySelector(`#cam-${i}`).onclick=()=>$('#'+fileId).click();
    row.querySelector('#'+fileId).onchange=e=>handleFile(i,e.target.files[0]);
  }
  calc();
}

/* ======= UPDATE / CALC ======= */
function updateDay(i,extra={}){
  const data=load(); const rec=data[i]||{};
  ['f','t','p'].forEach(k=>{
    const el = document.getElementById(k+i);
    if(el) rec[k] = el.value;
  });
  Object.assign(rec,extra);
  data[i]=rec; save(data); calc();
}
function calc(){
  const data=load(); let min=0;
  Object.values(data).forEach(v=>{
    if(v.f && v.t){
      const [fh,fm]=v.f.split(':').map(Number);
      const [th,tm]=v.t.split(':').map(Number);
      let d=(th*60+tm)-(fh*60+fm)-(+v.p||0);
      if(d>0) min+=d;
    }
  });
  $('#total').textContent=(min/60).toFixed(2);
}

/* ======= NOTES ======= */
let noteDay=0;
function openNote(i){
  noteDay=i; $('#noteDay').textContent=i;
  const data=load()[i]||{};
  $('#noteText').value = data.n||'';
  $('#noteModal').classList.add('show');
}
$('#noteSave').onclick=()=>{
  updateDay(noteDay,{n:$('#noteText').value});
  $('#noteModal').classList.remove('show');
  const v=$('#noteText').value;
  const chip=$(`#note-chip-${noteDay}`); if(chip){chip.textContent=v;}
  const b=$(`#note-${noteDay}`); if(b){b.classList.toggle('has',!!v);}
};
$('#noteDel').onclick=()=>{
  $('#noteText').value=''; $('#noteSave').click();
};
$('#noteModal').addEventListener('click',e=>{ if(e.target.id==='noteModal') e.currentTarget.classList.remove('show'); });

/* ======= PHOTOS ======= */
async function handleFile(i,file){
  if(!file) return;
  const url = await fileToBase64(file);
  updateDay(i,{img:url});
  const btn=$(`#cam-${i}`); if(btn) btn.classList.add('has');
  btn.oncontextmenu=(e)=>{e.preventDefault(); if(confirm(I18N[LANG].confirm_del_photo)){updateDay(i,{img:null}); btn.classList.remove('has');}};
}
function fileToBase64(f){return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(f);});}

/* ======= NAV / CLEAR ======= */
$('#prev').onclick=()=>{month.setMonth(month.getMonth()-1);render();}
$('#next').onclick=()=>{month.setMonth(month.getMonth()+1);render();}
$('#clear').onclick=()=>{ if(confirm(I18N[LANG].confirm_clear)){localStorage.removeItem(key());render();} };

/* ======= SHARE & PDF ======= */
$('#pdfBtn').onclick=()=>window.print();
$('#shareBtn').onclick=async ()=>{
  const txt=exportText();
  if(navigator.share){
    try{await navigator.share({title:I18N[LANG].tidsrapport,text:txt});}catch(e){}
  }else{
    const mail='mailto:?subject=' + encodeURIComponent(I18N[LANG].tidsrapport) + '&body='+encodeURIComponent(txt);
    location.href=mail;
  }
};
function exportText(){
  const data=load(); const lines=[];
  lines.push(`${I18N[LANG].tidsrapport} ‚Äì ${month.toLocaleDateString(LANG,{month:'long',year:'numeric'})}`);
  for(let i=1;i<=days();i++){
    const v=data[i]; if(!v) continue;
    const row = `${i}: ${v.f||''}-${v.t||''}  (${v.p||0} ${I18N[LANG].paus.toLowerCase()})${v.n?`  ‚Äì ${v.n}`:''}`;
    lines.push(row);
  }
  lines.push(`${I18N[LANG].totalt}: ${$('#total').textContent} h`);
  return lines.join('\n');
}

/* ======= THEME, LOGO, WATERMARK ======= */
function setTheme(t){
  if(t==='green'){setVars('#1f5634','#eef6f1','#0f172a');}
  if(t==='light'){setVars('#c0d9c3','#fafafa','#111');}
  if(t==='dark'){setVars('#0a0a0a','#1a1a1a','#eee');}
  localStorage.setItem('theme',t);
}
function setVars(brand,bg,text){
  const r=document.documentElement.style;
  r.setProperty('--brand',brand); r.setProperty('--bg',bg); r.setProperty('--text',text);
}
$$('.theme button').forEach(b=>b.onclick=()=>setTheme(b.dataset.t));

$('#gear').onclick=()=>$('#settings').classList.add('show');
$('#closeSet').onclick=()=>$('#settings').classList.remove('show');

$('#logo').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  const b=await fileToBase64(f);
  localStorage.setItem('logo',b);
  applyLogo(b);
};
function applyLogo(b){
  if(b){ $('#brandmark').style.backgroundImage=`url(${b})`;
         $('#brandmark').style.color='transparent';
         $('#wmImg').src=b; }
}
$('#wmOn').onchange=()=>{$('.wm').style.display=$('#wmOn').checked?'block':'none';}
$('#wmAlpha').oninput=()=>{document.documentElement.style.setProperty('--wm-alpha', $('#wmAlpha').value/100); $('#alphaVal').textContent=$('#wmAlpha').value+'%';}

/* ======= INIT ======= */
function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));}
(function init(){
  // default theme = green
  const t=localStorage.getItem('theme')||'green'; setTheme(t);
  const logo=localStorage.getItem('logo'); if(logo) applyLogo(logo);
  const opa=(+localStorage.getItem('wmAlpha')||40); $('#wmAlpha').value=opa; $('#alphaVal').textContent=opa+'%'; document.documentElement.style.setProperty('--wm-alpha', opa/100);
  $('#wmAlpha').addEventListener('change',()=>localStorage.setItem('wmAlpha',$('#wmAlpha').value));
  render();
})();
</script>
</body>
</html>
