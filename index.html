<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Th√ºringer Tannenhof ‚Äì Stundennachweis / Tidrapport</title>
<style>
  :root{
    --bg:#f3fbf6; --ink:#0f2c1b; --muted:#5b6d66;
    --surface:#ffffff; --card:#e9f4ed; --accent:#17643a; --accent-2:#0f4a2b;
    --ok:#0b7b3b; --warn:#bb3a3a; --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:40;color:#fff;background:linear-gradient(180deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
  .bar{display:flex;align-items:center;gap:12px;padding:12px 14px}
  .brand{display:flex;align-items:center;gap:10px;min-width:0}
  .logo{width:28px;height:28px;border-radius:8px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tools{margin-left:auto;display:flex;gap:8px}
  .btn{border:0;border-radius:16px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
  .btn.white{background:#fff;color:#111}
  .btn.dark{background:#0f2b1b;color:#fff}
  main{max-width:980px;margin:16px auto;padding:0 12px}
  .panel{background:var(--card);border-radius:18px;padding:12px 14px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .sum{font-size:22px;font-weight:900}
  .chip{background:#fff;border:1px solid #0001;border-radius:14px;padding:8px 10px;font-weight:700}
  .mnav{display:flex;gap:8px}
  .icon{border:0;border-radius:12px;width:42px;height:42px;display:grid;place-items:center;background:var(--accent);color:#fff;box-shadow:var(--shadow);cursor:pointer}
  .sheet{background:var(--surface);border-radius:20px;margin-top:12px;box-shadow:var(--shadow);overflow:hidden}
  .thead{position:sticky;top:64px;background:#e6f1ea;z-index:20;display:grid;grid-template-columns:68px 1fr 1fr 94px 88px 136px;gap:8px;padding:8px 10px;font-weight:900}
  .row{display:grid;grid-template-columns:68px 1fr 1fr 94px 88px 136px;gap:8px;padding:8px 10px;align-items:center;border-top:1px solid #00000010}
  .row:nth-child(odd){background:#f7fbf8}
  .day{font-weight:900;text-align:center}
  .pill{background:#fff;border:1px solid #00000015;border-radius:14px;min-height:44px;display:flex;align-items:center;padding:0 10px}
  input[type="time"],input[type="number"],input[type="text"]{width:100%;border:0;outline:none;background:transparent;font-weight:700;color:var(--ink);font-size:16px}
  input[type="number"]{text-align:center}
  .totalBox{font-weight:900;text-align:center;background:#fff;border:1px solid #0001;border-radius:12px;min-height:44px;display:grid;place-items:center}
  .act{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;align-items:center}
  .mini{border:0;border-radius:12px;padding:10px;background:var(--accent);color:#fff;cursor:pointer;box-shadow:var(--shadow)}
  .mini.gray{background:#86938c}
  .pcount{font-weight:900;margin-left:4px;background:#fff;color:#0f2c1b;border:1px solid #0002;border-radius:10px;padding:3px 6px}
  .today{outline:3px solid var(--ok);outline-offset:-3px;border-radius:12px}
  .foot{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;color:#54676b;font-weight:800;background:#fff}
  .fab{position:fixed;left:16px;bottom:16px;width:64px;height:64px;border-radius:18px;background:var(--accent);color:#fff;display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer;z-index:50}
  dialog{border:0;border-radius:18px;box-shadow:0 28px 80px rgba(0,0,0,.35);max-width:640px;width:calc(100% - 24px);padding:0;background:#fff}
  .dlg-h{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #0001;font-weight:900}
  .dlg-b{padding:16px}
  .grid{display:grid;gap:12px}
  .grid.two{grid-template-columns:1fr 1fr}
  .field, select, input[type="file"], input[type="range"]{width:100%;padding:10px;border:1px solid #0002;border-radius:12px;background:#fff;font-weight:700}
  .help{font-size:13px;color:#5e6d67}
  @media print{
    header,.fab,.tools,.act .mini.view,.act .mini.photo,.dlg-h button,.dlg-b button,#shareDlg,#signDlg,#settingsDlg{display:none !important}
    body{background:#fff}
    main{margin:0;padding:0;max-width:100%}
    .sheet{border-radius:0;box-shadow:none}
    .thead{top:0}
    body::after{
      content:"Th√ºringer Tannenhof ‚Ä¢ Wittchenstein 6, 07819 Geroda ‚Ä¢ Deutschland";
      position:fixed; top:8px; left:0; right:0; text-align:center; font-weight:800; color:#222;
    }
    body.print-wm::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background-repeat:no-repeat; background-position:center; background-size:90%;
      transform:rotate(-24deg);
      opacity:var(--wm-opacity,.12);
    }
    #signSection{display:block !important; page-break-inside:avoid; margin-top:14px; border-top:2px solid #0002; padding-top:8px;}
    .sigbox{display:inline-block; width:48%; vertical-align:top}
    .sigline{border-top:2px solid #000; height:64px; margin-top:6px}
    .siglabel{font-weight:800}
    .sigimg{max-width:100%; max-height:80px; display:block}
    .sigmeta{font-size:12px; color:#333}
  }
  #signSection{display:none}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <div class="logo"><img id="brandLogo" alt="Logo"></div>
      <div class="title" id="appTitle">Th√ºringer Tannenhof ‚Äì Tidrapport</div>
    </div>
    <div class="tools">
      <button class="btn white" id="shareOpen">Dela</button>
      <button class="btn dark" id="pdfBtn">PDF</button>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div class="chip" id="sumLabel">Totalt ‚Äì</div>
      <div class="sum" id="sumHours">0.00</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div class="mnav">
        <button class="icon" id="prevM">‚Äπ</button>
        <button class="icon" id="nextM">‚Ä∫</button>
      </div>
      <div class="chip" id="monthName"></div>
      <button class="btn" id="signOpen">‚úçÔ∏è Signaturer</button>
    </div>
  </section>

  <section class="sheet">
    <div class="thead">
      <div id="thDay">Dag</div>
      <div id="thFrom">Fr√•n</div>
      <div id="thTo">Till</div>
      <div id="thPause">Paus</div>
      <div id="thDaily">Total</div>
      <div id="thAct">Aktion</div>
    </div>
    <div id="rows"></div>
    <div class="foot"><span id="footLabel">M√•nadssumma</span><span id="footSum">0.00</span></div>
  </section>

  <!-- Signaturer (visas √§ven i print) -->
  <section id="signSection" class="sheet" style="background:#fff; border-radius:20px; box-shadow:var(--shadow); padding:10px 12px; margin-top:12px;">
    <div class="sigbox">
      <div class="siglabel" id="sigEmpLabel">Anst√§lld</div>
      <img id="sigEmpImg" class="sigimg">
      <div class="sigline"></div>
      <div class="sigmeta" id="sigEmpMeta"></div>
    </div>
    <div class="sigbox" style="float:right">
      <div class="siglabel" id="sigSupLabel">Chef/Arbetsledare</div>
      <img id="sigSupImg" class="sigimg">
      <div class="sigline"></div>
      <div class="sigmeta" id="sigSupMeta"></div>
    </div>
    <div style="clear:both"></div>
  </section>
</main>

<button class="fab" id="openSettings">‚öôÔ∏è</button>

<!-- Settings -->
<dialog id="settingsDlg">
  <div class="dlg-h"><div id="dlgSettingsTitle">Inst√§llningar</div><button class="btn" onclick="settingsDlg.close()">St√§ng</button></div>
  <div class="dlg-b">
    <div class="grid two">
      <div>
        <label for="langSel">Spr√•k</label>
        <select id="langSel" class="field">
          <option value="sv">Svenska</option>
          <option value="de">Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>
      <div>
        <label>Vattenst√§mpel i PDF</label>
        <div class="help" id="wmHelp">Diagonal, justerbar styrka</div>
        <input type="range" id="wmRange" min="0" max="100" value="12">
      </div>
    </div>
    <div class="grid two" style="margin-top:8px">
      <div>
        <label for="logoFile">F√∂retagslogga (PDF & topp)</label>
        <input type="file" id="logoFile" accept="image/*" class="field">
        <div class="help" id="logoHelp">Om inget v√§ljs anv√§nds Tannenhofs logga</div>
      </div>
      <div>
        <label for="addrInput">Adresshuvud (PDF)</label>
        <input id="addrInput" class="field" type="text"
               placeholder="Th√ºringer Tannenhof ‚Ä¢ Wittchenstein 6, 07819 Geroda ‚Ä¢ Deutschland">
      </div>
    </div>
    <div style="margin-top:8px">
      <button class="btn dark" id="saveCfg">Spara</button>
    </div>
  </div>
</dialog>

<!-- Kamera/galleri -->
<dialog id="camDlg">
  <div class="dlg-h"><div id="camTitle">Foton f√∂r dag</div><button class="btn" onclick="camDlg.close()">St√§ng</button></div>
  <div class="dlg-b">
    <div class="grid">
      <button class="btn" id="takePhoto">üì∏ Ta foto med kamera</button>
      <button class="btn" id="pickPhoto">üñºÔ∏è V√§lj fr√•n galleri</button>
      <button class="btn" id="viewPhoto">üëÅÔ∏è Visa bilder</button>
    </div>
  </div>
</dialog>

<!-- Projekt & anteckningar -->
<dialog id="editDlg">
  <div class="dlg-h"><div id="editDlgTitle">Dag</div><button class="btn" onclick="editDlg.close()">St√§ng</button></div>
  <div class="dlg-b">
    <div class="grid">
      <div>
        <label id="projLabel">Projekt/plats</label>
        <input id="projInput" class="field" type="text">
      </div>
      <div>
        <label id="notesLabel">Anteckningar</label>
        <textarea id="notesInput" class="field" rows="5" placeholder=""></textarea>
      </div>
      <div><button class="btn dark" id="saveNote">Spara</button></div>
    </div>
  </div>
</dialog>

<!-- Galleri -->
<dialog id="galDlg">
  <div class="dlg-h"><div id="galTitle">Bilder</div><button class="btn" onclick="galDlg.close()">St√§ng</button></div>
  <div class="dlg-b" id="galBody"></div>
</dialog>

<!-- Signaturer -->
<dialog id="signDlg">
  <div class="dlg-h"><div id="signTitle">Signaturer</div><button class="btn" onclick="signDlg.close()">St√§ng</button></div>
  <div class="dlg-b">
    <div class="grid two">
      <div>
        <label id="empLbl">Anst√§lld</label>
        <canvas id="empSig" width="500" height="160" style="border:1px solid #0002;border-radius:12px;background:#fff"></canvas>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" id="empClear">Rensa</button>
          <input id="empName" class="field" type="text" placeholder="Namn">
        </div>
      </div>
      <div>
        <label id="supLbl">Chef/Arbetsledare</label>
        <canvas id="supSig" width="500" height="160" style="border:1px solid #0002;border-radius:12px;background:#fff"></canvas>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" id="supClear">Rensa</button>
          <input id="supName" class="field" type="text" placeholder="Namn">
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <input id="sigPlace" class="field" type="text" placeholder="Ort" style="max-width:200px">
      <input id="sigDate" class="field" type="date" style="max-width:200px">
      <button class="btn dark" id="sigSave">Spara signaturer</button>
    </div>
  </div>
</dialog>

<!-- Dela -->
<dialog id="shareDlg">
  <div class="dlg-h"><div id="shareTitle">Dela / Skicka</div><button class="btn" onclick="shareDlg.close()">St√§ng</button></div>
  <div class="dlg-b">
    <div class="grid">
      <button class="btn" id="doWebShare">üîó Systemets dela</button>
      <button class="btn" id="doWhats">üü¢ WhatsApp</button>
      <button class="btn" id="doEmail">‚úâÔ∏è E-post</button>
      <button class="btn" id="doCopy">üìã Kopiera text</button>
      <button class="btn dark" id="doPDF">üñ®Ô∏è Skapa PDF / Skriv ut</button>
    </div>
  </div>
</dialog>

<script>
(()=>{
// ===== i18n =====
const T={
 sv:{title:'Th√ºringer Tannenhof ‚Äì Tidrapport', total:'Totalt ‚Äì', day:'Dag', from:'Fr√•n', to:'Till', pause:'Paus', daily:'Total', action:'Aktion',
     monthsum:'M√•nadssumma', settings:'Inst√§llningar', share:'Dela', pdf:'PDF',
     proj:'Projekt/plats', notes:'Anteckningar',
     camTitle:'Foton f√∂r dag', take:'üì∏ Ta foto med kamera', pick:'üñºÔ∏è V√§lj fr√•n galleri', view:'üëÅÔ∏è Visa bilder',
     dlgDay:'Dag', save:'Spara', lang:'Spr√•k',
     wmHelp:'Diagonal vattenst√§mpel i PDF (styrka)', logoHelp:'Om inget v√§ljs anv√§nds Tannenhofs logga',
     copied:'Kopierat till urklipp.',
     monthNames:['januari','februari','mars','april','maj','juni','juli','augusti','september','oktober','november','december'],
     min:'min',
     shareTitle:'Dela / Skicka',
     doWebShare:'üîó Systemets dela', doWhats:'üü¢ WhatsApp', doEmail:'‚úâÔ∏è E-post', doCopy:'üìã Kopiera text', doPDF:'üñ®Ô∏è Skapa PDF / Skriv ut',
     signTitle:'Signaturer', emp:'Anst√§lld', sup:'Chef/Arbetsledare', place:'Ort', date:'Datum', clear:'Rensa', saveSig:'Spara signaturer'
 },
 de:{title:'Th√ºringer Tannenhof ‚Äì Stundennachweis', total:'Gesamt ‚Äì', day:'Tag', from:'Von', to:'Bis', pause:'Pause', daily:'Gesamt', action:'Aktion',
     monthsum:'Monatssumme', settings:'Einstellungen', share:'Teilen', pdf:'PDF',
     proj:'Projekt/Ort', notes:'Notizen',
     camTitle:'Fotos f√ºr Tag', take:'üì∏ Mit Kamera aufnehmen', pick:'üñºÔ∏è Aus Galerie w√§hlen', view:'üëÅÔ∏è Bilder ansehen',
     dlgDay:'Tag', save:'Speichern', lang:'Sprache',
     wmHelp:'Diagonal-Wasserzeichen in PDF (St√§rke)', logoHelp:'Wenn nichts gew√§hlt wird, wird das Tannenhof-Logo genutzt',
     copied:'In die Zwischenablage kopiert.',
     monthNames:['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'],
     min:'Min',
     shareTitle:'Teilen / Senden',
     doWebShare:'üîó System-Share', doWhats:'üü¢ WhatsApp', doEmail:'‚úâÔ∏è E-Mail', doCopy:'üìã In Zwischenablage', doPDF:'üñ®Ô∏è PDF / Drucken',
     signTitle:'Signaturen', emp:'Mitarbeiter', sup:'Vorgesetzter', place:'Ort', date:'Datum', clear:'L√∂schen', saveSig:'Signaturen speichern'
 },
 en:{title:'Th√ºringer Tannenhof ‚Äì Timesheet', total:'Total ‚Äì', day:'Day', from:'From', to:'To', pause:'Break', daily:'Total', action:'Action',
     monthsum:'Monthly total', settings:'Settings', share:'Share', pdf:'PDF',
     proj:'Project/place', notes:'Notes',
     camTitle:'Photos for day', take:'üì∏ Take photo', pick:'üñºÔ∏è Choose from gallery', view:'üëÅÔ∏è View photos',
     dlgDay:'Day', save:'Save', lang:'Language',
     wmHelp:'Diagonal watermark in PDF (strength)', logoHelp:'If none selected, Tannenhof logo is used',
     copied:'Copied to clipboard.',
     monthNames:['January','February','March','April','May','June','July','August','September','October','November','December'],
     min:'min',
     shareTitle:'Share / Send',
     doWebShare:'üîó System Share', doWhats:'üü¢ WhatsApp', doEmail:'‚úâÔ∏è Email', doCopy:'üìã Copy text', doPDF:'üñ®Ô∏è Create PDF / Print',
     signTitle:'Signatures', emp:'Employee', sup:'Supervisor', place:'Place', date:'Date', clear:'Clear', saveSig:'Save signatures'
 }
};

// ===== Storage / state =====
const VER='tt_core_v1_1';
const $=q=>document.querySelector(q);
const rowsEl=$('#rows');
let cfg=loadCfg();
let month=cfg.month||currentYM();
let data=loadData();
let L=T[cfg.lang]||T.sv;

function currentYM(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
function daysIn(ym){const [y,m]=ym.split('-').map(Number);return new Date(y,m,0).getDate();}
function loadCfg(){try{return JSON.parse(localStorage.getItem(VER+'-cfg')||'')}catch{return null}||{lang:'sv',wm:12,logo:null,addr:''};}
function saveCfg(){localStorage.setItem(VER+'-cfg',JSON.stringify(cfg));}
function loadData(){try{return JSON.parse(localStorage.getItem(VER+'-data')||'')}catch{return {}}}
function saveData(){localStorage.setItem(VER+'-data',JSON.stringify(data));}

// Default logo (tre granar)
const defaultLogo='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 160"><rect width="160" height="160" fill="#ffffff"/><g transform="translate(10,10)" fill="#177043"><polygon points="50,0 0,80 100,80"/><polygon points="90,20 40,100 140,100"/><polygon points="70,60 30,130 110,130"/></g></svg>`);

// ===== UI apply =====
function applyLang(){
  L=T[cfg.lang]||T.sv;
  $('#appTitle').textContent=L.title;
  $('#shareOpen').textContent=L.share; $('#pdfBtn').textContent=L.pdf;
  $('#sumLabel').textContent=L.total; $('#thDay').textContent=L.day; $('#thFrom').textContent=L.from;
  $('#thTo').textContent=L.to; $('#thPause').textContent=L.pause; $('#thDaily').textContent=L.daily;
  $('#thAct').textContent=L.action; $('#footLabel').textContent=L.monthsum;
  $('#camTitle').textContent=L.camTitle; $('#takePhoto').textContent=L.take; $('#pickPhoto').textContent=L.pick; $('#viewPhoto').textContent=L.view;
  $('#projLabel').textContent=L.proj; $('#notesLabel').textContent=L.notes; $('#saveNote').textContent=L.save;
  $('#dlgSettingsTitle').textContent=L.settings; $('#wmHelp').textContent=L.wmHelp; $('#logoHelp').textContent=L.logoHelp;
  $('#shareTitle').textContent=L.shareTitle; $('#doWebShare').textContent=L.doWebShare; $('#doWhats').textContent=L.doWhats; $('#doEmail').textContent=L.doEmail; $('#doCopy').textContent=L.doCopy; $('#doPDF').textContent=L.doPDF;
  $('#signTitle').textContent=L.signTitle; $('#empLbl').textContent=L.emp; $('#supLbl').textContent=L.sup;
  $('#sigEmpLabel').textContent=L.emp; $('#sigSupLabel').textContent=L.sup;
}
function applyLogo(){ $('#brandLogo').src=(cfg.logo||defaultLogo); }
function applyMonthName(){ const [y,m]=month.split('-').map(Number); $('#monthName').textContent=`${L.monthNames[m-1]} ${y}`; }

// ===== Build sheet =====
function getRec(d){
  data[month]=data[month]||{};
  data[month][d]=data[month][d]||{from:'',to:'',pause:0,project:'',notes:'',photos:[]};
  return data[month][d];
}
function render(){
  rowsEl.innerHTML='';
  const dcount=daysIn(month);
  const today=new Date();
  const isThisMonth=(month===`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`);

  for(let d=1; d<=dcount; d++){
    const r=getRec(d);
    const row=document.createElement('div'); row.className='row';
    if(isThisMonth && today.getDate()===d) row.classList.add('today');

    const cDay = div('day', String(d).padStart(2,'0'));

    const cFrom=div('pill'); const iFrom=inp('time', r.from||'');
    iFrom.onchange=()=>{r.from=iFrom.value; saveData(); calc();}; cFrom.append(iFrom);

    const cTo=div('pill'); const iTo=inp('time', r.to||'');
    iTo.onchange=()=>{r.to=iTo.value; saveData(); calc();}; cTo.append(iTo);

    const cPause=div('pill'); const iPause=inp('number', r.pause||0); iPause.min='0'; iPause.step='5';
    iPause.onchange=()=>{r.pause=parseInt(iPause.value||0); saveData(); calc();}; cPause.append(iPause);

    const cDaily=div('totalBox'); cDaily.id=`dtotal-${d}`; cDaily.textContent=fmt(0);

    const cAct=div('act');
    const bEdit=mini('üìù',()=>openEdit(d));
    const bCam=mini('üì∑',()=>openCam(d));
    const count=document.createElement('span'); count.className='pcount'; count.id=`pc-${d}`; count.textContent='√ó'+(r.photos?.length||0);
    const bGal=mini('üëÅÔ∏è',()=>openGallery(d));
    cAct.append(bEdit,bCam,count,bGal);

    row.append(cDay,cFrom,cTo,cPause,cDaily,cAct);
    rowsEl.append(row);
  }
  calc();
}
function div(c,t){const e=document.createElement('div'); e.className=c; if(t!=null) e.textContent=t; return e;}
function inp(type,val){const e=document.createElement('input'); e.type=type; if(val!==undefined) e.value=val; return e;}
function mini(lbl,fn){const b=document.createElement('button'); b.className='mini'; b.textContent=lbl; b.onclick=fn; return b;}

function toMin(t){ if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
function fmt(n){ return (n/60).toFixed(2); }

function calc(){
  const dcount=daysIn(month);
  let sum=0;
  for(let d=1; d<=dcount; d++){
    const r=getRec(d);
    let mins=0;
    if(r.from && r.to){
      mins = toMin(r.to)-toMin(r.from)-parseInt(r.pause||0);
      if(mins<0) mins += 24*60;
      if(mins<0) mins=0;
    }
    sum += Math.max(0,mins);
    const box=$(`#dtotal-${d}`); if(box) box.textContent=fmt(Math.max(0,mins));
    updatePhotoCount(d); // ‚Üê h√•ll badge uppdaterad √§ven vid rerender
  }
  const hrs=(sum/60).toFixed(2);
  $('#sumHours').textContent=hrs;
  $('#footSum').textContent=hrs;
}
function updatePhotoCount(day){
  const r=getRec(day);
  const el=$(`#pc-${day}`); if(el) el.textContent='√ó'+(r.photos?.length||0);
}

// ===== Notes / Project =====
let editDay=1;
function openEdit(day){
  editDay=day;
  const r=getRec(day);
  $('#editDlgTitle').textContent=L.dlgDay+' '+String(day).padStart(2,'0');
  $('#projInput').value=r.project||'';
  $('#notesInput').value=r.notes||'';
  editDlg.showModal();
}
$('#saveNote').onclick=()=>{ const r=getRec(editDay); r.project=$('#projInput').value; r.notes=$('#notesInput').value; saveData(); editDlg.close(); };

// ===== Photos =====
let camDay=1;
function openCam(day){ camDay=day; $('#camTitle').textContent=L.camTitle+' '+String(day).padStart(2,'0'); camDlg.showModal(); }
$('#takePhoto').onclick=()=>pickFile(true);
$('#pickPhoto').onclick=()=>pickFile(false);
$('#viewPhoto').onclick=()=>{ camDlg.close(); openGallery(camDay); };

function pickFile(useCamera){
  const inp=document.createElement('input');
  inp.type='file'; inp.accept='image/*'; if(useCamera) inp.capture='environment';
  inp.onchange=async ()=>{
    const f=inp.files?.[0]; if(!f) return;
    const b64=await toBase64Compressed(f,1600);
    const rec=getRec(camDay); rec.photos=rec.photos||[]; rec.photos.push({name:f.name,data:b64}); saveData();
    updatePhotoCount(camDay);
    camDlg.close();
  };
  inp.click();
}
function toBase64Compressed(file,maxSide){
  return new Promise(res=>{
    const fr=new FileReader(); fr.onload=()=>{
      const img=new Image(); img.onload=()=>{
        const c=document.createElement('canvas'), ctx=c.getContext('2d');
        let w=img.width,h=img.height,s=Math.max(w,h);
        if(s>maxSide){const k=maxSide/s; w=Math.round(w*k); h=Math.round(h*k);}
        c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
        res(c.toDataURL('image/jpeg',0.85));
      }; img.src=fr.result;
    }; fr.readAsDataURL(file);
  });
}
function openGallery(day){
  const body=$('#galBody'); body.innerHTML='';
  const rec=getRec(day); const arr=rec.photos||[];
  if(arr.length===0){ body.textContent='‚Äî'; galDlg.showModal(); return; }
  arr.forEach((p,i)=>{
    const wrap=document.createElement('div'); wrap.style.margin='8px 0';
    const img=new Image(); img.src=p.data; img.style.maxWidth='100%'; img.style.borderRadius='12px';
    const del=document.createElement('button'); del.className='mini gray'; del.textContent='üóëÔ∏è';
    del.onclick=()=>{ arr.splice(i,1); rec.photos=arr; saveData(); updatePhotoCount(day); openGallery(day); };
    wrap.append(img,del); body.append(wrap);
  });
  $('#galTitle').textContent=L.dlgDay+' '+String(day).padStart(2,'0');
  galDlg.showModal();
}

// ===== Month nav =====
function setMonth(ym){ month=ym; cfg.month=ym; saveCfg(); render(); applyMonthName(); }
$('#prevM').onclick=()=>{ const [y,m]=month.split('-').map(Number); const d=new Date(y,m-2,1); setMonth(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); };
$('#nextM').onclick=()=>{ const [y,m]=month.split('-').map(Number); const d=new Date(y,m,1); setMonth(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); };

// ===== Settings =====
$('#openSettings').onclick=()=>{ $('#langSel').value=cfg.lang||'sv'; $('#wmRange').value=(cfg.wm??12); $('#addrInput').value=cfg.addr||''; settingsDlg.showModal(); };
$('#logoFile').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; cfg.logo=await toBase64Compressed(f,1024); saveCfg(); applyLogo(); });
$('#saveCfg').onclick=()=>{ cfg.lang=$('#langSel').value; cfg.wm=parseInt($('#wmRange').value||12); cfg.addr=$('#addrInput').value||''; saveCfg(); applyLang(); settingsDlg.close(); };

// ===== Share & PDF =====
$('#shareOpen').onclick=()=>{ shareDlg.showModal(); };

function buildShareText(){
  let out=L.title+'\n';
  const dcount=daysIn(month);
  for(let d=1; d<=dcount; d++){
    const r=getRec(d);
    const mins = (r.from&&r.to)? Math.max(0, toMin(r.to)-toMin(r.from)-(parseInt(r.pause||0)||0)) : 0;
    if(r.from||r.to||r.project||r.notes|| (r.photos&&r.photos.length)){
      const photos = (r.photos?.length||0) > 0 ? ` [üì∑√ó${r.photos.length}]` : '';
      out+=`${String(d).padStart(2,'0')}: ${r.from||'--:--'}‚Äì${r.to||'--:--'} (${r.pause||0} ${L.min})  ${L.daily}: ${(mins/60).toFixed(2)}  ${r.project||''}${photos}\n`;
    }
  }
  out+=`\n${L.monthsum}: ${$('#sumHours').textContent} h`;
  return out;
}
$('#doWebShare').onclick=async()=>{ const text=buildShareText(); try{ if(navigator.share) await navigator.share({text}); else { await navigator.clipboard?.writeText(text); alert(L.copied);} }catch{ await navigator.clipboard?.writeText(text); alert(L.copied);} };
$('#doCopy').onclick=async()=>{ await navigator.clipboard?.writeText(buildShareText()); alert(L.copied); };
$('#doEmail').onclick=()=>{ const subject=encodeURIComponent(L.title); const body=encodeURIComponent(buildShareText()); location.href=`mailto:?subject=${subject}&body=${body}`; };
$('#doWhats').onclick=()=>{ const msg=encodeURIComponent(buildShareText()); location.href=`https://wa.me/?text=${msg}`; };

$('#pdfBtn').onclick=()=>{ // watermark + address + print
  const src=cfg.logo||defaultLogo;
  const old=document.getElementById('wm-style'); if(old) old.remove();
  const st=document.createElement('style'); st.id='wm-style';
  const op=(cfg.wm??12)/100;
  const addr = (cfg.addr && cfg.addr.trim().length>0)? cfg.addr.trim() : 'Th√ºringer Tannenhof ‚Ä¢ Wittchenstein 6, 07819 Geroda ‚Ä¢ Deutschland';
  st.textContent=`@media print{
    body.print-wm::before{ background-image:url(${src}); opacity:${op}; }
    body::after{ content:"${addr.replace(/"/g,'\\"')}"; }
  }`;
  document.head.appendChild(st);
  document.body.style.setProperty('--wm-opacity', String(op));
  document.body.classList.add('print-wm');
  window.print();
  setTimeout(()=>document.body.classList.remove('print-wm'),600);
};

// ===== Signatures =====
$('#signOpen').onclick=()=>{ loadSigToUI(); signDlg.showModal(); };
function enableDraw(canvas){
  let down=false, last=null, ctx=canvas.getContext('2d'); ctx.lineWidth=2;
  function pos(e){ const r=canvas.getBoundingClientRect(); const pt=(e.touches?e.touches[0]:e); return {x:pt.clientX-r.left,y:pt.clientY-r.top}; }
  function start(e){down=true; last=pos(e); e.preventDefault();}
  function move(e){ if(!down) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault();}
  function end(){down=false;}
  canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',move); canvas.addEventListener('mouseup',end);
  canvas.addEventListener('touchstart',start,{passive:false}); canvas.addEventListener('touchmove',move,{passive:false}); canvas.addEventListener('touchend',end);
}
enableDraw($('#empSig')); enableDraw($('#supSig'));
$('#empClear').onclick=()=>{ const c=$('#empSig'); c.getContext('2d').clearRect(0,0,c.width,c.height); };
$('#supClear').onclick=()=>{ const c=$('#supSig'); c.getContext('2d').clearRect(0,0,c.width,c.height); };
$('#sigSave').onclick=()=>{
  cfg.sign=cfg.sign||{};
  cfg.sign.empImg=$('#empSig').toDataURL('image/png');
  cfg.sign.supImg=$('#supSig').toDataURL('image/png');
  cfg.sign.empName=$('#empName').value||'';
  cfg.sign.supName=$('#supName').value||'';
  cfg.sign.place=$('#sigPlace').value||'';
  cfg.sign.date=$('#sigDate').value||'';
  saveCfg();
  applySignView();
  signDlg.close();
};
function loadSigToUI(){
  $('#empName').value=cfg.sign?.empName||'';
  $('#supName').value=cfg.sign?.supName||'';
  $('#sigPlace').value=cfg.sign?.place||'';
  $('#sigDate').value=cfg.sign?.date||'';
  const e=$('#empSig').getContext('2d'); e.clearRect(0,0,500,160);
  const s=$('#supSig').getContext('2d'); s.clearRect(0,0,500,160);
  if(cfg.sign?.empImg){ const img=new Image(); img.onload=()=>e.drawImage(img,0,0,500,160); img.src=cfg.sign.empImg; }
  if(cfg.sign?.supImg){ const img=new Image(); img.onload=()=>s.drawImage(img,0,0,500,160); img.src=cfg.sign.supImg; }
}
function applySignView(){
  const empI=$('#sigEmpImg'), supI=$('#sigSupImg');
  if(cfg.sign?.empImg){ empI.src=cfg.sign.empImg; } else { empI.removeAttribute('src'); }
  if(cfg.sign?.supImg){ supI.src=cfg.sign.supImg; } else { supI.removeAttribute('src'); }
  const metaEmp=[], metaSup=[];
  if(cfg.sign?.empName) metaEmp.push(cfg.sign.empName);
  if(cfg.sign?.place) metaEmp.push(cfg.sign.place);
  if(cfg.sign?.date) metaEmp.push(cfg.sign.date);
  if(cfg.sign?.supName) metaSup.push(cfg.sign.supName);
  if(cfg.sign?.place) metaSup.push(cfg.sign.place);
  if(cfg.sign?.date) metaSup.push(cfg.sign.date);
  $('#sigEmpMeta').textContent=metaEmp.join(' ‚Ä¢ ');
  $('#sigSupMeta').textContent=metaSup.join(' ‚Ä¢ ');
  $('#signSection').style.display=(cfg.sign?.empImg||cfg.sign?.supImg)?'block':'none';
}

// ===== Boot =====
function applyAll(){ applyLogo(); applyLang(); applyMonthName(); render(); applySignView(); }
applyAll();
})();
</script>
</body>
</html>
