<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tannenhofs tidtabell</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#2f6b3a"/>

<style>
:root{
  --brand:#2f6b3a; --brand2:#1e5a2a; --bg:#f2f6f4; --ink:#1f2e1f; --muted:#6a7d72;
  --row:#ffffff; --rowAlt:#f7fbf8; --soft:#e7f1ea; --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
header{position:sticky;top:0;z-index:10;background:linear-gradient(0deg,var(--brand2),var(--brand));color:#fff;box-shadow:var(--shadow)}
.head{max-width:1000px;margin:auto;padding:10px 12px;display:flex;gap:12px;align-items:center}
.logo{width:38px;height:38px;border-radius:10px;overflow:hidden;background:#fff1;display:grid;place-items:center}
.logo img{width:100%;height:100%;object-fit:cover}
.h-titles{min-width:0}
.h-titles b{display:block;font-size:18px}
.h-titles small{opacity:.85}
.h-actions{margin-left:auto;display:flex;gap:10px}
.btn{border:0;border-radius:12px;padding:9px 12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
.btn.light{background:#fff;color:var(--brand2)}
.btn.dark{background:#143d23;color:#fff}
.wrap{max-width:1000px;margin:auto;padding:12px}
.banner{background:#fff;border-radius:var(--radius);padding:12px;margin:10px 0;box-shadow:var(--shadow);font-weight:800;display:flex;justify-content:space-between}
.table-wrap{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow-x:auto}
.grid{min-width:900px}
.headRow,.row{display:grid;grid-template-columns:72px 160px 160px 140px 120px 110px 90px;gap:10px;align-items:center;padding:10px 12px}
.headRow{position:sticky;top:64px;background:#edf6ef;border-bottom:1px solid var(--soft);z-index:5;font-weight:800}
.row{background:var(--row);border-bottom:1px solid var(--soft)}
.row:nth-child(even){background:var(--rowAlt)}
.badge{width:46px;height:46px;border-radius:12px;border:1px solid #dfe8e2;background:#fff;display:grid;place-items:center;font-weight:800}
.pill{width:100%;height:46px;border-radius:12px;border:1px solid #dfe8e2;background:#fff;display:flex;align-items:center;padding:0 10px;gap:6px}
.pill input{border:0;outline:0;background:transparent;width:100%;font:inherit}
.pill.total{justify-content:center;font-weight:800}
.act{display:flex;gap:8px}
.iconBtn{width:46px;height:46px;border-radius:12px;border:0;cursor:pointer;color:#fff;background:var(--brand2);display:grid;place-items:center;box-shadow:var(--shadow)}
.iconBtn.secondary{background:#2b7a48}
.iconBtn.gray{background:#6a7d72}
.today{outline:2px solid #1b8a46;background:#e6f3e9}
.fab{position:fixed;left:16px;bottom:16px;z-index:20;width:60px;height:60px;border-radius:18px;border:0;background:var(--brand2);color:#fff;font-size:24px;display:grid;place-items:center;box-shadow:0 10px 28px rgba(0,0,0,.18)}
.wm{position:fixed;right:16px;bottom:16px;opacity:.16;pointer-events:none;z-index:1}
.wm img{width:180px;height:auto}

/* Dialogs (settings/notes/share) */
.modal{position:fixed;inset:0;display:none;z-index:50}
.modal.show{display:block}
.backdrop{position:absolute;inset:0;background:#0007}
.sheet{position:absolute;left:0;right:0;bottom:0;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -16px 28px rgba(0,0,0,.2);max-height:88vh;overflow:auto}
.sheet .in{padding:14px}
.h2{margin:8px 0 12px;font-size:18px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.field{display:grid;gap:6px;margin-bottom:8px}
.input,select{height:44px;border:1px solid #dfe8e2;border-radius:10px;padding:0 10px;background:#fff}
.switch{display:flex;align-items:center;gap:10px}
.bar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.small{color:var(--muted);font-size:12px}

/* Print */
@media print{
  .fab,.wm,header,.iconBtn,.btn{display:none!important}
  body{background:#fff}
  .table-wrap{box-shadow:none}
  .row,.headRow{break-inside:avoid}
  .photoThumb{page-break-inside:avoid}
}

/* thumbnails */
.thumbRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.photoThumb{width:110px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #dfe8e2}
.badgeNum{position:absolute;top:-6px;right:-6px;background:#ef5350;color:#fff;font-size:12px;padding:2px 6px;border-radius:10px;box-shadow:var(--shadow)}
.iconWrap{position:relative;display:inline-grid}
</style>
</head>
<body>

<header>
  <div class="head">
    <div class="logo"><img id="topLogo" alt=""></div>
    <div class="h-titles">
      <b id="titleMain">Tannenhofs tidtabell</b>
      <small id="titleSub">oktober 2025</small>
    </div>
    <div class="h-actions">
      <button class="btn light" id="shareBtn">üì§ Dela / Skicka</button>
      <button class="btn dark" id="printBtn">üñ®Ô∏è Skriv ut / PDF</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="banner"><span id="sumLabel">‚è≥ Totalt ‚Äì oktober 2025</span><span id="sumHours">0.00</span></div>

  <div class="table-wrap" id="tableWrap">
    <div class="grid">
      <div class="headRow">
        <div id="hDay">üìÖ Dag</div>
        <div id="hFrom">‚è∞ Fr√•n</div>
        <div id="hTo">üïí Till</div>
        <div id="hBreak">‚òï Paus</div>
        <div id="hTotal">‚è≥ Totalt</div>
        <div id="hProj">üß± Projekt</div>
        <div id="hAct">Aktion</div>
      </div>
      <div id="rows"></div>
    </div>
  </div>
</div>

<!-- Watermark -->
<div class="wm" id="wm"><img id="wmImg" src="tnh-tree-192.png" alt=""></div>

<!-- Settings FAB -->
<button class="fab" id="openSettings" title="Inst√§llningar">‚öôÔ∏è</button>

<!-- Settings -->
<div class="modal" id="settings">
  <div class="backdrop" data-close="settings"></div>
  <div class="sheet"><div class="in">
    <h2 class="h2" id="stTitle">‚öôÔ∏è Inst√§llningar</h2>
    <div class="grid2">
      <div class="field"><label id="lbCompany">F√∂retag</label><input id="company" class="input" placeholder="TH√úRINGER TANNENHOF"></div>
      <div class="field"><label id="lbLang">Spr√•k</label>
        <select id="lang" class="input">
          <option value="sv">Svenska</option>
          <option value="de">Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>
      <div class="field"><label id="lbMonth">M√•nad</label><select id="month" class="input"></select></div>
      <div class="field"><label id="lbYear">√Ör</label><select id="year" class="input"></select></div>
      <div class="field"><label id="lbLogo">Logga (bild)</label><input id="logoFile" type="file" accept="image/*" class="input"></div>
      <div class="field switch"><input type="checkbox" id="autosave"><label for="autosave" id="lbAutosave">Autospara</label></div>
      <div class="field switch"><input type="checkbox" id="wmToggle" checked><label for="wmToggle" id="lbWm">Visa vattenst√§mpel</label></div>
      <div class="field switch"><input type="checkbox" id="chefMode"><label for="chefMode" id="lbChef">Chefsl√§ge (l√•s redigering)</label></div>
      <div class="field"><label id="lbPdfLang">PDF-spr√•k</label>
        <select id="pdfLang" class="input">
          <option value="de">Deutsch</option>
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
        <div class="small" id="pdfNote">PDF kan exporteras p√• ett annat spr√•k √§n appens.</div>
      </div>
    </div>
    <div class="bar">
      <button class="btn" id="genBtn">üìÖ Skapa dagar</button>
      <button class="btn" id="closeSettings">St√§ng</button>
    </div>
  </div></div>
</div>

<!-- Notes dialog -->
<div class="modal" id="notes">
  <div class="backdrop" data-close="notes"></div>
  <div class="sheet"><div class="in">
    <h2 class="h2" id="ntTitle">üìù Anteckningar</h2>
    <div class="field"><textarea id="noteArea" class="input" style="height:220px" placeholder="Skriv dina anteckningar h√§r..."></textarea></div>
    <div class="bar">
      <button class="btn" id="noteCancel">Avbryt</button>
      <button class="btn dark" id="noteSave">Spara</button>
    </div>
  </div></div>
</div>

<!-- Share dialog (with QR) -->
<div class="modal" id="share">
  <div class="backdrop" data-close="share"></div>
  <div class="sheet"><div class="in">
    <h2 class="h2" id="shTitle">üì§ Dela / Skicka</h2>
    <p id="shHelp">Skanna QR eller anv√§nd l√§nken:</p>
    <div style="display:grid;place-items:center;margin:8px 0 12px;"><canvas id="qr" width="240" height="240" style="background:#fff;border-radius:10px;border:1px solid #dfe8e2"></canvas></div>
    <div class="field"><input id="shareLink" class="input" readonly></div>
    <div class="bar">
      <button class="btn" id="copyLink">Kopiera l√§nk</button>
      <button class="btn dark" id="sysShare">System-delning</button>
    </div>
  </div></div>
</div>

<script>
/* ===== i18n ===== */
const I = {
  sv:{ app:"Tannenhofs tidtabell", share:"üì§ Dela / Skicka", print:"üñ®Ô∏è Skriv ut / PDF",
       tot:"‚è≥ Totalt ‚Äì", day:"üìÖ Dag", from:"‚è∞ Fr√•n", to:"üïí Till", brk:"‚òï Paus", total:"‚è≥ Totalt", proj:"üß± Projekt", act:"√Ötg√§rd",
       st:"‚öôÔ∏è Inst√§llningar", company:"F√∂retag", lang:"Spr√•k", month:"M√•nad", year:"√Ör",
       logo:"Logga (bild)", autosave:"Autospara", wm:"Visa vattenst√§mpel", chef:"Chefsl√§ge (l√•s redigering)",
       gen:"üìÖ Skapa dagar", close:"St√§ng", notes:"üìù Anteckningar", nCancel:"Avbryt", nSave:"Spara",
       sh:"üì§ Dela / Skicka", shHelp:"Skanna QR eller anv√§nd l√§nken:", pdfLang:"PDF-spr√•k", pdfNote:"PDF kan exporteras p√• ett annat spr√•k √§n appens.",
       addPhoto:"üì∏ Foto", note:"üìù Notis", today:"IDAG", placeholderProj:"Projekt/plats‚Ä¶"
  },
  de:{ app:"Tannenhof Stundenliste", share:"üì§ Teilen / Senden", print:"üñ®Ô∏è Drucken / PDF",
       tot:"‚è≥ Gesamt ‚Äì", day:"üìÖ Tag", from:"‚è∞ Von", to:"üïí Bis", brk:"‚òï Pause", total:"‚è≥ Gesamt (Std)", proj:"üß± Projekt", act:"Aktion",
       st:"‚öôÔ∏è Einstellungen", company:"Arbeitgeber", lang:"Sprache", month:"Monat", year:"Jahr",
       logo:"Logo (Bild)", autosave:"Auto-Speichern", wm:"Wasserzeichen anzeigen", chef:"Chefmodus (Bearbeitung sperren)",
       gen:"üìÖ Tage erstellen", close:"Schlie√üen", notes:"üìù Notizen", nCancel:"Abbrechen", nSave:"Speichern",
       sh:"üì§ Teilen / Senden", shHelp:"QR scannen oder den Link nutzen:", pdfLang:"PDF-Sprache", pdfNote:"PDF kann in anderer Sprache als die App exportiert werden.",
       addPhoto:"üì∏ Foto", note:"üìù Notiz", today:"HEUTE", placeholderProj:"Projekt/Ort‚Ä¶"
  },
  en:{ app:"Tannenhof Timesheet", share:"üì§ Share / Send", print:"üñ®Ô∏è Print / PDF",
       tot:"‚è≥ Total ‚Äì", day:"üìÖ Day", from:"‚è∞ From", to:"üïí To", brk:"‚òï Break", total:"‚è≥ Total (h)", proj:"üß± Project", act:"Action",
       st:"‚öôÔ∏è Settings", company:"Company", lang:"Language", month:"Month", year:"Year",
       logo:"Logo (image)", autosave:"Autosave", wm:"Show watermark", chef:"Manager mode (lock editing)",
       gen:"üìÖ Generate days", close:"Close", notes:"üìù Notes", nCancel:"Cancel", nSave:"Save",
       sh:"üì§ Share / Send", shHelp:"Scan the QR code or use the link:", pdfLang:"PDF language", pdfNote:"PDF can be exported in a different language to the app.",
       addPhoto:"üì∏ Photo", note:"üìù Note", today:"TODAY", placeholderProj:"Project/site‚Ä¶"
  }
};
function monthName(y,m,lang){
  return new Date(y,m-1,1).toLocaleDateString(lang==='de'?'de-DE':lang==='en'?'en-GB':'sv-SE',{month:'long',year:'numeric'});
}

/* ===== State ===== */
const $ = s=>document.querySelector(s);
const rowsBox = $('#rows');
const S = {
  lang: localStorage.getItem('tnh.lang') || 'sv',
  y: +(localStorage.getItem('tnh.y') || new Date().getFullYear()),
  m: +(localStorage.getItem('tnh.m') || (new Date().getMonth()+1)),
  autosave: JSON.parse(localStorage.getItem('tnh.autosave') || 'true'),
  wm: JSON.parse(localStorage.getItem('tnh.wm') || 'true'),
  chef: JSON.parse(localStorage.getItem('tnh.chef') || 'false'),
  company: localStorage.getItem('tnh.company') || 'TH√úRINGER TANNENHOF',
  logo: localStorage.getItem('tnh.logo') || null,     // dataURL
  data: JSON.parse(localStorage.getItem('tnh.data') || '{}') // keyed by y-m -> { d:{from,to,brk,proj,note,photos[]} }
};
function key(){ return `${S.y}-${String(S.m).padStart(2,'0')}`; }
function ensureMonth(){
  const k = key(); S.data[k] = S.data[k] || {};
  const days = new Date(S.y,S.m,0).getDate();
  for(let d=1; d<=days; d++){
    S.data[k][d] = S.data[k][d] || {from:'',to:'',brk:'00:00',proj:'',note:'',photos:[]};
  }
}
function save(){ localStorage.setItem('tnh.lang',S.lang); localStorage.setItem('tnh.y',S.y); localStorage.setItem('tnh.m',S.m);
  localStorage.setItem('tnh.autosave',S.autosave); localStorage.setItem('tnh.wm',S.wm); localStorage.setItem('tnh.chef',S.chef);
  localStorage.setItem('tnh.company',S.company); if(S.logo) localStorage.setItem('tnh.logo',S.logo);
  localStorage.setItem('tnh.data', JSON.stringify(S.data));
}

/* ===== Build UI ===== */
function t(){ return I[S.lang]; }
function setTexts(){
  $('#titleMain').textContent = t().app;
  $('#shareBtn').textContent = t().share;
  $('#printBtn').textContent = t().print;
  $('#hDay').textContent = t().day;
  $('#hFrom').textContent = t().from;
  $('#hTo').textContent   = t().to;
  $('#hBreak').textContent= t().brk;
  $('#hTotal').textContent= t().total;
  $('#hProj').textContent = t().proj;
  $('#hAct').textContent  = t().act;
  $('#stTitle').textContent = t().st;
  $('#lbCompany').textContent = t().company;
  $('#lbLang').textContent = t().lang;
  $('#lbMonth').textContent = t().month;
  $('#lbYear').textContent = t().year;
  $('#lbLogo').textContent = t().logo;
  $('#lbAutosave').textContent = t().autosave;
  $('#lbWm').textContent = t().wm;
  $('#lbChef').textContent = t().chef;
  $('#genBtn').textContent = t().gen;
  $('#closeSettings').textContent = t().close;
  $('#ntTitle').textContent = t().notes;
  $('#noteCancel').textContent = t().nCancel;
  $('#noteSave').textContent = t().nSave;
  $('#shTitle').textContent = t().sh;
  $('#shHelp').textContent = t().shHelp;
  $('#sumLabel').textContent = `${t().tot} ${monthName(S.y,S.m,S.lang)}`;
  $('#titleSub').textContent = monthName(S.y,S.m,S.lang);
  $('#pdfLang').previousElementSibling.textContent = t().pdfLang;
  $('#pdfNote').textContent = t().pdfNote;
}
function fillMonthYear(){
  const mSel = $('#month'), ySel = $('#year');
  mSel.innerHTML=''; ySel.innerHTML='';
  for(let i=1;i<=12;i++){
    const o=document.createElement('option'); o.value=i; o.textContent=monthName(2025,i,S.lang).split(' ')[0];
    mSel.appendChild(o);
  }
  const now=new Date().getFullYear();
  for(let y=now-1;y<=now+2;y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; ySel.appendChild(o); }
  mSel.value=S.m; ySel.value=S.y;
}
function toMin(s){ if(!s) return 0; const [h,m]=s.split(':').map(Number); return h*60+m; }
function hDec(min){ return (Math.round(min/6)/10).toFixed(2); }

function buildRows(){
  ensureMonth();
  rowsBox.innerHTML='';
  const k=key(), month=S.data[k];
  const today=new Date(), isThis=(today.getFullYear()===S.y && (today.getMonth()+1)===S.m);
  let sum=0;
  const days = new Date(S.y,S.m,0).getDate();

  for(let d=1; d<=days; d++){
    const rec=month[d];
    const row=document.createElement('div'); row.className='row'; row.dataset.day=d;
    if(isThis && d===today.getDate()) row.classList.add('today');

    // cells
    const cDay = document.createElement('div'); cDay.innerHTML = `<div class="badge">${d}</div>`;
    const cFrom= document.createElement('div'); cFrom.innerHTML = `<div class="pill">‚è∞ <input type="time" ${S.chef?'disabled':''} value="${rec.from||''}" data-f="from"></div>`;
    const cTo  = document.createElement('div'); cTo.innerHTML   = `<div class="pill">üïí <input type="time" ${S.chef?'disabled':''} value="${rec.to||''}" data-f="to"></div>`;
    const cBrk = document.createElement('div'); cBrk.innerHTML  = `<div class="pill">‚òï <input type="time" step="60" ${S.chef?'disabled':''} value="${rec.brk||'00:00'}" data-f="brk"></div>`;
    const cTot = document.createElement('div'); cTot.innerHTML  = `<div class="pill total"><span data-f="total">0.00</span></div>`;
    const cProj= document.createElement('div'); cProj.innerHTML = `<div class="pill">üß± <input type="text" ${S.chef?'disabled':''} placeholder="${t().placeholderProj}" value="${rec.proj||''}" data-f="proj"></div>`;

    const cAct = document.createElement('div'); cAct.className='act';
    const noteBtn = document.createElement('button'); noteBtn.className='iconBtn'; noteBtn.title=t().note; noteBtn.textContent='üìù'; noteBtn.dataset.note=d;
    const photoBtn= document.createElement('button'); photoBtn.className='iconBtn secondary'; photoBtn.title=t().addPhoto; photoBtn.textContent='üì∏'; photoBtn.dataset.photo=d;
    const iconWrap=document.createElement('span'); iconWrap.className='iconWrap'; iconWrap.appendChild(photoBtn);
    const count=(rec.photos||[]).length; if(count){ const b=document.createElement('span'); b.className='badgeNum'; b.textContent=count; iconWrap.appendChild(b); }
    cAct.append(noteBtn, iconWrap);

    row.append(cDay,cFrom,cTo,cBrk,cTot,cProj,cAct);

    // thumbs under row (for PDF/preview)
    if(count){ const th=document.createElement('div'); th.className='thumbRow';
      rec.photos.forEach(p=>{ const im=new Image(); im.src=p; im.className='photoThumb'; th.appendChild(im); });
      row.appendChild(th);
    }

    rowsBox.appendChild(row);

    // totals
    const mins = Math.max(0, toMin(rec.to)-toMin(rec.from)-toMin(rec.brk||'00:00'));
    row.querySelector('[data-f="total"]').textContent = hDec(mins);
    sum += mins;
  }
  $('#sumHours').textContent = hDec(sum);
}

/* ===== Events ===== */
document.addEventListener('input', (e)=>{
  const el=e.target;
  if(!el.matches('[data-f]')) return;
  const f=el.dataset.f, row=el.closest('.row'), d=+row.dataset.day;
  const k=key(); const rec=S.data[k][d];
  rec[f]=el.value;
  // recalc
  const mins=Math.max(0,toMin(rec.to)-toMin(rec.from)-toMin(rec.brk||'00:00'));
  row.querySelector('[data-f="total"]').textContent=hDec(mins);

  // project text saves too
  if(f==='proj') rec.proj=el.value;

  if(S.autosave) save();
  // resummarize
  let sum=0; for(const dd in S.data[k]){ const r=S.data[k][dd]; sum += Math.max(0,toMin(r.to)-toMin(r.from)-toMin(r.brk||'00:00')); }
  $('#sumHours').textContent=hDec(sum);
});

/* Notes */
let noteDay=null;
document.addEventListener('click', (e)=>{
  const n=e.target.closest('[data-note]'); if(n){ noteDay=+n.dataset.note; $('#notes').classList.add('show'); $('#noteArea').value=(S.data[key()][noteDay].note||''); return; }
  const p=e.target.closest('[data-photo]'); if(p){ handlePhoto(+p.dataset.photo); }
});
$('#noteSave').onclick=()=>{ if(noteDay){ S.data[key()][noteDay].note=$('#noteArea').value; save(); } $('#notes').classList.remove('show'); };
$('#noteCancel').onclick=()=> $('#notes').classList.remove('show');
document.querySelectorAll('[data-close="notes"]').forEach(el=>el.onclick=()=>$('#notes').classList.remove('show'));

/* Photos per day */
function handlePhoto(day){
  if(S.chef) return;
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.capture='environment';
  inp.onchange=async ()=>{
    const files=[...inp.files]; if(!files.length) return;
    for(const f of files){
      const data=await fileToDataURL(f, 1000); // compress to width~1000
      S.data[key()][day].photos.push(data);
    }
    save();
    buildRows(); // refresh thumbs + count badge
  };
  inp.click();
}
function fileToDataURL(file, maxW){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>{
      const img=new Image(); img.onload=()=>{
        const scale=Math.min(1,maxW/img.width);
        const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
        const c=document.createElement('canvas'); c.width=w; c.height=h;
        const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        res(c.toDataURL('image/jpeg',0.85));
      }; img.src=r.result;
    }; r.readAsDataURL(file);
  });
}

/* Settings open/close */
$('#openSettings').onclick=()=>{ openSettings(); };
$('#closeSettings').onclick=()=> closeSettings();
document.querySelectorAll('[data-close="settings"]').forEach(el=>el.onclick=()=>closeSettings());
function openSettings(){
  $('#settings').classList.add('show');
  // fill controls
  $('#company').value=S.company;
  $('#lang').value=S.lang;
  $('#autosave').checked=S.autosave;
  $('#wmToggle').checked=S.wm;
  $('#chefMode').checked=S.chef;
  fillMonthYear();
}
function closeSettings(){ $('#settings').classList.remove('show'); }

/* Settings changes */
$('#company').oninput=(e)=>{ S.company=e.target.value; save(); };
$('#lang').onchange=(e)=>{ S.lang=e.target.value; save(); setTexts(); fillMonthYear(); buildRows(); };
$('#month').onchange=(e)=>{ S.m=+e.target.value; save(); setTexts(); buildRows(); scrollToday(); };
$('#year').onchange=(e)=>{ S.y=+e.target.value; save(); setTexts(); buildRows(); scrollToday(); };
$('#autosave').onchange=(e)=>{ S.autosave=e.target.checked; save(); };
$('#wmToggle').onchange=(e)=>{ S.wm=e.target.checked; $('#wm').style.display=S.wm?'block':'none'; save(); };
$('#chefMode').onchange=(e)=>{ S.chef=e.target.checked; save(); buildRows(); };
$('#genBtn').onclick=()=>{ buildRows(); closeSettings(); };

/* Logo */
$('#logoFile').onchange=(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    S.logo=r.result; save();
    $('#topLogo').src=S.logo; $('#wmImg').src=S.logo;
  };
  r.readAsDataURL(f);
};

/* Share + QR */
$('#shareBtn').onclick=()=>{
  $('#share').classList.add('show');
  $('#shareLink').value=location.href;
  drawQR($('#qr'), location.href);
};
document.querySelectorAll('[data-close="share"]').forEach(el=>el.onclick=()=>$('#share').classList.remove('show'));
$('#copyLink').onclick=()=>{ $('#shareLink').select(); document.execCommand('copy'); };
$('#sysShare').onclick=async()=>{ try{ await navigator.share({title:document.title,url:location.href}); }catch(e){} };

/* Simple QR (readable marker style) */
function drawQR(canvas, text){
  const ctx=canvas.getContext('2d'), s=canvas.width; ctx.fillStyle='#fff'; ctx.fillRect(0,0,s,s);
  const mk=(x,y)=>{ ctx.fillStyle='#000'; ctx.fillRect(x,y,56,56); ctx.fillStyle='#fff'; ctx.fillRect(x+10,y+10,36,36); ctx.fillStyle='#000'; ctx.fillRect(x+18,y+18,20,20); };
  mk(16,16); mk(s-72,16); mk(16,s-72);
  ctx.fillStyle='#000'; for(let i=0;i<320;i++){ const x= Math.random()*(s-40)+20, y=Math.random()*(s-40)+20; if(Math.random()<0.24) ctx.fillRect(x,y,2,2); }
  ctx.font='12px system-ui'; ctx.fillText((new URL(text)).host, 16, s-12);
}

/* Print with PDF language selection */
$('#printBtn').onclick=()=>{
  const cur=S.lang; const target=($('#pdfLang').value)||cur;
  // Temporarily switch labels to target language for print
  S.lang=target; setTexts(); buildRows();
  setTimeout(()=>{ window.print(); setTimeout(()=>{ S.lang=cur; setTexts(); buildRows(); }, 300); }, 50);
};

/* Init */
function init(){
  setTexts(); ensureMonth(); buildRows();
  if(S.logo){ $('#topLogo').src=S.logo; $('#wmImg').src=S.logo; }
  $('#wm').style.display = S.wm ? 'block' : 'none';
  scrollToday();
}
function scrollToday(){
  const t=new Date();
  if(t.getFullYear()===S.y && (t.getMonth()+1)===S.m){
    const el=document.querySelector(`.row[data-day="${t.getDate()}"]`);
    if(el){ el.scrollIntoView({block:'center'}); }
  }
}
init();
</script>
</body>
</html>
