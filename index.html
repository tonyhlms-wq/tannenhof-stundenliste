<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Th√ºringer Tannenhof ‚Äì Tidsrapport</title>
<link rel="icon" href="favicon.ico">
<style>
  :root{
    --green:#165a34;           /* header/gran-gr√∂n */
    --green-2:#1c7342;         /* m√∂rkare knappar */
    --pill:#eaf4ee;            /* ljusgr√∂n pillbakgrund */
    --ink:#0b2b19;             /* m√∂rkgr√∂n text */
    --muted:#7a8a80;
    --white:#fff;
    --shadow: 0 6px 18px rgba(0,0,0,.08);
    --radius:18px;
  }
  html,body{margin:0;background:#f4f9f5;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  /* Header */
  header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,var(--green),#1a6a3e);
          color:#fff;box-shadow:var(--shadow)}
  .wrap{max-width:1000px;margin:0 auto;padding:12px 14px}
  .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px;min-width:0}
  .logo{width:36px;height:36px;border-radius:10px;background:#e3efe8 url('tnh-tree-192.png') center/70% no-repeat}
  h1{font-size:18px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .actions{margin-left:auto;display:flex;gap:10px}
  .btn{border:0;border-radius:16px;padding:10px 14px;background:#fff;color:#123;box-shadow:var(--shadow);font-weight:600}
  .btn.dark{background:#0f2318;color:#fff}
  /* Controls */
  .controls{max-width:1000px;margin:14px auto;padding:0 14px}
  .panel{background:#fff;border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .tot{background:var(--pill);padding:10px 14px;border-radius:14px;font-weight:700;display:flex;gap:8px;align-items:center}
  .navbtn{background:var(--green-2);color:#fff;border:0;border-radius:14px;width:46px;height:44px;font-size:18px;box-shadow:var(--shadow)}
  .ghost{background:#fff;color:#123}
  .chip{background:var(--pill);padding:10px 14px;border-radius:14px}
  /* Table */
  .table{max-width:1000px;margin:10px auto 120px;padding:0 14px}
  .thead,.tr{display:grid;grid-template-columns:64px 1fr 1fr 90px 160px 140px 90px 70px;gap:10px;align-items:center}
  .thead{position:sticky;top:70px;background:linear-gradient(180deg,#f4f9f5,rgba(244,249,245,.7));backdrop-filter:blur(3px);
         padding:10px 10px;border-radius:12px;margin-bottom:8px;z-index:2}
  .tr{background:#fff;border-radius:16px;padding:10px 10px;margin:8px 0;box-shadow:var(--shadow);position:relative}
  .day{font-weight:800;text-align:center}
  .pill{background:var(--pill);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;gap:8px}
  input[type="time"], input[type="number"]{width:100%;border:0;background:transparent;font-size:16px;text-align:center;outline:none}
  input[type="number"]{appearance:textfield}
  .smallbtn{background:var(--green-2);color:#fff;border:0;border-radius:12px;padding:10px 12px;font-weight:600;box-shadow:var(--shadow)}
  .neutral{background:var(--pill);color:#123}
  .right{justify-self:end;font-weight:800}
  /* Floating gear */
  .gear{position:fixed;left:18px;bottom:18px;background:var(--green-2);color:#fff;width:64px;height:64px;border-radius:20px;
        display:grid;place-items:center;box-shadow:var(--shadow);z-index:40}
  .menu{position:fixed;left:18px;bottom:92px;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:10px;display:none;z-index:40}
  .menu button{display:block;width:220px;text-align:left;background:#fff;border:0;padding:10px 12px;border-radius:10px}
  .menu button:hover{background:#f0f5f2}
  /* Watermark */
  .wm{position:fixed;right:18px;bottom:16px;opacity:.16;user-select:none;pointer-events:none;font-weight:900;line-height:1.1;text-align:right}
  /* Debug panel */
  #debug{position:fixed;left:10px;right:10px;bottom:10px;background:var(--green);color:#e5f3ea;border-radius:12px;
         box-shadow:var(--shadow);font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;z-index:50}
  #debug header{background:transparent;box-shadow:none;padding:8px 10px}
  #debug .head{display:flex;align-items:center;gap:10px}
  #log{max-height:140px;overflow:auto;padding:8px 10px;background:#0e3a23;border-radius:0 0 12px 12px}
  .hide{display:none}
  /* Print */
  @media print {
    .actions,.controls .panel button,.gear,.menu,#debug{display:none !important}
    header{box-shadow:none}
    .thead{top:0}
    body{background:#fff}
  }
</style>
</head>
<body>

<header>
  <div class="wrap row">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>Th√ºringer Tannenhof ‚Äì Tidsrapport</h1>
    </div>
    <div class="actions">
      <button class="btn" id="shareBtn">üèîÔ∏è Dela / Skicka</button>
      <button class="btn dark" id="pdfBtn">üñ®Ô∏è PDF</button>
    </div>
  </div>
</header>

<section class="controls">
  <div class="panel">
    <div class="tot">‚è≥ <span>Totalt ‚Äì </span><b id="grandTotal">0.00</b></div>
    <button class="navbtn" id="prevBtn">¬´</button>
    <button class="navbtn" id="nextBtn">¬ª</button>
    <div class="chip">M√•nad: <b id="monthLabel">‚Äî</b></div>
    <button class="btn ghost" id="clearMonth">Rensa denna m√•nad</button>
  </div>
</section>

<section class="table">
  <div class="thead">
    <div>üìÖ Dag</div>
    <div>‚è∞ Fr√•n</div>
    <div>‚è∞ Till</div>
    <div>‚òï Paus</div>
    <div>üìç Projekt/plats</div>
    <div>üìù Anteckning</div>
    <div>üì∑ Foto</div>
    <div class="right">Sum</div>
  </div>
  <div id="rows"></div>
</section>

<!-- Floating gear -->
<button class="gear" id="gear">‚öôÔ∏è</button>
<div class="menu" id="gearMenu">
  <button id="exportBtn">Exportera (JSON)</button>
  <button id="importBtn">Importera (JSON)</button>
  <button id="wipeAll">Rensa ALLT (alla m√•nader)</button>
</div>
<input type="file" id="importFile" accept="application/json" class="hide">

<!-- Watermark -->
<div class="wm">
  <div style="font-size:18px;">SEIT 1990</div>
  <div style="font-size:36px;letter-spacing:1px">TH√úRINGER</div>
  <div style="font-size:36px;letter-spacing:1px">TANNENHOF</div>
</div>

<!-- Debug panel -->
<div id="debug">
  <header class="wrap">
    <div class="head">
      <b>Fels√∂kning</b>
      <div class="actions" style="margin-left:auto">
        <button class="btn" id="fold">F√§ll in</button>
        <button class="btn" id="clearLog">Rensa</button>
      </div>
    </div>
  </header>
  <div id="log"></div>
</div>

<script>
(()=>{

  /* ---------- Helpers ---------- */
  const $ = sel => document.querySelector(sel);
  const log = (m)=>{ const t=new Date().toTimeString().slice(0,8); const el=$("#log");
    el.innerText += `[${t}] ${m}\n`; el.scrollTop = el.scrollHeight; };

  const pad = n => String(n).padStart(2,'0');
  const fmt = n => (Math.round(n*100)/100).toFixed(2);
  const monthName = (y,m)=> new Date(y,m-1,1).toLocaleDateString('sv-SE',{month:'long',year:'numeric'});

  const keyFor = (y,m)=> `tnh:${y}-${pad(m)}`;
  const daysIn = (y,m)=> new Date(y,m,0).getDate();

  function parseTime(v){
    if(!v||!v.includes(':')) return null;
    const [H,M]=v.split(':').map(Number);
    return H*60+M;
  }
  function minutesToHours(min){
    return min<=0?0:min/60;
  }

  /* ---------- State ---------- */
  const state = {
    y: new Date().getFullYear(),
    m: new Date().getMonth()+1,
    rows: [] // {d, from, to, pause, project, note, hasPhoto, sum}
  };

  function loadMonth(y,m){
    state.y=y; state.m=m;
    const k = keyFor(y,m);
    const raw = localStorage.getItem(k);
    const N = daysIn(y,m);
    state.rows = Array.from({length:N}, (_,i)=>({
      d:i+1, from:"", to:"", pause:0, project:"", note:"", hasPhoto:false, sum:0
    }));
    if(raw){
      try{
        const data = JSON.parse(raw);
        data.rows?.forEach((r,i)=>{ if(state.rows[i]) state.rows[i]=Object.assign(state.rows[i], r); });
        log(`Loaded ${k} (${state.rows.length} rader).`);
      }catch(e){ log(`Fel vid parse av ${k}: ${e}`); }
    }else{
      log(`Ny m√•nad ‚Äì f√∂rifyller ${N} dagar f√∂r ${monthName(y,m)}.`);
    }
    $("#monthLabel").innerText = monthName(y,m);
    renderRows();
    calcAll();
    save();
  }

  function save(){
    const k = keyFor(state.y,state.m);
    localStorage.setItem(k, JSON.stringify({y:state.y,m:state.m, rows:state.rows}));
  }

  /* ---------- Rendering ---------- */
  function rowTemplate(r){
    return `
    <div class="tr" data-day="${r.d}">
      <div class="day">${r.d}</div>
      <div class="pill"><input type="time" value="${r.from||''}" inputmode="numeric" /></div>
      <div class="pill"><input type="time" value="${r.to||''}" inputmode="numeric" /></div>
      <div class="pill"><input type="number" min="0" step="5" value="${r.pause||0}" /></div>
      <button class="smallbtn neutral proj">${r.project?("üìç "+escapeHtml(r.project)):"üìç Projekt/plats"}</button>
      <button class="smallbtn neutral note">${r.note?("üìù "+escapeHtml(short(r.note))):"üìù Anteckning"}</button>
      <button class="smallbtn cam">${r.hasPhoto?"üì∑ Sparad":"üì∑ Foto"}</button>
      <div class="right sum">${fmt(r.sum)}</div>
      <input class="hide file" type="file" accept="image/*;capture=camera">
    </div>`;
  }

  function renderRows(){
    const cont=$("#rows");
    cont.innerHTML = state.rows.map(rowTemplate).join("");
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function short(s){ return s.length>18? s.slice(0,18)+"‚Ä¶" : s; }

  /* ---------- Calc ---------- */
  function calcRow(i){
    const r = state.rows[i];
    const a = parseTime(r.from);
    const b = parseTime(r.to);
    let h = 0;
    if(a!=null && b!=null){
      let diff = b - a;
      if(diff<0) diff += 24*60;        // √∂ver midnatt
      diff -= (Number(r.pause)||0);
      h = minutesToHours(diff);
    }
    r.sum = Math.max(0,h);
    return r.sum;
  }
  function calcAll(){
    let tot=0;
    state.rows.forEach((_,i)=> tot += calcRow(i));
    $("#grandTotal").innerText = fmt(tot);
    // uppdatera UI-summor
    document.querySelectorAll(".tr").forEach((row,i)=>{
      row.querySelector(".sum").innerText = fmt(state.rows[i].sum);
    });
  }

  /* ---------- Events ---------- */
  $("#rows").addEventListener("input",(e)=>{
    const row = e.target.closest(".tr"); if(!row) return;
    const i = Number(row.dataset.day)-1;
    const [fromEl,toEl,pauseEl] = row.querySelectorAll("input");
    state.rows[i].from = fromEl.value;
    state.rows[i].to   = toEl.value;
    state.rows[i].pause = Number(pauseEl.value||0);
    calcRow(i); calcAll(); save();
  });

  $("#rows").addEventListener("click",(e)=>{
    const row = e.target.closest(".tr"); if(!row) return;
    const i = Number(row.dataset.day)-1;
    if(e.target.classList.contains("proj")){
      const v = prompt("Projekt/plats:", state.rows[i].project||"");
      if(v!=null){ state.rows[i].project=v; row.querySelector(".proj").textContent = v?("üìç "+v):"üìç Projekt/plats"; save(); }
    }
    if(e.target.classList.contains("note")){
      const v = prompt("Anteckning:", state.rows[i].note||"");
      if(v!=null){ state.rows[i].note=v; row.querySelector(".note").textContent = v?("üìù "+short(v)):"üìù Anteckning"; save(); }
    }
    if(e.target.classList.contains("cam")){
      row.querySelector(".file").click();
    }
  });

  $("#rows").addEventListener("change", async (e)=>{
    if(e.target.classList.contains("file")){
      const row = e.target.closest(".tr"); const i = Number(row.dataset.day)-1;
      const file = e.target.files?.[0];
      if(!file){ return; }
      try{
        // Vi lagrar bara en flagga (ej bilden) f√∂r att spara utrymme
        state.rows[i].hasPhoto = true;
        row.querySelector(".cam").textContent = "üì∑ Sparad";
        save(); log(`Foto markerat f√∂r dag ${i+1} (lagrar ej bin√§rfil i localStorage).`);
      }catch(err){ log("Fel vid foto: "+err); }
    }
  });

  $("#prevBtn").onclick=()=>{ const d=new Date(state.y,state.m-2,1); loadMonth(d.getFullYear(), d.getMonth()+1); log(`Bytte till ${monthName(state.y,state.m)}.`); };
  $("#nextBtn").onclick=()=>{ const d=new Date(state.y,state.m,1);   loadMonth(d.getFullYear(), d.getMonth()+1); log(`Bytte till ${monthName(state.y,state.m)}.`); };
  $("#clearMonth").onclick=()=>{ if(confirm("Rensa alla rader denna m√•nad?")){ localStorage.removeItem(keyFor(state.y,state.m)); loadMonth(state.y,state.m); log("Rensade denna m√•nad."); } };

  // Gear menu
  const menu=$("#gearMenu"); $("#gear").onclick=()=>{ menu.style.display = (menu.style.display==='block'?'none':'block'); };
  document.addEventListener("click",(e)=>{ if(!e.target.closest('.gear') && !e.target.closest('#gearMenu')) menu.style.display='none'; });

  $("#exportBtn").onclick=()=>{
    const all = {...localStorage};
    const blob = new Blob([JSON.stringify(all,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tannenhof-tidsdata.json'; a.click();
    log("Export gjord.");
  };
  $("#importBtn").onclick=()=> $("#importFile").click();
  $("#importFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const text = await f.text();
    try{
      const obj = JSON.parse(text);
      Object.keys(obj).forEach(k=> localStorage.setItem(k, obj[k]));
      log("Import klar. Laddar om aktuell m√•nad.");
      loadMonth(state.y,state.m);
    }catch(err){ log("Fel vid import: "+err); }
  });
  $("#wipeAll").onclick=()=>{
    if(confirm("Rensa ALLT (alla m√•nader)?")){ Object.keys(localStorage).forEach(k=>{ if(k.startsWith('tnh:')) localStorage.removeItem(k); });
      log("Allt rensat."); loadMonth(state.y,state.m); }
  };

  // Debug controls
  $("#fold").onclick=()=>{ const logEl=$("#log"); logEl.classList.toggle('hide'); $("#fold").textContent = logEl.classList.contains('hide') ? "F√§ll ut" : "F√§ll in"; };
  $("#clearLog").onclick=()=> $("#log").textContent="";

  // Share & PDF
  $("#shareBtn").onclick=async ()=>{
    try{
      const url=location.href;
      if(navigator.share){ await navigator.share({title:document.title,text:"Tidsrapport",url}); log("Delning ok."); }
      else { await navigator.clipboard.writeText(url); alert("L√§nk kopierad."); log("Delning: kopierad l√§nk."); }
    }catch{ log("Delning avbruten."); }
  };
  $("#pdfBtn").onclick=()=>{ log("Skapar PDF‚Ä¶"); window.print(); log("PDF klar."); };

  // Init
  const now = new Date();
  loadMonth(now.getFullYear(), now.getMonth()+1);
  log(`App start OK. M√•nad: ${state.y}-${pad(state.m)}`);

})();
</script>
</body>
</html>
