<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thüringer Tannenhof – Tidsrapport</title>
<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{
  --g:#0f5f2f; --g2:#0b4b24; --g3:#e9f4ee; --ink:#10261a; --muted:#6c7b73; --danger:#b73a35;
  --radius:18px;
}
*{box-sizing:border-box}
html,body{margin:0;background:#f4f8f6;color:var(--ink);font:16px system-ui, Segoe UI, Inter, Roboto, Arial}
a{color:inherit}
.container{max-width:1100px;margin:0 auto;padding:0 14px}

/* Header */
.header{position:sticky;top:0;z-index:8;background:linear-gradient(180deg,var(--g),var(--g2));color:#fff;border-bottom:3px solid #083a1d}
.header .row{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:12px 10px}
.brand{display:flex;align-items:center;gap:12px}
.brand .logo{width:42px;height:42px;border-radius:12px;background:#fff;display:grid;place-items:center}
.brand .logo img{width:30px;height:30px}
.header .actions{display:flex;gap:10px}
.badge{background:#fff;color:var(--g);border:none;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.badge:active{transform:scale(.98)}

/* Top panel */
.card{background:#fff;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.08);padding:14px;margin:14px 0}
.controls{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.pill{background:var(--g3);padding:10px 14px;border-radius:999px;font-weight:700;display:flex;gap:10px;align-items:center}
.pill strong{font-size:1.25rem}
.iconbtn{width:46px;height:46px;border-radius:12px;background:var(--g);color:#fff;border:none;font-size:18px;cursor:pointer}
.iconbtn:active{transform:translateY(1px)}
.btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-ghost{background:#eef4f1}
.btn-danger{background:var(--danger);color:#fff}

/* Month title */
.h3{margin:10px 4px 8px;color:#1b3a2a;font-weight:800}

/* Table */
.tableWrap{border-radius:var(--radius);overflow:auto;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.04)}
table{width:100%;min-width:920px;border-collapse:separate;border-spacing:0}
thead th{position:sticky;top:0;background:#f0f6f2;color:#254;text-align:left;padding:12px 10px}
tbody td{padding:8px 10px;border-top:1px solid #eef2ef}
tbody tr:nth-child(odd){background:#fcfdfc}
.dayCell{width:60px;color:#1e3829;font-weight:700}
.timeSel, .breakSel{width:100%;height:44px;border:1px solid #dfe7e2;border-radius:10px;background:#fff;padding:0 10px;font-size:16px}
.totalCell{font-weight:800}
.actionsCell button{margin-right:8px}

/* Signature section */
.sigs{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.sigBox{background:#fff;border:1px solid #e4ebe6;border-radius:14px;padding:10px}
.sigTitle{margin:0 0 6px;font-weight:800;color:#163b29}
.sigCanvas{width:100%;height:140px;border-radius:10px;border:1px dashed #cfdad3;background:#fbfffd}
.sigBtns{display:flex;gap:10px;margin-top:6px}

/* Watermark bottom-right */
.watermark{position:fixed;right:14px;bottom:14px;z-index:0;opacity:.08;pointer-events:none;background:url('tnh-tree-512.png') no-repeat center/contain;width:220px;height:220px;filter:grayscale(.1)}
@media (max-width:520px){ .watermark{width:160px;height:160px;bottom:80px} }

/* Debug log */
.debug{position:fixed;left:10px;bottom:10px;z-index:9;background:var(--g);color:#fff;padding:8px 10px;border-radius:12px;max-width:92vw;width:360px;box-shadow:0 12px 24px rgba(0,0,0,.25);font-family:ui-monospace,Consolas,Menlo}
.debug header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.debug .log{max-height:160px;overflow:auto;background:#06361c;border-radius:8px;padding:6px}
.debug .log p{margin:0 0 2px;font-size:12px;white-space:pre}

/* Settings FAB + modal */
.fab{position:fixed;right:16px;bottom:16px;width:66px;height:66px;border-radius:20px;background:var(--g);color:#fff;border:none;font-size:28px;box-shadow:0 14px 28px rgba(0,0,0,.25);cursor:pointer;z-index:10}
.fab:active{transform:translateY(1px)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:11}
.modal .sheet{background:#fff;border-radius:16px;max-width:560px;width:100%;padding:16px}
.rowBetween{display:flex;align-items:center;justify-content:space-between;gap:12px}
.switch{appearance:none;width:52px;height:28px;border-radius:999px;background:#d6e3dc;position:relative;cursor:pointer;outline:0}
.switch:checked{background:var(--g)}
.switch:before{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:.2s}
.switch:checked:before{left:27px}
.note{color:#6a7a71;font-size:.95rem}
.footer-note{color:var(--muted);text-align:center;font-size:.9rem;margin-top:6px}
</style>
</head>
<body>

  <div class="header">
    <div class="row container">
      <div class="brand">
        <div class="logo"><img src="tnh-tree-192.png" alt="TN"></div>
        <div>
          <div style="font-weight:900">Thüringer Tannenhof</div>
          <div style="opacity:.9">Tidsrapport</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnShare" class="badge">Dela / Skicka</button>
        <button id="btnPdf" class="badge">Skriv ut / PDF</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="controls">
        <div class="pill">Totalt – <strong id="grandTotal">0.00</strong></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="iconbtn" id="btnPrev" title="Föregående månad">«</button>
          <button class="iconbtn" id="btnNext" title="Nästa månad">»</button>
          <button id="btnToday" class="btn" style="background:var(--g);color:#fff">+ Lägg till rad för idag</button>
          <button id="btnClearMonth" class="btn btn-ghost">Rensa denna månad</button>
        </div>
      </div>

      <h3 class="h3" id="monthTitle">oktober 2025</h3>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:64px">Dag</th>
              <th style="width:90px">Datum</th>
              <th style="width:220px">Från</th>
              <th style="width:220px">Till</th>
              <th style="width:130px">Paus (min)</th>
              <th style="width:120px">Total</th>
              <th style="width:240px">Åtgärder</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="sigWrap" class="sigs" style="display:none">
        <div class="sigBox">
          <p class="sigTitle">Signatur – Medarbetare</p>
          <canvas id="sigEmp" class="sigCanvas"></canvas>
          <div class="sigBtns">
            <button class="btn btn-ghost" id="sigEmpClr">Rensa</button>
          </div>
        </div>
        <div class="sigBox">
          <p class="sigTitle">Signatur – Chef</p>
          <canvas id="sigMgr" class="sigCanvas"></canvas>
          <div class="sigBtns">
            <button class="btn btn-ghost" id="sigMgrClr">Rensa</button>
          </div>
        </div>
      </div>

      <p class="footer-note">Allt sparas automatiskt i denna enhet. Vattenstämpeln syns inte i PDF.</p>
    </div>
  </div>

  <div class="watermark" id="watermark"></div>

  <!-- Felsökning -->
  <div class="debug" id="debugBox">
    <header>
      <strong>Felsökning</strong>
      <div>
        <button class="btn btn-ghost" id="btnFold">Fäll in</button>
        <button class="btn btn-ghost" id="btnLogClear">Rensa</button>
      </div>
    </header>
    <div class="log" id="log"></div>
  </div>

  <!-- Kugghjul -->
  <button class="fab" id="btnSettings" title="Inställningar">⚙️</button>

  <!-- Inställningar -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="rowBetween">
        <h3 style="margin:0">Inställningar</h3>
        <button class="btn btn-ghost" id="closeModal">Stäng</button>
      </div>
      <div style="display:grid;gap:12px;margin-top:10px">
        <label class="rowBetween">Visa felsökningslista
          <input type="checkbox" id="swDebug" class="switch">
        </label>
        <label class="rowBetween">Visa signaturrutor
          <input type="checkbox" id="swSigs" class="switch">
        </label>
        <label class="rowBetween">Förifyll månadens alla dagar
          <input type="checkbox" id="swAutofill" class="switch">
        </label>
        <label class="rowBetween">Visa vattenstämpel
          <input type="checkbox" id="swWater" class="switch">
        </label>
      </div>
      <p class="note" style="margin-top:8px">Tips: Om något låser sig, öppna inställningar och stäng av/på förifyllnad eller rensa månaden – allt ligger per månad i din webbläsare.</p>
    </div>
  </div>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(()=>{
/*** ========= Utilities & state ========= ***/
const $=s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,"0");
const log=m=>{const t=new Date().toTimeString().slice(0,8); $("#log").insertAdjacentHTML("beforeend",`<p>[${t}] ${m}</p>`); $("#log").scrollTop=9e9;}

let cur=new Date(); cur.setDate(1); cur.setHours(12,0,0,0);
const storageKey=()=>`tnh:${cur.getFullYear()}-${pad(cur.getMonth()+1)}`;
const monthLabel=d=>d.toLocaleDateString("sv-SE",{month:"long",year:"numeric"});
const weekdayShort=d=>d.toLocaleDateString("sv-SE",{weekday:"short"});

/*** ========= Data shape ========= ***/
function seedMonth(d){
  const y=d.getFullYear(), m=d.getMonth();
  const last=new Date(y,m+1,0).getDate();
  const rows=[];
  for(let day=1; day<=last; day++){
    const iso=`${y}-${pad(m+1)}-${pad(day)}`;
    rows.push({date:iso,start:"",end:"",breakMin:0,total:"0.00"});
  }
  return rows;
}
function loadRows(){
  const raw=localStorage.getItem(storageKey());
  if(raw){ const data=JSON.parse(raw); log(`Loaded ${storageKey()} (${data.rows.length} rader).`); return data.rows; }
  const auto=JSON.parse(localStorage.getItem("tnh:autofill")||"true");
  const rows= auto ? seedMonth(cur) : [];
  saveRows(rows);
  if(auto) log(`Ny månad – förifyller ${rows.length} dagar för ${storageKey()}.`);
  return rows;
}
function saveRows(rows){ localStorage.setItem(storageKey(), JSON.stringify({rows})); }

/*** ========= Select options ========= ***/
const timeOptions = (()=> {
  const opts = ['<option value=""></option>'];
  for(let h=0; h<24; h++){
    for(let m=0; m<60; m+=15){
      const v=`${pad(h)}:${pad(m)}`;
      opts.push(`<option value="${v}">${v}</option>`);
    }
  }
  return opts.join("");
})();
const breakOptions = [0,10,15,20,30,45,60,75,90,105,120].map(v=>`<option value="${v}">${v}</option>`).join("");

/*** ========= Calculations ========= ***/
function calcTotal(start,end,breakMin){
  if(!start||!end) return "0.00";
  const [sh,sm]=start.split(":").map(Number);
  const [eh,em]=end.split(":").map(Number);
  let diff=(eh*60+em)-(sh*60+sm);
  if(diff<0) diff+=1440;
  diff -= Number(breakMin||0);
  const hrs=Math.max(0,diff)/60;
  return hrs.toFixed(2);
}

/*** ========= Render ========= ***/
function render(){
  $("#monthTitle").textContent = monthLabel(cur);
  const rows = loadRows();
  const tb = $("#tbody");
  tb.innerHTML="";
  let sum=0;

  rows.forEach((r,idx)=>{
    r.total = calcTotal(r.start,r.end,r.breakMin);
    sum += Number(r.total)||0;
    const d = new Date(r.date);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="dayCell">${weekdayShort(d)}<br>${pad(d.getDate())}</td>
      <td>${r.date}</td>
      <td><select class="timeSel" data-idx="${idx}" data-k="start">${timeOptions}</select></td>
      <td><select class="timeSel" data-idx="${idx}" data-k="end">${timeOptions}</select></td>
      <td><select class="breakSel" data-idx="${idx}" data-k="breakMin">${breakOptions}</select></td>
      <td class="totalCell" id="tot-${idx}">${r.total}</td>
      <td class="actionsCell">
        <button class="btn btn-ghost" data-act="dup" data-idx="${idx}">Duplicera</button>
        <button class="btn btn-danger" data-act="del" data-idx="${idx}">Ta bort</button>
      </td>
    `;
    tb.appendChild(tr);
    const s1 = tr.querySelector(`[data-k="start"]`);
    const s2 = tr.querySelector(`[data-k="end"]`);
    const sb = tr.querySelector(`[data-k="breakMin"]`);
    s1.value = r.start||"";
    s2.value = r.end||"";
    sb.value = Number(r.breakMin)||0;
  });

  $("#grandTotal").textContent = sum.toFixed(2);
  saveRows(rows);
}

/*** ========= Events ========= ***/
$("#tbody").addEventListener("change",(e)=>{
  const t=e.target;
  if(!t.dataset.idx) return;
  const idx=+t.dataset.idx, k=t.dataset.k;
  const rows=loadRows();
  let v = t.value;
  if(k==="breakMin") v = Number(v||0);
  rows[idx][k] = v;
  rows[idx].total = calcTotal(rows[idx].start, rows[idx].end, rows[idx].breakMin);
  $("#tot-"+idx).textContent = rows[idx].total;
  const sum=rows.reduce((a,b)=>a+(+b.total||0),0);
  $("#grandTotal").textContent = sum.toFixed(2);
  saveRows(rows);
});
$("#tbody").addEventListener("click",(e)=>{
  const btn = e.target.closest("button"); if(!btn) return;
  const idx = +btn.dataset.idx; const act = btn.dataset.act;
  const rows = loadRows();
  if(act==="del"){ rows.splice(idx,1); saveRows(rows); render(); log(`Rad ${idx+1} togs bort.`); }
  if(act==="dup"){ rows.splice(idx+1,0,JSON.parse(JSON.stringify(rows[idx]))); saveRows(rows); render(); log(`Rad ${idx+1} duplicerades.`); }
});

$("#btnPrev").onclick=()=>{ cur.setMonth(cur.getMonth()-1); render(); log(`Bytte till ${monthLabel(cur)}.`); };
$("#btnNext").onclick=()=>{ cur.setMonth(cur.getMonth()+1); render(); log(`Bytte till ${monthLabel(cur)}.`); };
$("#btnClearMonth").onclick=()=>{ if(confirm("Rensa alla rader denna månad?")){ localStorage.removeItem(storageKey()); render(); log("Månad rensad & återskapad."); } };
$("#btnToday").onclick=()=>{
  const rows=loadRows(); const iso=new Date().toISOString().slice(0,10);
  rows.push({date:iso,start:"",end:"",breakMin:0,total:"0.00"});
  saveRows(rows); render(); log("La till rad för idag.");
};

/*** ========= Share & PDF ========= ***/
$("#btnShare").onclick=async()=>{
  try{
    if(navigator.share){ await navigator.share({title:document.title,text:"Tidsrapport",url:location.href}); }
    else{ await navigator.clipboard.writeText(location.href); alert("Länk kopierad!"); }
    log("Delning ok.");
  }catch{ log("Delning avbruten."); }
};
$("#btnPdf").onclick=async()=>{
  log("Skapar PDF…");
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF({unit:"pt",format:"a4"});
  const card=document.querySelector(".card");
  $("#watermark").style.display="none"; // göm i PDF
  const canvas=await html2canvas(card,{scale:2,backgroundColor:"#ffffff"});
  $("#watermark").style.display = JSON.parse(localStorage.getItem("tnh:water")||"true") ? "block":"none";
  const availW = pdf.internal.pageSize.getWidth()-40;
  const imgH = availW*(canvas.height/canvas.width);
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",20,20,availW,imgH);
  pdf.save(`tidsrapport-${storageKey().slice(4)}.pdf`);
  log("PDF klar.");
};

/*** ========= Debug UI ========= ***/
$("#btnFold").onclick=()=>{const box=$("#log"); const b=$("#btnFold"); if(box.style.display==="none"){box.style.display="block"; b.textContent="Fäll in";} else {box.style.display="none"; b.textContent="Visa";}};
$("#btnLogClear").onclick=()=>{$("#log").innerHTML="";};

/*** ========= Settings ========= ***/
const modal=$("#modal");
$("#btnSettings").onclick=()=>{ modal.style.display="flex"; syncSwitches(); };
$("#closeModal").onclick=()=>modal.style.display="none";
modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.style.display="none"; });

function syncSwitches(){
  $("#swDebug").checked  = JSON.parse(localStorage.getItem("tnh:debug") || "true");
  $("#swSigs").checked   = JSON.parse(localStorage.getItem("tnh:sigs")  || "false");
  $("#swAutofill").checked = JSON.parse(localStorage.getItem("tnh:autofill") || "true");
  $("#swWater").checked = JSON.parse(localStorage.getItem("tnh:water") || "true");
  $("#debugBox").style.display = $("#swDebug").checked ? "block" : "none";
  $("#sigWrap").style.display  = $("#swSigs").checked  ? "grid"  : "none";
  $("#watermark").style.display= $("#swWater").checked ? "block" : "none";
}
["swDebug","swSigs","swAutofill","swWater"].forEach(id=>{
  $("#"+id).addEventListener("change",e=>{
    const map={swDebug:"tnh:debug",swSigs:"tnh:sigs",swAutofill:"tnh:autofill",swWater:"tnh:water"};
    localStorage.setItem(map[id], JSON.stringify(e.target.checked));
    syncSwitches();
    log(`Inställning ändrad: ${id} = ${e.target.checked}`);
  });
});

/*** ========= Signatures (rit-läge + persist) ========= ***/
function initSig(canvasId,clearId,storeKey){
  const c=$(canvasId), ctx=c.getContext("2d");
  function size(){ const dpr=window.devicePixelRatio||1; c.width=c.clientWidth*dpr; c.height=c.clientHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
  size(); window.addEventListener("resize",size);
  let draw=false, x=0, y=0;
  c.addEventListener("pointerdown",e=>{draw=true; const r=c.getBoundingClientRect(); x=e.clientX-r.left; y=e.clientY-r.top;});
  c.addEventListener("pointermove",e=>{ if(!draw) return; const r=c.getBoundingClientRect(); ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="#0a3"; ctx.beginPath(); ctx.moveTo(x,y); x=e.clientX-r.left; y=e.clientY-r.top; ctx.lineTo(x,y); ctx.stroke(); });
  window.addEventListener("pointerup",()=>{ if(!draw) return; draw=false; localStorage.setItem(storeKey, c.toDataURL()); log(`Signature saved: ${storeKey}`);});
  const saved=localStorage.getItem(storeKey); if(saved){ const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,c.clientWidth,c.clientHeight); img.src=saved; }
  $(clearId).onclick=()=>{ ctx.clearRect(0,0,c.clientWidth,c.clientHeight); localStorage.removeItem(storeKey); log(`Signature cleared: ${storeKey}`); };
}
initSig("#sigEmp","#sigEmpClr","sigEmp");
initSig("#sigMgr","#sigMgrClr","sigMgr");

/*** ========= Init ========= ***/
render();
syncSwitches();
log(`App start OK. Månad: ${storageKey().slice(4)}`);
})();
</script>
</body>
</html>
