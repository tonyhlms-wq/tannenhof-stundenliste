<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Th√ºringer Tannenhof ‚Äì Tidsrapport</title>
<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#114a2b">
<style>
:root{
  --bg:#eef5f1; --card:#ffffff; --text:#0b2a19; --muted:#486557;
  --brand:#164c2e; --brand-2:#2a6b45; --accent:#dfe7e2; --danger:#b73a35;
}
[data-theme="camouflage"]{
  --bg:#e8efe7; --card:#ffffff; --text:#0a2415; --muted:#445b4f;
  --brand:#2d3f2f; --brand-2:#4a6a3f; --accent:#dbe3d9;
}
[data-theme="dark"]{
  --bg:#0e1512; --card:#131d19; --text:#dfeae5; --muted:#97b1a6;
  --brand:#1c6b3f; --brand-2:#2fa368; --accent:#25352f;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{
  position:sticky;top:0;z-index:10;background:var(--brand);
  color:#fff;display:flex;align-items:center;gap:14px;padding:10px 14px;box-shadow:0 2px 6px rgba(0,0,0,.15)
}
.logo{width:42px;height:42px;border-radius:12px;background:#edfff5 url('tnh-tree-192.png') center/70% no-repeat}
.title{font-weight:800;font-size:20px}
.spacer{flex:1}
.btn{
  background:#fff;color:var(--brand);border:none;border-radius:14px;
  padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.05)
}
.btn:active{transform:translateY(1px)}
.btn-ghost{background:var(--accent);color:var(--text)}
.btn-danger{background:var(--danger);color:#fff}
.wrap{max-width:1100px;margin:18px auto;padding:0 14px}
.card{background:var(--card);border:1px solid var(--accent);border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.topbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
.total{display:inline-flex;align-items:center;gap:10px;background:var(--accent);border-radius:16px;padding:12px 16px;font-size:22px;font-weight:800}
.navbtn{width:56px;height:56px;border-radius:14px;background:var(--brand);color:#fff;border:none;font-size:20px;font-weight:900}
.monthTitle{background:#f5faf8;border-radius:16px;padding:10px 14px;margin:16px 0;font-size:28px;font-weight:800}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th{color:var(--muted);font-weight:800;text-align:left;padding:6px 10px}
.row{background:var(--card);border:1px solid var(--accent);border-radius:14px;overflow:hidden}
.row td{padding:10px}
.select, .timeSel, .breakSel, .commentInput{
  width:100%;height:44px;border:1px solid var(--accent);border-radius:10px;background:#fff;padding:0 10px;font-size:16px
}
.timeSel,.breakSel{appearance:none;background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="%23666666"><path d="M7 10l5 5 5-5z"/></svg>') right 8px center/18px no-repeat;padding-right:38px}
.dayCell{font-weight:700}
.cameraCell{display:flex;align-items:center;gap:10px;min-width:160px}
.camBtn{border:none;border-radius:10px;background:#eef4f1;padding:10px 12px;cursor:pointer;font-weight:700}
.thumbs{display:flex;gap:8px;flex-wrap:wrap}
.thumb{position:relative;width:48px;height:48px;border-radius:8px;overflow:hidden;border:1px solid var(--accent)}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb .del{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border:none;border-radius:999px;width:20px;height:20px;line-height:18px;font-size:12px;cursor:pointer}
.actionsCell{display:flex;gap:8px;flex-wrap:wrap}
.badge{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:var(--accent);font-weight:700}
.footerCard{margin-top:14px;display:grid;gap:14px}
.grid2{display:grid;grid-template-columns:1fr;gap:14px}
@media (min-width:760px){.grid2{grid-template-columns:1fr 1fr}}
.signBox{background:var(--card);border:1px solid var(--accent);border-radius:14px;padding:12px}
.signTitle{font-weight:800;margin-bottom:8px}
.signPad{width:100%;height:140px;border:1px dashed var(--accent);border-radius:12px;background:#fff;touch-action:none}
.watermark{
  position:fixed;right:18px;bottom:18px;width:200px;height:140px;opacity:.12;
  background:url('tnh-tree-512.png') center/contain no-repeat;pointer-events:none
}
/* FELS√ñKNING */
#debugBox{position:fixed;left:14px;bottom:14px;z-index:20;background:var(--brand);color:#fff;border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.25);min-width:260px;max-width:95vw}
#debugHead{display:flex;align-items:center;gap:10px;padding:10px 12px}
#debugHead .title{font-size:16px}
#debugBody{max-height:40vh;overflow:auto;background:#0d2117;padding:10px;border-radius:0 0 14px 14px;font-family:ui-monospace,Consolas,monospace;font-size:13px}
#gear{position:fixed;right:18px;bottom:18px;width:64px;height:64px;border-radius:18px;background:var(--brand);color:#fff;border:none;font-weight:900;font-size:22px;box-shadow:0 10px 18px rgba(0,0,0,.25)}
/* MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:30}
.modal .panel{width:min(720px,94vw);background:var(--card);color:var(--text);border-radius:18px;border:1px solid var(--accent);padding:16px}
.modal h3{margin:0 0 10px 0}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.label{font-weight:700;width:170px}
</style>
</head>
<body data-theme="default">
<header>
  <div class="logo" id="logoBox"></div>
  <div class="title">Th√ºringer Tannenhof ‚Äì Tidsrapport</div>
  <div class="spacer"></div>
  <button class="btn" id="shareBtn">Dela</button>
  <button class="btn" id="pdfBtn">PDF</button>
</header>

<div class="wrap">
  <div class="card topbar">
    <div class="total">Totalt ‚Äì <span id="totalHours">0.00</span></div>
    <button class="navbtn" id="prevMon">¬´</button>
    <button class="navbtn" id="nextMon">¬ª</button>
    <button class="btn" id="addToday">+ L√§gg till rad f√∂r idag</button>
    <button class="btn-ghost btn" id="clearMonth">Rensa denna m√•nad</button>
  </div>

  <div class="monthTitle" id="monthTitle">oktober 2025</div>

  <table class="table">
    <thead>
      <tr>
        <th>Dag</th><th>Datum</th>
        <th>Fr√•n</th><th>Till</th><th>Paus (min)</th>
        <th>Kommentar</th><th>Foto</th>
        <th>Total</th><th>√Ötg√§rder</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footerCard grid2">
    <div class="signBox">
      <div class="signTitle">Signatur ‚Äì Medarbetare</div>
      <canvas id="sigEmp" class="signPad"></canvas>
      <div class="flex"><button class="btn-ghost btn" data-clear="sigEmp">Rensa</button></div>
    </div>
    <div class="signBox">
      <div class="signTitle">Signatur ‚Äì Chef</div>
      <canvas id="sigBoss" class="signPad"></canvas>
      <div class="flex"><button class="btn-ghost btn" data-clear="sigBoss">Rensa</button></div>
    </div>
  </div>
</div>

<!-- Watermark -->
<div class="watermark" id="wm"></div>

<!-- Fels√∂kning -->
<div id="debugBox">
  <div id="debugHead">
    <div class="title">Fels√∂kning</div>
    <div class="spacer"></div>
    <button class="btn-ghost btn" id="dbgToggle">F√§ll in</button>
    <button class="btn-ghost btn" id="dbgClear">Rensa</button>
  </div>
  <div id="debugBody"></div>
</div>

<!-- Gear -->
<button id="gear">‚öôÔ∏è</button>

<!-- Inst√§llningar -->
<div class="modal" id="settings">
  <div class="panel">
    <h3>Inst√§llningar</h3>
    <div class="flex"><div class="label">Tema</div>
      <select id="themeSel" class="select">
        <option value="default">Gr√∂n (standard)</option>
        <option value="camouflage">Camouflage</option>
        <option value="dark">M√∂rk</option>
      </select>
    </div>
    <div class="flex"><div class="label">Visa fels√∂kning</div>
      <input type="checkbox" id="showDebug">
    </div>
    <div class="flex"><div class="label">Vattenst√§mpel</div>
      <input type="checkbox" id="showWM" checked>
    </div>
    <div class="flex"><div class="label">Inkludera foton i PDF</div>
      <input type="checkbox" id="pdfPhotos" checked>
    </div>
    <div class="flex"><div class="label">Byt logga</div>
      <input type="file" id="logoPicker" accept="image/*">
    </div>
    <div class="flex"><button class="btn-danger btn" id="resetApp">√Öterst√§ll allt</button>
      <div class="spacer"></div>
      <button class="btn-ghost btn" id="closeSettings">St√§ng</button>
    </div>
  </div>
</div>

<!-- libs f√∂r PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5aQm3l7H6w8n4mJQ2qgD1h3TQ4qjv1c9g9gkS8lH9m6t8HkY3L+8Z9qN+4M8C5Jp0J1fQyM1sQ0D1k7vYkw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkqN5m2h5aN0d5q8eULeC2FJxwGk2s1m4n7z3Q5S6ZbGm0xS8y0+qQkQF3dF0qR9h6Qn6hQ2Hq1g8fQZ3yQwNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ====== Hj√§lp ====== */
const $=sel=>document.querySelector(sel);
const pad = n => String(n).padStart(2,'0');
const weekday = d => ["s√∂n","m√•n","tis","ons","tors","fre","l√∂r"][d.getDay()];
const monthName = (y,m)=> new Date(y,m,1).toLocaleDateString('sv-SE',{month:'long',year:'numeric'});
const timeOpts = ()=>{ let s=''; for(let h=0; h<24; h++){ for(let m=0;m<60;m+=5){ const t=`${pad(h)}:${pad(m)}`; s+=`<option value="${t}">${t}</option>` } } return s; };
const breakOpts = ()=>[0,5,10,15,20,30,45,60,90,120].map(x=>`<option value="${x}">${x}</option>`).join('');

/* ====== Logg ====== */
function log(msg){
  const t = new Date().toTimeString().slice(0,8);
  $("#debugBody").insertAdjacentHTML('beforeend',`<div>[${t}] ${msg}</div>`);
  $("#debugBody").scrollTop = $("#debugBody").scrollHeight;
}

/* ====== State per m√•nad ====== */
let cur = new Date();
let timeOptions = timeOpts();
let breakOptions = breakOpts();

function keyFor(y,m){ return `tnh:${y}-${pad(m+1)}`; }

function loadRows(d=cur){
  const y=d.getFullYear(), m=d.getMonth();
  const k = keyFor(y,m);
  const raw = localStorage.getItem(k);
  let rows = raw ? JSON.parse(raw) : seedMonth(d);
  // normalisera
  rows.forEach(r=>{
    if(typeof r.comment!=="string") r.comment="";
    if(!Array.isArray(r.photos)) r.photos=[];
    if(typeof r.breakMin==="string") r.breakMin = (+r.breakMin)||0;
    if(typeof r.total!=="string") r.total="0.00";
  });
  return rows;
}
function saveRows(rows, d=cur){
  const y=d.getFullYear(), m=d.getMonth();
  localStorage.setItem(keyFor(y,m), JSON.stringify(rows));
  updateTotal(rows);
}
function seedMonth(d){
  const y=d.getFullYear(), m=d.getMonth();
  const last=new Date(y,m+1,0).getDate();
  const out=[];
  for(let day=1; day<=last; day++){
    const iso=`${y}-${pad(m+1)}-${pad(day)}`;
    out.push({date:iso,start:"",end:"",breakMin:0,total:"0.00",comment:"",photos:[]});
  }
  log(`Ny m√•nad ‚Äì f√∂rifyller ${last} dagar f√∂r ${monthName(y,m)}.`);
  return out;
}

/* ====== Render ====== */
function render(){
  $("#monthTitle").textContent = monthName(cur.getFullYear(), cur.getMonth());
  const rows = loadRows();
  const tb = $("#tbody"); tb.innerHTML="";
  rows.forEach((r,idx)=>{
    const d = new Date(r.date);
    const tr = document.createElement('tr'); tr.className='row';
    tr.innerHTML = `
      <td class="dayCell">${weekday(d)}</td>
      <td>${r.date}</td>
      <td><select class="timeSel" data-idx="${idx}" data-k="start">${timeOptions}</select></td>
      <td><select class="timeSel" data-idx="${idx}" data-k="end">${timeOptions}</select></td>
      <td><select class="breakSel" data-idx="${idx}" data-k="breakMin">${breakOptions}</select></td>
      <td><input class="commentInput" placeholder="Kommentar‚Ä¶" value="${r.comment||""}" data-idx="${idx}" data-k="comment"></td>
      <td class="cameraCell">
        <label class="camBtn">üì∑ Kamera
          <input type="file" accept="image/*" capture="environment" data-idx="${idx}" data-act="cam" style="display:none">
        </label>
        <div class="thumbs" id="th-${idx}"></div>
      </td>
      <td class="totalCell" id="tot-${idx}">${r.total}</td>
      <td class="actionsCell">
        <button class="btn-ghost btn" data-act="dup" data-idx="${idx}">Duplicera</button>
        <button class="btn-danger btn" data-act="del" data-idx="${idx}">Ta bort</button>
      </td>`;
    tb.appendChild(tr);
    // f√∂rinst√§ll
    tr.querySelector(`select[data-idx="${idx}"][data-k="start"]`).value = r.start||"";
    tr.querySelector(`select[data-idx="${idx}"][data-k="end"]`).value = r.end||"";
    tr.querySelector(`select[data-idx="${idx}"][data-k="breakMin"]`).value = r.breakMin||0;
    renderThumbs(idx, r.photos);
  });
  updateTotal(rows);
}
function updateTotal(rows){
  const sum = (rows||loadRows()).reduce((s,r)=>s+parseFloat(r.total||0),0);
  $("#totalHours").textContent = sum.toFixed(2);
}

/* ====== H√§ndelser i tabellen ====== */
$("#tbody").addEventListener("change", e=>{
  const t=e.target; const idx=+t.dataset.idx; const k=t.dataset.k;
  let rows=loadRows();
  if(k==="start"||k==="end"||k==="breakMin"){
    rows[idx][k] = k==="breakMin" ? (+t.value||0) : t.value;
    rows[idx].total = calcTotal(rows[idx].start, rows[idx].end, rows[idx].breakMin);
    $("#tot-"+idx).textContent = rows[idx].total;
    saveRows(rows);
    log(`Rad ${idx+1} uppdaterad (${k}). Total: ${rows[idx].total}`);
    return;
  }
  if(k==="comment"){
    rows[idx].comment = t.value||"";
    saveRows(rows);
    log(`Kommentar sparad p√• rad ${idx+1}.`);
    return;
  }
});
$("#tbody").addEventListener("click", e=>{
  const act = e.target.dataset.act;
  if(!act) return;
  const idx = +e.target.dataset.idx;
  let rows = loadRows();
  if(act==="dup"){
    rows.splice(idx+1,0, JSON.parse(JSON.stringify(rows[idx])));
    saveRows(rows); render(); log(`Rad ${idx+1} duplicerades.`);
  }
  if(act==="del"){
    rows.splice(idx,1); saveRows(rows); render(); log(`Rad ${idx+1} togs bort.`);
  }
});
$("#tbody").addEventListener("change", e=>{
  const input = e.target;
  if(input.dataset.act==="cam"){
    const idx=+input.dataset.idx; const file=input.files?.[0];
    if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      const rows=loadRows();
      const arr=rows[idx].photos||(rows[idx].photos=[]);
      if(arr.length>=4) arr.shift();
      arr.push(r.result);
      saveRows(rows); renderThumbs(idx,arr);
      log(`Foto tillagt p√• rad ${idx+1}.`);
    };
    r.readAsDataURL(file);
    input.value="";
  }
});
$("#tbody").addEventListener("click", e=>{
  const del=e.target.closest(".del");
  if(del){
    const idx=+del.dataset.idx, p=+del.dataset.p;
    const rows=loadRows(); rows[idx].photos.splice(p,1);
    saveRows(rows); renderThumbs(idx, rows[idx].photos);
    log(`Foto borttaget p√• rad ${idx+1}.`);
    return;
  }
  const img=e.target.closest(".thumb img");
  if(img){
    const w=window.open(); w.document.write(`<img src="${img.getAttribute('src')}" style="max-width:100%">`);
  }
});
function renderThumbs(idx, photos){
  const box = document.getElementById(`th-${idx}`); if(!box) return;
  box.innerHTML = (photos||[]).map((src,i)=>`
    <div class="thumb">
      <img src="${src}">
      <button class="del" title="Ta bort" data-idx="${idx}" data-p="${i}">√ó</button>
    </div>`).join("");
}

/* ====== Ber√§kning ====== */
function calcTotal(start,end,breakMin){
  if(!start||!end) return "0.00";
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  let mins=(eh*60+em)-(sh*60+sm)-(+breakMin||0);
  if(mins<0) mins+=24*60; // nattpass
  return (mins/60).toFixed(2);
}

/* ====== Top-knappar ====== */
$("#prevMon").onclick=()=>{ cur=new Date(cur.getFullYear(),cur.getMonth()-1,1); render(); log(`Bytte till ${monthName(cur.getFullYear(),cur.getMonth())}.`); };
$("#nextMon").onclick=()=>{ cur=new Date(cur.getFullYear(),cur.getMonth()+1,1); render(); log(`Bytte till ${monthName(cur.getFullYear(),cur.getMonth())}.`); };
$("#addToday").onclick=()=>{
  const rows=loadRows();
  const t=new Date(); const iso=`${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
  rows.push({date:iso,start:"",end:"",breakMin:0,total:"0.00",comment:"",photos:[]});
  saveRows(rows); render(); log("La till rad f√∂r idag.");
};
$("#clearMonth").onclick=()=>{
  if(!confirm("Rensa alla rader f√∂r denna m√•nad?")) return;
  localStorage.removeItem(keyFor(cur.getFullYear(),cur.getMonth())); render(); log("Denna m√•nad rensades.");
};

/* ====== Signaturer ====== */
function signPadSetup(id){
  const c=$(id), ctx=c.getContext('2d'); let d=false, px,py;
  const get=(e)=>{ const r=c.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x,y}; };
  const draw=(x,y)=>{ ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#053'; ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(x,y); ctx.stroke(); px=x; py=y; };
  const start=e=>{ d=true; const p=get(e); px=p.x; py=p.y; e.preventDefault(); };
  const move=e=>{ if(!d) return; const p=get(e); draw(p.x,p.y); e.preventDefault(); };
  const end=()=>{ d=false; saveSig(id.slice(1)); };
  c.addEventListener('mousedown',start); c.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
  c.addEventListener('touchstart',start,{passive:false}); c.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',end);
  // ladda om det finns
  const data = localStorage.getItem(id.slice(1)); if(data){ const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,c.width,c.height); img.src=data; }
}
function saveSig(key){ const c=$("#"+key); try{ localStorage.setItem(key, c.toDataURL()); log(`Signature saved: ${key}`);}catch{} }
document.querySelectorAll('[data-clear]').forEach(b=>b.onclick=()=>{ const id=b.dataset.clear; const c=$("#"+id); c.getContext('2d').clearRect(0,0,c.width,c.height); localStorage.removeItem(id); log(`Signatur rensad: ${id}`); });

/* ====== PDF / DELA ====== */
$("#pdfBtn").onclick=async()=>{
  log("Skapar PDF‚Ä¶");
  const wrap=document.querySelector('.wrap').cloneNode(true);
  if(!$("#pdfPhotos").checked){ wrap.querySelectorAll('.thumbs').forEach(x=>x.remove()); }
  const node=document.createElement('div'); node.style.padding='12px'; node.appendChild(wrap);
  document.body.appendChild(node); // offscreen render
  const canvas=await html2canvas(node,{scale:2,backgroundColor:null});
  node.remove();
  const img=canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF({unit:'pt',format:'a4'});
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const ratio=Math.min(pageW/canvas.width, pageH/canvas.height);
  const w=canvas.width*ratio, h=canvas.height*ratio;
  pdf.addImage(img,'PNG',(pageW-w)/20,20,w,h);
  pdf.save(`tidsrapport-${keyFor(cur.getFullYear(),cur.getMonth()).slice(4)}.pdf`);
  log("PDF klar.");
};
$("#shareBtn").onclick=async()=>{
  try{
    if(navigator.share){ await navigator.share({title:document.title, text:"Min tidsrapport", url:location.href}); log("Delning ok."); }
    else{ log("Delning avbruten (saknas st√∂d)."); alert("Delning st√∂ds inte av din webbl√§sare."); }
  }catch{ log("Delning avbruten."); }
};

/* ====== Inst√§llningar ====== */
const prefsKey="tnh:prefs";
function loadPrefs(){ try{return JSON.parse(localStorage.getItem(prefsKey))||{};}catch{return {}} }
function savePrefs(p){ localStorage.setItem(prefsKey, JSON.stringify(p)); }
function applyPrefs(){
  const p=loadPrefs();
  document.body.setAttribute('data-theme', p.theme||'default');
  $("#themeSel").value = p.theme||'default';
  $("#showDebug").checked = p.showDebug!==false;
  $("#debugBox").style.display = (p.showDebug!==false) ? "block":"none";
  $("#showWM").checked = p.showWM!==false;
  $("#wm").style.display = (p.showWM!==false) ? "block":"none";
  $("#pdfPhotos").checked = p.pdfPhotos!==false;
  if(p.logo){ $("#logoBox").style.backgroundImage=`url('${p.logo}')`; }
}
applyPrefs();
$("#gear").onclick=()=>$("#settings").style.display="flex";
$("#closeSettings").onclick=()=>$("#settings").style.display="none";
$("#themeSel").onchange=e=>{ const p=loadPrefs(); p.theme=e.target.value; savePrefs(p); applyPrefs(); };
$("#showDebug").onchange=e=>{ const p=loadPrefs(); p.showDebug=e.target.checked; savePrefs(p); applyPrefs(); };
$("#showWM").onchange=e=>{ const p=loadPrefs(); p.showWM=e.target.checked; savePrefs(p); applyPrefs(); };
$("#pdfPhotos").onchange=e=>{ const p=loadPrefs(); p.pdfPhotos=e.target.checked; savePrefs(p); };
$("#logoPicker").onchange=e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ const p=loadPrefs(); p.logo=r.result; savePrefs(p); applyPrefs(); log("Logga uppdaterad."); };
  r.readAsDataURL(f);
};
$("#resetApp").onclick=()=>{
  if(!confirm("√Öterst√§ll alla data och inst√§llningar?")) return;
  Object.keys(localStorage).filter(k=>k.startsWith('tnh:')||k==='sigEmp'||k==='sigBoss').forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem(prefsKey);
  location.reload();
};
$("#dbgToggle").onclick=()=>{
  const b=$("#debugBody"); const h=$("#dbgToggle");
  if(b.style.display==="none"){ b.style.display="block"; h.textContent="F√§ll in"; }
  else{ b.style.display="none"; h.textContent="Visa"; }
};
$("#dbgClear").onclick=()=>{ $("#debugBody").innerHTML=""; };

/* ====== Start ====== */
window.addEventListener('load',()=>{
  // storlek p√• signaturer
  [$("#sigEmp"), $("#sigBoss")].forEach(c=>{ c.width=c.clientWidth; c.height=c.clientHeight; });
  signPadSetup('#sigEmp'); signPadSetup('#sigBoss');
  render();
  log(`App start OK. M√•nad: ${cur.getFullYear()}-${pad(cur.getMonth()+1)}`);
});
</script>
</body>
</html>
