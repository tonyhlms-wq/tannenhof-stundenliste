<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b5d3b" />
  <title>Tannenhofs tidtabell</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root{--green:#0b5d3b;--green-2:#0e7248;--bg:#f4f8f4;--txt:#1f2b22;--muted:#6a7a6f;--card:#ffffff;--line:#e3eee5}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{background:var(--green);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    #logoPreview{width:36px;height:36px;border-radius:8px;background:#ffffff22;display:grid;place-items:center;font-size:22px;overflow:hidden}
    #logoPreview img{width:100%;height:100%;object-fit:cover}
    header h1{font-size:20px;margin:0;font-weight:600}
    .wrap{max-width:950px;margin:22px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button,textarea{font:inherit;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--txt)}
    button.primary{background:var(--green);color:#fff;border-color:var(--green);cursor:pointer}
    button.primary:hover{background:var(--green-2)}
    button.ghost{background:#fff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border-radius:12px;overflow:hidden}
    thead th{background:#eef6ef;color:#2a3b31;font-weight:600;padding:10px;border-bottom:1px solid var(--line);text-align:left}
    tbody td{padding:8px;border-bottom:1px solid var(--line)}
    tbody tr:last-child td{border-bottom:none}
    tfoot td{padding:10px;background:#f7fbf8;font-weight:600}
    .right{text-align:right}.center{text-align:center}
    .hint{font-size:12px;color:var(--muted)}
    .lang{gap:8px;display:flex;align-items:center}
    .badge{background:#0b5d3b12;color:var(--green);padding:3px 8px;border-radius:999px;font-size:12px}
    dialog{border:none;border-radius:12px;max-width:420px;width:95%}
    dialog::backdrop{background:#0006}
    .qr-box{display:grid;place-items:center;padding:12px;border:1px dashed var(--line);border-radius:12px}
    .sticky-footer{position:sticky;bottom:0;background:#ffffffcc;backdrop-filter:blur(6px);padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:12px}
    @media print{header,.controls,.toolbar,.sticky-footer,.no-print{display:none!important}body{background:#fff}table{border:1px solid #ccc}}
  </style>
</head>
<body>
  <header class="no-print">
    <div id="logoPreview" aria-label="Logga">üå≤</div>
    <h1 id="titleTxt">Tannenhofs tidtabell</h1>
    <span class="badge" id="monthBadge"></span>
  </header>

  <div class="wrap">
    <div class="card controls">
      <div class="row">
        <div>
          <label data-i="company">F√∂retag</label>
          <input id="company" placeholder="TH√úRINGER TANNENHOF" />
        </div>
        <div>
          <label data-i="logo">Logga (bildfil eller emoji)</label>
          <div class="row">
            <input id="logoEmoji" placeholder="t.ex. üå≤ eller ü¶å" />
            <input id="logoFile" type="file" accept="image/*" />
          </div>
          <div class="hint" data-i="logo_hint">Sparas lokalt p√• den h√§r enheten.</div>
        </div>
        <div>
          <label data-i="language">Spr√•k</label>
          <div class="lang">
            <select id="lang">
              <option value="sv">Svenska</option>
              <option value="de">Deutsch</option>
              <option value="en">English</option>
            </select>
            <span class="hint">/</span>
            <button class="ghost" id="shareBtn" data-i="share">Dela / Skicka</button>
            <button class="ghost" id="printBtn" data-i="print">Skriv ut / PDF</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label data-i="month">M√•nad</label>
          <select id="month"></select>
        </div>
        <div>
          <label data-i="year">√Ör</label>
          <select id="year"></select>
        </div>
        <div style="align-self:end">
          <button class="primary" id="regenBtn" data-i="regen">Skapa dagar</button>
        </div>
      </div>
    </div>

    <div class="card">
      <table id="sheet">
        <thead>
          <tr>
            <th class="center" style="width:56px" data-i="day">Dag</th>
            <th data-i="from">Fr√•n</th>
            <th data-i="to">Till</th>
            <th data-i="break">Paus (h:mm)</th>
            <th data-i="total">Totalt (h)</th>
            <th data-i="note">Anteckning</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="6">
              <div class="row">
                <div><span data-i="sum">Summa timmar</span>: <strong id="sumH">0.00</strong></div>
                <div><span data-i="longest">L√§ngsta dag</span>: <strong id="longH">0.00</strong></div>
                <div><span data-i="avg">Medel</span>: <strong id="avgH">0.00</strong></div>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
      <div class="sticky-footer hint">
        <span data-i="autosave">Autosparar lokalt. Byt enhet ‚áí exportera/skriv ut f√∂rst.</span>
      </div>
    </div>
  </div>

  <dialog id="shareDlg">
    <form method="dialog">
      <h3 style="margin:0 0 6px" data-i="share">Dela / Skicka</h3>
      <div class="row">
        <input id="pageUrl" readonly>
        <button class="ghost" id="copyBtn" type="button" data-i="copy">Kopiera l√§nk</button>
      </div>
      <div class="qr-box" style="margin:10px 0">
        <div id="qrcode"></div>
      </div>
      <div class="toolbar">
        <a id="waBtn" class="primary" target="_blank" rel="noopener">WhatsApp</a>
        <a id="mailBtn" class="ghost" target="_blank" rel="noopener" data-i="email">E-post</a>
        <button type="submit" class="ghost" data-i="close">St√§ng</button>
      </div>
    </form>
  </dialog>

<script>
/* ---------- i18n ---------- */
const I = {
  sv:{ company:"F√∂retag",logo:"Logga (bildfil eller emoji)",logo_hint:"Sparas lokalt p√• den h√§r enheten.",
      language:"Spr√•k",share:"Dela / Skicka",print:"Skriv ut / PDF",
      month:"M√•nad",year:"√Ör",regen:"Skapa dagar",
      day:"Dag",from:"Fr√•n",to:"Till",break:"Paus (h:mm)",total:"Totalt (h)",note:"Anteckning",
      sum:"Summa timmar",longest:"L√§ngsta dag",avg:"Medel",autosave:"Autosparar lokalt. Byt enhet ‚áí exportera/skriv ut f√∂rst.",
      copy:"Kopiera l√§nk",email:"E-post",close:"St√§ng",
      title:"Tannenhofs tidtabell"
  },
  de:{ company:"Arbeitgeber",logo:"Logo (Datei oder Emoji)",logo_hint:"Lokal auf diesem Ger√§t gespeichert.",
      language:"Sprache",share:"Teilen / Senden",print:"Drucken / PDF",
      month:"Monat",year:"Jahr",regen:"Tage erstellen",
      day:"Tag",from:"Von",to:"Bis",break:"Pause (Std:Min)",total:"Gesamt (Std)",note:"Notiz",
      sum:"Summe Stunden",longest:"L√§ngster Tag",avg:"Durchschnitt",autosave:"Autospeicherung lokal. Vor Ger√§tewechsel exportieren/drucken.",
      copy:"Link kopieren",email:"E-Mail",close:"Schlie√üen",
      title:"Tannenhof Stundenliste"
  },
  en:{ company:"Company",logo:"Logo (image or emoji)",logo_hint:"Stored locally on this device.",
      language:"Language",share:"Share / Send",print:"Print / PDF",
      month:"Month",year:"Year",regen:"Generate days",
      day:"Day",from:"From",to:"To",break:"Break (h:mm)",total:"Total (h)",note:"Note",
      sum:"Total hours",longest:"Longest day",avg:"Average",autosave:"Autosaves locally. If you switch device, export/print first.",
      copy:"Copy link",email:"Email",close:"Close",
      title:"Tannenhof Timesheet"
  }
};
const monthNames = {
  sv:["Jan","Feb","Mar","Apr","Maj","Jun","Jul","Aug","Sep","Okt","Nov","Dec"],
  de:["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],
  en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
};
function t(){
  const dict=I[lang.value];
  document.querySelectorAll("[data-i]").forEach(el=>el.textContent=dict[el.dataset.i]);
  document.title=dict.title; titleTxt.textContent=dict.title;
  setMonthLabels(); updateMonthBadge();
}

/* ---------- helpers ---------- */
const $ = s=>document.querySelector(s);
function pad2(n){return String(n).padStart(2,"0")}
function parseHM(str){ if(!str) return [0,0]; const m=str.match(/^(\d{1,2}):([0-5]\d)$/); return m?[+m[1],+m[2]]:[0,0]; }

/* ---------- DOM ---------- */
const company=$("#company"), logoEmoji=$("#logoEmoji"), logoFile=$("#logoFile"), logoPreview=$("#logoPreview");
const titleTxt=$("#titleTxt"), monthSel=$("#month"), yearSel=$("#year");
const regenBtn=$("#regenBtn"), tbody=document.querySelector("#sheet tbody");
const sumH=$("#sumH"), longH=$("#longH"), avgH=$("#avgH"), monthBadge=$("#monthBadge");
const shareBtn=$("#shareBtn"), shareDlg=$("#shareDlg"), pageUrl=$("#pageUrl"), copyBtn=$("#copyBtn");
const waBtn=$("#waBtn"), mailBtn=$("#mailBtn"), printBtn=$("#printBtn"), lang=$("#lang");

/* ---------- storage ---------- */
function keyBase(){ return `th_${yearSel.value}_${monthSel.value}`; }

/* ---------- init month/year ---------- */
(function initYM(){
  for(let m=1;m<=12;m++){
    const o=document.createElement("option"); o.value=m; monthSel.appendChild(o);
  }
  const now=new Date(), yNow=now.getFullYear();
  for(let y=yNow-1;y<=yNow+2;y++){ const o=document.createElement("option"); o.value=y; o.textContent=y; yearSel.appendChild(o); }
  monthSel.value = (now.getMonth()+1); yearSel.value = yNow;
  setMonthLabels(); updateMonthBadge();
})();
function setMonthLabels(){
  const names=monthNames[lang.value];
  [...monthSel.options].forEach((o,i)=>{ o.textContent = names[i]; });
}
function updateMonthBadge(){
  const names=monthNames[lang.value]; monthBadge.textContent = `${names[monthSel.value-1]} ${yearSel.value}`;
}

/* ---------- language ---------- */
(function initLang(){
  const saved=localStorage.getItem("th_lang")||"sv"; lang.value=saved; t();
  lang.addEventListener("change", ()=>{ localStorage.setItem("th_lang",lang.value); t(); });
})();

/* ---------- company & logo ---------- */
(function initBrand(){
  const data = JSON.parse(localStorage.getItem("th_brand")||"{}");
  if(data.company) company.value=data.company;
  if(data.emoji){ logoEmoji.value=data.emoji; logoPreview.textContent=data.emoji; }
  if(data.img){ setLogoImg(data.img); }
  company.addEventListener("input", saveBrand);
  logoEmoji.addEventListener("input", ()=>{ logoPreview.innerHTML=""; logoPreview.textContent=logoEmoji.value||"üå≤"; saveBrand(); });
  logoFile.addEventListener("change", e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ setLogoImg(r.result); saveBrand(); }; r.readAsDataURL(f);
  });
  function setLogoImg(src){ logoPreview.innerHTML=`<img alt="logo">`; logoPreview.querySelector("img").src=src; }
  function saveBrand(){
    const obj={company:company.value, emoji:logoEmoji.value, img:(logoPreview.querySelector("img")?.src||null)};
    localStorage.setItem("th_brand", JSON.stringify(obj));
  }
})();

/* ---------- build table ---------- */
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
function buildTable(){
  const y=+yearSel.value, m=+monthSel.value, days=daysInMonth(y,m);
  updateMonthBadge();
  tbody.innerHTML="";
  for(let d=1; d<=days; d++){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="center">${d}</td>
      <td><input placeholder="07:00" data-k="from"></td>
      <td><input placeholder="16:00" data-k="to"></td>
      <td><input placeholder="0:30" data-k="break"></td>
      <td class="right"><span data-k="tot">0.00</span></td>
      <td><input placeholder="-"></td>`;
    tbody.appendChild(tr);
  }
  loadMonthData();
  tbody.querySelectorAll("input").forEach(i=>i.addEventListener("input", onEdit));
  calcTotals();
}
regenBtn.addEventListener("click", buildTable);

/* ---------- calc & save ---------- */
function onEdit(){ calcTotals(); saveMonthData(); }
function calcTotals(){
  let sum=0,long=0,worked=0;
  tbody.querySelectorAll("tr").forEach(tr=>{
    const f=tr.querySelector('input[data-k="from"]').value.trim();
    const t=tr.querySelector('input[data-k="to"]').value.trim();
    const b=tr.querySelector('input[data-k="break"]').value.trim();
    let tot=0;
    if(f&&t){
      const [fh,fm]=parseHM(f), [th,tm]=parseHM(t), [bh,bm]=parseHM(b||"0:00");
      let h=(th+tm/60)-(fh+fm/60)-(bh+bm/60);
      if(!isNaN(h)&&h>0){ tot=h; sum+=h; long=Math.max(long,h); worked++; }
    }
    tr.querySelector('[data-k="tot"]').textContent=tot.toFixed(2);
  });
  sumH.textContent=sum.toFixed(2);
  longH.textContent=long.toFixed(2);
  avgH.textContent=worked?(sum/worked).toFixed(2):"0.00";
}
function saveMonthData(){
  const rows=[...tbody.querySelectorAll("tr")].map(tr=>({
    from:tr.querySelector('input[data-k="from"]').value,
    to:tr.querySelector('input[data-k="to"]').value,
    brk:tr.querySelector('input[data-k="break"]').value,
    note:tr.querySelectorAll('input')[3].value
  }));
  localStorage.setItem(keyBase(), JSON.stringify(rows));
}
function loadMonthData(){
  const raw=localStorage.getItem(keyBase()); if(!raw) return;
  const rows=JSON.parse(raw);
  [...tbody.querySelectorAll("tr")].forEach((tr,i)=>{
    const r=rows[i]; if(!r) return;
    tr.querySelector('input[data-k="from"]').value=r.from||"";
    tr.querySelector('input[data-k="to"]').value=r.to||"";
    tr.querySelector('input[data-k="break"]').value=r.brk||"";
    tr.querySelectorAll('input')[3].value=r.note||"";
  });
}

/* ---------- month/year change ---------- */
[monthSel,yearSel].forEach(s=>s.addEventListener("change", buildTable));

/* ---------- share & QR ---------- */
shareBtn.addEventListener("click", ()=>{
  shareDlg.showModal();
  pageUrl.value=location.href;
  $("#qrcode").innerHTML="";
  new QRCode(document.getElementById("qrcode"),{text:location.href,width:164,height:164});
  const enc=encodeURIComponent(location.href);
  waBtn.href=`https://wa.me/?text=${enc}`;
  mailBtn.href=`mailto:?subject=Tannenhof%20Timesheet&body=${enc}`;
});
copyBtn.addEventListener("click", async ()=>{
  await navigator.clipboard.writeText(pageUrl.value);
  copyBtn.textContent = (lang.value==="de")?"Kopiert!":(lang.value==="en")?"Copied!":"Kopierat!";
  setTimeout(()=>copyBtn.textContent=I[lang.value].copy,1200);
});

/* ---------- print ---------- */
printBtn.addEventListener("click", ()=>window.print());

/* ---------- start ---------- */
buildTable();
</script>
</body>
</html>
