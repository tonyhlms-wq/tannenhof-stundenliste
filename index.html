<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tannenhofs tidtabell</title>

  <!-- PWA / ikoner ‚Äì beh√•ll g√§rna dessa filnamn -->
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --green:#2f6b3a;
      --green-2:#2d5f35;
      --green-soft:#eaf3ed;
      --ink:#203328;
      --muted:#6a7d72;
      --accent:#3aa45b;
      --row:#ffffff;
      --row-alt:#f7fbf8;
      --today:#e6f3e9;
      --focus:#1b8a46;
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#f2f6f4;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:12px 12px 120px}

    /* Header */
    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(0deg,var(--green-2),var(--green));
      color:#fff; box-shadow:var(--shadow);
    }
    .head-inner{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px}
    .brand{
      display:flex;align-items:center;gap:10px;min-width:0;
    }
    .logo{
      width:34px;height:34px;border-radius:9px;overflow:hidden;display:grid;place-items:center;
      background:#234d2b;border:2px solid #1c3e22;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{
      display:flex;flex-direction:column;min-width:0;
    }
    .title b{font-size:18px;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .title small{opacity:.8}

    .head-actions{margin-left:auto;display:flex;gap:10px}
    .btn{
      background:#fff;color:var(--green-2);border:0;border-radius:12px;padding:10px 14px;font-weight:600;
      box-shadow:var(--shadow);cursor:pointer
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:#143d23;color:#fff;border:1px solid #0e2b19}

    /* Summa-banner */
    .sum-banner{
      background:#fff;margin:14px 0;padding:12px 16px;border-radius:var(--radius);box-shadow:var(--shadow);
      font-weight:700;color:var(--green-2)
    }

    /* Tabell */
    .table{background:#fff;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:56px 1fr 1fr 140px 92px 64px;gap:10px;align-items:center;
         padding:12px 12px;border-bottom:1px solid #eef3ef;background:var(--row)}
    .row:nth-child(even){background:var(--row-alt)}
    .row.header{background:var(--green-soft);font-weight:700}
    .row.today{background:var(--today);outline:2px solid var(--focus)}
    .cell-num{font-weight:700;color:var(--muted)}
    .num-pill{display:inline-block;width:36px;text-align:center;padding:6px 0;border-radius:10px;background:#fff;border:1px solid #dfeae3}
    input[type="time"], input[type="text"], select{
      width:100%;padding:11px 12px;border:1px solid #dfeae3;border-radius:12px;background:#fff;
      font:inherit;color:var(--ink)
    }
    .tot{
      width:100%;padding:11px 12px;border:1px dashed #dfeae3;border-radius:12px;background:#fbfdfc;
      text-align:right;font-variant-numeric:tabular-nums
    }
    .act{display:flex;justify-content:center}
    .note-btn{
      width:42px;height:42px;border-radius:11px;border:0;background:var(--green-2);color:#fff;cursor:pointer;box-shadow:var(--shadow)
    }

    /* Floating settings button ‚Äì bottom-left */
    .fab{
      position:fixed;left:16px;bottom:16px;z-index:25;
      width:56px;height:56px;border-radius:16px;border:0;background:var(--green-2);color:#fff;
      display:grid;place-items:center;box-shadow:0 10px 30px rgba(0,0,0,.18);cursor:pointer
    }

    /* Settings drawer */
    .drawer-back{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none;z-index:40}
    .drawer{position:fixed;right:0;top:0;height:100%;width:min(460px,92vw);background:#fff;
            box-shadow:-12px 0 30px rgba(0,0,0,.18);transform:translateX(100%);transition:.25s ease;z-index:41;
            display:flex;flex-direction:column}
    .drawer.open + .drawer-back{display:block}
    .drawer.open{transform:translateX(0)}
    .drawer header{position:relative;background:var(--green);box-shadow:none}
    .drawer header .head-inner{padding:14px}
    .panel{padding:16px 16px 24px;display:grid;gap:14px;overflow:auto}
    .field{display:grid;gap:6px}
    label{font-size:14px;color:var(--muted)}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .switch{display:flex;align-items:center;gap:10px}
    .switch input{width:22px;height:22px}
    .closebar{display:flex;gap:10px;margin-top:auto;padding:14px;border-top:1px solid #eef3ef}

    /* Notes modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:50}
    .modal{position:fixed;inset:auto 0 0 0;margin:auto;background:#fff;max-width:980px;height:min(80vh,620px);
           border-radius:18px 18px 0 0;box-shadow:0 -18px 30px rgba(0,0,0,.2);transform:translateY(100%);transition:.25s;z-index:51}
    .modal.open{transform:translateY(0)}
    .modal.open + .modal-back{display:block}
    .modal header{padding:14px 16px;border-bottom:1px solid #eef3ef;font-weight:700}
    .modal main{padding:12px;height:calc(100% - 116px)}
    .modal textarea{width:100%;height:100%;padding:14px;border:1px solid #dfeae3;border-radius:12px;resize:none;font:inherit}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;padding:12px;border-top:1px solid #eef3ef}

    /* Watermark */
    .watermark{
      position:fixed;right:16px;bottom:16px;opacity:.18;pointer-events:none;z-index:1;
      display:flex;align-items:center;gap:10px
    }
    .wm-img{width:160px;height:auto;filter:grayscale(30%) contrast(90%)}
    .wm-text{font-weight:800;letter-spacing:.06em;color:#356948}
    .muted{color:var(--muted)}

    @media (max-width:720px){
      .row{grid-template-columns:46px 1fr 1fr 120px 86px 56px}
      .head-actions .btn{padding:9px 12px}
      .wm-img{width:130px}
    }
  </style>
</head>
<body>

<header>
  <div class="head-inner">
    <div class="brand">
      <div class="logo"><img id="topLogo" alt="Logo"></div>
      <div class="title">
        <b>Tannenhofs tidtabell</b>
        <small id="monthTitle" class="muted"></small>
      </div>
    </div>

    <div class="head-actions">
      <button class="btn" id="shareBtn">Dela / Skicka</button>
      <button class="btn btn-primary" id="printBtn">Skriv ut / PDF</button>
    </div>
  </div>
</header>

<div class="wrap">

  <div id="sumBanner" class="sum-banner">Totalt ‚Äì <span id="sumPeriod"></span> <span style="float:right" id="sumHours">0.00</span></div>

  <div id="table" class="table">
    <div class="row header">
      <div>Dag</div><div>Fr√•n</div><div>Till</div><div>Paus (h:mm)</div><div>Totalt (h)</div><div>√Ötg√§rd</div>
    </div>
    <!-- rader skapas dynamiskt -->
  </div>

</div>

<!-- Floating settings -->
<button id="settingsBtn" class="fab" title="Inst√§llningar">‚öôÔ∏è</button>

<!-- Watermark -->
<div id="wm" class="watermark" aria-hidden="true">
  <img id="wmImg" class="wm-img" src="tnh-tree-192.png" alt="">
</div>

<!-- Drawer (settings) -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <header>
    <div class="head-inner">
      <div class="brand">
        <div class="logo"><img id="logoPreview"></div>
        <div class="title"><b>Inst√§llningar</b><small class="muted">Lokal lagring p√• din enhet</small></div>
      </div>
    </div>
  </header>

  <div class="panel">
    <div class="field">
      <label>F√∂retag</label>
      <input id="company" type="text" placeholder="TH√úRINGER TANNENHOF">
    </div>

    <div class="field">
      <label>Logga (bild)</label>
      <input id="logoFile" type="file" accept="image/*">
      <small class="muted">Sparas lokalt och visas √§ven som vattenst√§mpel om den √§r p√•.</small>
    </div>

    <div class="row-2">
      <div class="field">
        <label>M√•nad</label>
        <select id="month"></select>
      </div>
      <div class="field">
        <label>√Ör</label>
        <select id="year"></select>
      </div>
    </div>

    <div class="row-2">
      <div class="switch">
        <input id="autosave" type="checkbox">
        <label for="autosave">Autospara</label>
      </div>
      <div class="switch">
        <input id="wmToggle" type="checkbox">
        <label for="wmToggle">Visa vattenst√§mpel</label>
      </div>
    </div>

    <div class="row-2">
      <div class="field">
        <label>Standardrast</label>
        <select id="defaultBreak">
          <option value="00:00">00:00</option>
          <option value="00:15">00:15</option>
          <option value="00:30">00:30</option>
          <option value="00:45">00:45</option>
          <option value="01:00">01:00</option>
        </select>
      </div>
      <div class="field">
        <label>Spr√•k</label>
        <select id="lang">
          <option value="sv">Svenska</option>
          <option value="de">Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>

    <div class="row-2">
      <button id="genBtn" class="btn">Skapa dagar</button>
      <button id="wipeBtn" class="btn">Rensa allt</button>
    </div>
  </div>

  <div class="closebar">
    <button id="closeDrawer" class="btn" style="margin-left:auto">St√§ng</button>
  </div>
</aside>
<div id="drawerBack" class="drawer-back"></div>

<!-- Notes modal -->
<section id="noteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="noteTitle">
  <header id="noteTitle">Anteckningar ‚Äì dag <span id="noteDay"></span></header>
  <main><textarea id="noteText" placeholder="Skriv anteckningar h√§r‚Ä¶"></textarea></main>
  <div class="actions">
    <button id="noteCancel" class="btn">Avbryt</button>
    <button id="noteSave" class="btn btn-primary">Spara</button>
  </div>
</section>
<div id="noteBack" class="modal-back"></div>

<script>
/* ------------ Hj√§lp ------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const pad = n => String(n).padStart(2,'0');
const hmToDec = (hm) => { if(!hm) return 0; const [h,m]=hm.split(':').map(Number); return +(h + m/60).toFixed(2); };
const decToHM = (d) => { const h=Math.floor(d); const m=Math.round((d-h)*60); return pad(h)+':'+pad(m); };

const SKEY = 'tnh_timesheet_v2';

const state = {
  company: 'TH√úRINGER TANNENHOF',
  month: new Date().getMonth(),
  year: new Date().getFullYear(),
  autosave: true,
  watermark: true,
  defaultBreak:'00:00',
  lang:'sv',
  logoData:null,
  days:[] // {from:'',to:'',break:'',note:''}
};

/* -------- Ladda/Spara --------- */
function load(){
  try{
    const saved = JSON.parse(localStorage.getItem(SKEY));
    if(saved) Object.assign(state,saved);
  }catch(e){}
}
function save(){
  if(!state.autosave) return;
  localStorage.setItem(SKEY, JSON.stringify(state));
}

/* -------- UI init ---------- */
function fillMonthYear(){
  const mSel = $('#month'); mSel.innerHTML='';
  const months = [
    'Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'
  ];
  months.forEach((n,i)=>{
    const op=document.createElement('option'); op.value=i; op.textContent=n; mSel.append(op);
  });
  mSel.value = state.month;

  const ySel = $('#year'); ySel.innerHTML='';
  for(let y=state.year-2;y<=state.year+3;y++){
    const op=document.createElement('option'); op.value=y; op.textContent=y; ySel.append(op);
  }
  ySel.value = state.year;
}
function updateHeader(){
  const name = ['januari','februari','mars','april','maj','juni','juli','augusti','september','oktober','november','december'][state.month];
  $('#monthTitle').textContent = `${name} ${state.year}`;
  $('#sumPeriod').textContent = `${name} ${state.year}`;
  if(state.logoData){ $('#topLogo').src = state.logoData; $('#logoPreview').src = state.logoData; } else { $('#topLogo').src='tnh-tree-192.png'; $('#logoPreview').src='tnh-tree-192.png'; }
  $('#wm').style.display = state.watermark ? 'flex' : 'none';
  $('#wmImg').src = state.logoData || 'tnh-tree-192.png';
}

function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }

function ensureDays(){
  const n = daysInMonth(state.year, state.month);
  if(state.days.length !== n){
    state.days = Array.from({length:n}, (_,i)=> state.days[i] || {from:'',to:'',break:state.defaultBreak, note:''});
  }
}

function render(){
  ensureDays(); updateHeader();

  const table = $('#table');
  table.querySelectorAll('.row.data').forEach(r=>r.remove());

  const today = new Date();
  const isCurrent = today.getFullYear()===state.year && today.getMonth()===state.month;
  let total=0;

  state.days.forEach((d,idx)=>{
    const r = document.createElement('div');
    r.className = 'row data';
    if(isCurrent && (idx+1)===today.getDate()) r.classList.add('today');

    // cells
    const c0 = document.createElement('div'); c0.className='cell-num'; c0.innerHTML = `<span class="num-pill">${idx+1}</span>`;
    const c1 = document.createElement('div'); const c2=document.createElement('div'); const c3=document.createElement('div');
    c1.innerHTML = `<input type="time" value="${d.from||''}" data-k="from" data-i="${idx}">`;
    c2.innerHTML = `<input type="time" value="${d.to||''}" data-k="to" data-i="${idx}">`;
    c3.innerHTML = `<input type="time" value="${d.break||state.defaultBreak}" data-k="break" data-i="${idx}">`;
    const c4 = document.createElement('div'); c4.innerHTML = `<div class="tot" id="t_${idx}">0.00</div>`;
    const c5 = document.createElement('div'); c5.className='act';
    c5.innerHTML = `<button class="note-btn" title="Anteckningar" data-note="${idx}">üìù</button>`;

    r.append(c0,c1,c2,c3,c4,c5);
    table.append(r);

    // tot
    const day = calcDay(idx);
    $('#t_'+idx).textContent = day.toFixed(2);
    total += day;
  });

  $('#sumHours').textContent = total.toFixed(2);

  // lyssnare
  table.addEventListener('change', onCellChange, {once:true});
  table.addEventListener('click', onNoteClick, {once:true});
}

function onCellChange(e){
  const el = e.target;
  const i = +el.dataset.i, k = el.dataset.k;
  if(Number.isInteger(i) && k){
    state.days[i][k] = el.value;
    save();
    $('#t_'+i).textContent = calcDay(i).toFixed(2);
    // summera om
    let tot=0; state.days.forEach((_,ix)=> tot+=calcDay(ix));
    $('#sumHours').textContent = tot.toFixed(2);
  }
  // lyssna vidare
  $('#table').addEventListener('change', onCellChange, {once:true});
}

function toMinutes(hm){ if(!hm) return 0; const [h,m]=hm.split(':').map(Number); return h*60+m; }
function calcDay(i){
  const d = state.days[i];
  const from = toMinutes(d.from||'00:00');
  const to   = toMinutes(d.to||'00:00');
  const br   = toMinutes(d.break||state.defaultBreak||'00:00');
  const mins = Math.max(0, to - from - br);
  return +(mins/60).toFixed(2);
}

/* ----- Anteckningar ----- */
let noteIndex = null;
function onNoteClick(e){
  const idx = e.target?.dataset?.note;
  if(idx===undefined) { $('#table').addEventListener('click', onNoteClick, {once:true}); return; }
  noteIndex = +idx;
  $('#noteDay').textContent = noteIndex+1;
  $('#noteText').value = state.days[noteIndex].note || '';
  openModal(true);
}
function openModal(on){ $('#noteModal').classList.toggle('open',on); $('#noteBack').style.display = on?'block':'none'; }
$('#noteCancel').onclick = ()=> openModal(false);
$('#noteBack').onclick = ()=> openModal(false);
$('#noteSave').onclick = ()=>{
  if(noteIndex!=null){ state.days[noteIndex].note = $('#noteText').value; save(); }
  openModal(false);
}

/* ----- Drawer ----- */
function openDrawer(on){
  $('#drawer').classList.toggle('open', on);
  $('#drawerBack').style.display = on?'block':'none';
  if(on){
    $('#company').value = state.company||'';
    $('#autosave').checked = !!state.autosave;
    $('#wmToggle').checked = !!state.watermark;
    $('#defaultBreak').value = state.defaultBreak || '00:00';
    $('#lang').value = state.lang || 'sv';
    fillMonthYear();
  }
}
$('#settingsBtn').onclick = ()=> openDrawer(true);
$('#drawerBack').onclick = ()=> openDrawer(false);
$('#closeDrawer').onclick = ()=> openDrawer(false);

$('#company').addEventListener('input', e=>{ state.company=e.target.value; save(); });
$('#autosave').addEventListener('change', e=>{ state.autosave=e.target.checked; save(); });
$('#wmToggle').addEventListener('change', e=>{ state.watermark=e.target.checked; save(); updateHeader(); });
$('#defaultBreak').addEventListener('change', e=>{ state.defaultBreak=e.target.value; save(); });
$('#lang').addEventListener('change', e=>{ state.lang=e.target.value; save(); /* plats f√∂r fler spr√•k */ });
$('#month').addEventListener('change', e=>{ state.month=+e.target.value; save(); render(); });
$('#year').addEventListener('change', e=>{ state.year=+e.target.value; save(); render(); });

$('#genBtn').onclick = ()=>{
  ensureDays(); render(); openDrawer(false);
};
$('#wipeBtn').onclick = ()=>{
  if(confirm('Rensa alla tider och anteckningar f√∂r m√•naden?')){
    state.days.forEach(d=>{ d.from=''; d.to=''; d.break=state.defaultBreak; d.note=''; });
    save(); render();
  }
};

/* Logo file */
$('#logoFile').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const r = new FileReader();
  r.onload = (ev)=>{ state.logoData = ev.target.result; save(); updateHeader(); };
  r.readAsDataURL(f);
});

/* ----- Share/Print ----- */
$('#shareBtn').onclick = async ()=>{
  const url = location.href;
  const title = 'Tannenhofs tidtabell';
  try{
    if(navigator.share){
      await navigator.share({title, text: state.company||title, url});
    }else{
      await navigator.clipboard.writeText(url);
      alert('L√§nk kopierad till urklipp.');
    }
  }catch(e){}
};
$('#printBtn').onclick = ()=> window.print();

/* ----- Init ----- */
load();
document.addEventListener('visibilitychange', ()=> save());
render();

</script>
</body>
</html>
