<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="title">Tannenhofs tidtabell</title>
  <meta name="theme-color" content="#2f6b3a" />
  <style>
    :root{--brand:#2f6b3a;--brand-700:#255631;--bg:#f5f7f5;--text:#233127;--muted:#6b7c70;--card:#e7f1e9;--danger:#b02a37}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{background:var(--brand);color:#fff;padding:16px}
    header .wrap{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
    h1{margin:0;font-size:22px;font-weight:700}
    .lang{display:flex;gap:6px}
    .lang button{border:0;background:#fff;color:var(--brand);padding:6px 10px;border-radius:999px;font-weight:700;cursor:pointer}
    .lang button.active{background:#163e24;color:#fff}
    main{max-width:980px;margin:18px auto;padding:0 14px}
    .card{background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:14px}
    .company{background:var(--card)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    label{font-size:.9rem;color:var(--muted);display:block;margin:8px 0 6px}
    input[type="text"],input[type="number"],select{width:100%;padding:10px 12px;border:1px solid #d7e0d9;border-radius:10px;background:#fff;font-size:1rem}
    input[disabled]{background:#f0f0f0}
    .btn{display:inline-flex;gap:8px;align-items:center;background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--brand);border:1.5px solid var(--brand)}
    .btn.ghost{background:transparent;color:var(--danger);border:1.5px solid var(--danger)}
    .stack{display:flex;flex-wrap:wrap;gap:10px}
    .company-grid{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center}
    .logo-preview{width:72px;height:72px;border-radius:10px;object-fit:contain;background:#fff;border:1px solid #d7e0d9;padding:6px}
    .hint{font-size:.88rem;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{position:sticky;top:0;background:#fbfbfb}
    th,td{border:1px solid #e6eee8;padding:8px;text-align:center}
    tfoot td{font-weight:800}
    .footer-actions{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:12px}
    .sum{font-weight:800}
    .badge-lock{font-size:.9rem;color:var(--muted)}
    .sr-only{position:absolute;left:-9999px}
    @media print{header,.footer-actions,.lang,.hint,.btn.ghost{display:none} body{background:#fff} .card{box-shadow:none;border:1px solid #ddd}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1 data-i18n="header">Tannenhofs tidtabell</h1>
      <div class="lang" role="group" aria-label="Language">
        <button type="button" data-lang="de">DE</button>
        <button type="button" data-lang="sv" class="active">SV</button>
        <button type="button" data-lang="en">EN</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card company" aria-labelledby="companyTitle">
      <h2 id="companyTitle" data-i18n="companyTitle">Arbetsgivare</h2>
      <p class="hint" data-i18n="homescreenTip">Tips: L√§gg till p√• startsk√§rmen via webbl√§sarmenyn s√• fungerar den som en app.</p>

      <div class="company-grid">
        <img id="logoPreview" class="logo-preview" alt="logo" />
        <div class="stack">
          <div style="min-width:220px">
            <label for="companyName" data-i18n="company">Arbetsgivare</label>
            <input id="companyName" type="text" autocomplete="organization" placeholder="TANNENHOF" />
          </div>

          <div class="stack">
            <label class="sr-only" for="logoFile">Logo</label>
            <input id="logoFile" type="file" accept="image/*" class="sr-only" />
            <button class="btn secondary" id="btnLogo"><span>üñºÔ∏è</span><span data-i18n="uploadLogo">Ladda upp logga</span></button>
            <button class="btn" id="btnSaveCompany"><span>üì≤</span><span data-i18n="saveAsCompanyApp">Spara som f√∂retags-app</span></button>
            <button class="btn ghost" id="btnReset" style="display:none"><span>‚ôªÔ∏è</span><span data-i18n="resetCompany">√Öterst√§ll f√∂retagsl√§ge</span></button>
          </div>
          <div class="badge-lock" id="lockInfo" style="display:none" data-i18n="companyLocked">(F√∂retagsl√§ge ‚Äì l√•st)</div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row">
        <div>
          <label for="empName" data-i18n="name">Namn</label>
          <input id="empName" type="text" autocomplete="name" />
        </div>
        <div>
          <label for="workplace" data-i18n="workplace">Arbetsplats</label>
          <input id="workplace" type="text" />
        </div>

        <div>
          <label for="month" data-i18n="month">M√•nad</label>
          <input id="month" type="number" min="1" max="12" />
        </div>
        <div>
          <label for="year" data-i18n="year">√Ör</label>
          <input id="year" type="number" min="2000" max="2100" />
        </div>

        <div>
          <label for="targetPerDay" data-i18n="targetPerDay">Arbetstid per dag (h)</label>
          <input id="targetPerDay" type="number" min="0" step="0.25" />
        </div>
        <div>
          <label for="restrict" data-i18n="restrict">Begr√§nsa till idag+ig√•r</label>
          <select id="restrict">
            <option value="off" data-i18n="off">Av</option>
            <option value="on" data-i18n="on">P√•</option>
          </select>
        </div>
      </div>

      <table id="sheet">
        <thead>
          <tr>
            <th data-i18n="date">Datum</th>
            <th data-i18n="from">fr√•n</th>
            <th data-i18n="to">till</th>
            <th data-i18n="break">Paus (min)</th>
            <th data-i18n="total">Totalt antal timmar</th>
            <th data-i18n="place">Plats</th>
            <th data-i18n="note">Anteckningar (valfritt)</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="4" style="text-align:right" data-i18n="sum">Summa</td>
            <td id="sumHours" class="sum">0.00</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>

      <div class="footer-actions">
        <div class="hint" data-i18n="footerHint">Sidan sparar allt lokalt i din webbl√§sare. Vid behov kan du skriva ut eller exportera som PDF via webbl√§saren.</div>
        <div class="stack">
          <button class="btn secondary" onclick="window.print()"><span>üñ®Ô∏è</span><span data-i18n="print">Skriv ut</span></button>
          <button class="btn" id="btnClear"><span>üßπ</span><span data-i18n="clear">T√∂m alla f√§lt</span></button>
        </div>
      </div>
    </section>

    <p class="hint" style="text-align:center;margin:18px 0">¬© 2025 Tony Holmstr√∂m</p>
  </main>

  <script>
    /* --------- inbyggd standardlogga (gran, SVG) --------- */
    const DEFAULT_LOGO =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96">
        <rect width="96" height="96" rx="14" fill="#ffffff"/>
        <g transform="translate(8,6)">
          <polygon points="40,0 68,28 56,28 80,52 58,52 80,74 0,74 22,52 0,52 24,28 12,28" fill="#2f6b3a"/>
          <rect x="36" y="74" width="16" height="14" rx="2" fill="#8b5e3c"/>
        </g>
      </svg>`);

    /* ---------- i18n ---------- */
    const t = {
      sv:{title:"Tannenhofs tidtabell",header:"Tannenhofs tidtabell",
        homescreenTip:"Tips: L√§gg till p√• startsk√§rmen via webbl√§sarmenyn s√• fungerar den som en app.",
        companyTitle:"Arbetsgivare",company:"Arbetsgivare",
        uploadLogo:"Ladda upp logga",saveAsCompanyApp:"Spara som f√∂retags-app",
        resetCompany:"√Öterst√§ll f√∂retagsl√§ge",companyLocked:"(F√∂retagsl√§ge ‚Äì l√•st)",
        name:"Namn",workplace:"Arbetsplats",month:"M√•nad",year:"√Ör",
        targetPerDay:"Arbetstid per dag (h)",restrict:"Begr√§nsa till idag+ig√•r",
        off:"Av",on:"P√•",date:"Datum",from:"fr√•n",to:"till",break:"Paus (min)",
        total:"Totalt antal timmar",place:"Plats",note:"Anteckningar (valfritt)",
        sum:"Summa",print:"Skriv ut",clear:"T√∂m alla f√§lt",
        footerHint:"Sidan sparar allt lokalt i din webbl√§sare. Vid behov kan du skriva ut eller exportera som PDF via webbl√§saren."},
      de:{title:"Tannenhof ‚Äì Stundenliste",header:"Tannenhof ‚Äì Stundenliste",
        homescreenTip:"Tipp: √úber das Browser-Men√º zum Startbildschirm hinzuf√ºgen, dann funktioniert es wie eine App.",
        companyTitle:"Firma",company:"Firma",
        uploadLogo:"Logo hochladen",saveAsCompanyApp:"Als Firmen-App speichern",
        resetCompany:"Firmenmodus zur√ºcksetzen",companyLocked:"(Firmenmodus ‚Äì gesperrt)",
        name:"Name",workplace:"Arbeitsplatz",month:"Monat",year:"Jahr",
        targetPerDay:"Sollzeit pro Tag (h)",restrict:"Auf heute+gestern beschr√§nken",
        off:"Aus",on:"Ein",date:"Datum",from:"von Uhr",to:"bis Uhr",break:"Pause (Min)",
        total:"Stunden gesamt",place:"Einsatzort",note:"Notizen (optional)",
        sum:"Summe",print:"Drucken",clear:"Alles l√∂schen",
        footerHint:"Die Seite speichert alles lokal im Browser. Bei Bedarf √ºber den Browser drucken oder als PDF exportieren."},
      en:{title:"Tannenhof Timesheet",header:"Tannenhof Timesheet",
        homescreenTip:"Tip: Add to Home Screen from your browser menu so it works like an app.",
        companyTitle:"Company",company:"Company",
        uploadLogo:"Upload logo",saveAsCompanyApp:"Save as company app",
        resetCompany:"Reset company mode",companyLocked:"(Company mode ‚Äì locked)",
        name:"Name",workplace:"Workplace",month:"Month",year:"Year",
        targetPerDay:"Target hours per day (h)",restrict:"Restrict to today + yesterday",
        off:"Off",on:"On",date:"Date",from:"from",to:"to",break:"Break (min)",
        total:"Total hours",place:"Location",note:"Notes (optional)",
        sum:"Total",print:"Print",clear:"Clear all",
        footerHint:"This page stores everything locally in your browser. Use your browser to print or export to PDF."}
    };

    const $=(s,c=document)=>c.querySelector(s);
    const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
    const ls={set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
              get:(k,d=null)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??d}catch(_){return d}},
              del:(k)=>localStorage.removeItem(k)};

    let lang=ls.get("lang","sv");
    function applyI18n(){
      const dict=t[lang]||t.sv;
      $$("[data-i18n]").forEach(el=>{
        const key=el.getAttribute("data-i18n");
        if(dict[key]!==undefined) el.textContent=dict[key];
      });
      document.title=dict.title;
      $$(".lang button").forEach(b=>b.classList.toggle("active",b.dataset.lang===lang));
      $("#companyName").placeholder=(lang==="de"?"TH√úRINGER TANNENHOF":"TANNENHOF");
    }
    $$(".lang button").forEach(b=>b.addEventListener("click",()=>{lang=b.dataset.lang;ls.set("lang",lang);applyI18n();}));

    /* ---------- company state ---------- */
    const company=ls.get("company",{name:"",logo:"",locked:false});
    function setLogo(src){const el=$("#logoPreview"); if(src){el.src=src}else{el.removeAttribute("src")}}
    function ensureDefaultLogo(){
      if(!company.logo){ company.logo=DEFAULT_LOGO; ls.set("company",company); }
      setLogo(company.logo);
    }
    function syncCompanyUI(){
      $("#companyName").value=company.name||"";
      ensureDefaultLogo();
      const locked=!!company.locked;
      $("#companyName").disabled=locked;
      $("#btnLogo").disabled=locked;
      $("#btnSaveCompany").style.display=locked?"none":"inline-flex";
      $("#btnReset").style.display=locked?"inline-flex":"none";
      $("#lockInfo").style.display=locked?"block":"none";
    }
    $("#btnLogo").addEventListener("click",()=>$("#logoFile").click());
    $("#logoFile").addEventListener("change",e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ company.logo=r.result; ls.set("company",company); setLogo(company.logo); };
      r.readAsDataURL(f);
    });
    $("#btnSaveCompany").addEventListener("click",()=>{
      company.name=$("#companyName").value.trim(); company.locked=true; ls.set("company",company); syncCompanyUI();
      alert({sv:"F√∂retagsl√§get √§r sparat och l√•st.",de:"Firmenmodus wurde gespeichert und gesperrt.",en:"Company mode saved and locked."}[lang]);
    });
    $("#btnReset").addEventListener("click",()=>{
      if(!confirm({sv:"√Öterst√§lla f√∂retagsl√§get?",de:"Firmenmodus zur√ºcksetzen?",en:"Reset company mode?"}[lang])) return;
      ls.del("company"); Object.assign(company,{name:"",logo:DEFAULT_LOGO,locked:false}); syncCompanyUI();
    });
    $("#companyName").addEventListener("input",e=>{company.name=e.target.value; ls.set("company",company);});

    /* ---------- Sheet + m√•nad/√•r ---------- */
    const inputsKeyFor=(y,m)=>`sheetInputs:${y}-${String(m).padStart(2,"0")}`;
    function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); } // m = 1..12
    function currentYM(){
      const now=new Date();
      return {y:parseInt($("#year").value||now.getFullYear(),10),
              m:parseInt($("#month").value||now.getMonth()+1,10)};
    }
    function buildRows(){
      const {y,m}=currentYM();
      const tbody=$("#sheet tbody");
      const existing=Array.from(tbody.querySelectorAll("tr")).length;
      const need=daysInMonth(y,m);
      // rebuild to exact number
      tbody.innerHTML="";
      for(let d=1; d<=need; d++){
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${d}</td>
          <td><input type="time" /></td>
          <td><input type="time" /></td>
          <td><input type="number" min="0" step="1" style="width:92px"/></td>
          <td class="dayTotal">0.00</td>
          <td><input type="text" /></td>
          <td><input type="text" /></td>`;
        tbody.appendChild(tr);
      }
    }
    function recalc(){
      let sum=0;
      $$("#sheet tbody tr").forEach(tr=>{
        const [from,to,brk]=$$("input",tr);
        let mins=0;
        if(from.value&&to.value){
          const [fh,fm]=from.value.split(":").map(Number);
          const [th,tm]=to.value.split(":").map(Number);
          mins=(th*60+tm)-(fh*60+fm)-(parseInt(brk.value||"0",10));
          if(mins<0) mins=0;
        }
        const hrs=mins/60; sum+=hrs; $(".dayTotal",tr).textContent=hrs.toFixed(2);
      });
      $("#sumHours").textContent=sum.toFixed(2);
      saveInputs();
    }
    function saveInputs(){
      const {y,m}=currentYM(); const key=inputsKeyFor(y,m);
      const rows=$$("#sheet tbody tr").map(tr=>$$("input",tr).map(i=>i.value));
      ls.set(key,rows);
    }
    function loadInputs(){
      const {y,m}=currentYM(); const key=inputsKeyFor(y,m);
      const rows=ls.get(key,[]);
      rows.forEach((vals,i)=>{
        const tr=$$("#sheet tbody tr")[i]; if(!tr) return;
        $$("input",tr).forEach((inp,idx)=>{inp.value=vals[idx]||"";});
      });
      recalc();
    }

    $("#sheet").addEventListener("input",e=>{ if(e.target.tagName==="INPUT") recalc(); });
    $("#btnClear").addEventListener("click",()=>{
      if(!confirm({sv:"T√∂m alla f√§lt?",de:"Alle Felder leeren?",en:"Clear all fields?"}[lang])) return;
      $$("#sheet input").forEach(i=>i.value=""); recalc();
    });

    // spara toppf√§lt
    ["empName","workplace","targetPerDay","restrict"].forEach(id=>{
      const key="top:"+id; const el=$("#"+id); el.value=ls.get(key,""); el.addEventListener("input",()=>ls.set(key,el.value));
    });

    // M√•nad/√•r ‚Äì default till nu, bygg om tabellen n√§r det √§ndras
    (function initMonthYear(){
      const now=new Date();
      $("#month").value=ls.get("top:month", String(now.getMonth()+1));
      $("#year").value=ls.get("top:year", String(now.getFullYear()));
      ["month","year"].forEach(id=>{
        const el=$("#"+id);
        el.addEventListener("input",()=>{
          ls.set("top:"+id,el.value);
          buildRows(); loadInputs();
        });
      });
    })();

    /* ---------- init ---------- */
    (function init(){
      applyI18n();
      syncCompanyUI();
      // tabell f√∂r aktuell m√•nad
      buildRows();
      loadInputs();
    })();
  </script>
</body>
</html>
