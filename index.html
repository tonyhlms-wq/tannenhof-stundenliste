<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tannenhofs tidtabell</title>
<link rel="icon" href="favicon.ico">
<style>
  :root{
    --bg:#f5f8f6;
    --card:#eaf3ec;
    --ink:#103b22;
    --ink-2:#244c32;
    --brand:#1e6b3a;
    --brand-d:#164f2b;
    --chip:#eef5ef;
    --row:#f2f7f3;
    --ok:#0b7;
    --warn:#e6a700;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .appbar{position:sticky;top:0;z-index:10;display:flex;gap:.75rem;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#205e33,#17522b);color:#fff;padding:.8rem .9rem}
  .brand{display:flex;align-items:center;gap:.6rem;min-width:0}
  .brand img{width:28px;height:28px;border-radius:6px;object-fit:cover;background:#fff}
  .brand h1{font-size:1.1rem;line-height:1.1;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar-actions{display:flex;gap:.6rem}
  .pill{background:#fff;border-radius:18px;padding:.55rem .85rem;color:var(--ink);font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.15) inset}
  .pill.dark{background:#0f1a14;color:#fff}
  .section{background:var(--card);margin:.9rem;border-radius:16px;padding:.9rem 1rem;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .totalbar{display:flex;justify-content:space-between;align-items:center;font-weight:800}
  .table-wrap{overflow:auto;padding:0 .6rem 140px} /* extra botten s√• FAB inte skymmer sista raden */
  table{border-collapse:separate;border-spacing:0 .75rem;min-width:760px;width:100%}
  thead th{font-size:.95rem;text-align:left;color:var(--ink-2)}
  tbody td{vertical-align:middle}
  tr.row{background:var(--row);box-shadow:0 1px 0 rgba(0,0,0,.04) inset}
  tr.row td{padding:.5rem .6rem}
  tr.row .cell{background:#fff;border-radius:14px;padding:.55rem .6rem;border:1px solid #e0ece3}
  tr.today{outline:3px solid #1b7b3b;outline-offset:0;border-radius:16px}
  tr.today td:first-child{border-left:6px solid #1b7b3b;border-radius:14px}
  .chip{display:flex;align-items:center;gap:.45rem;background:var(--chip);border-radius:14px;border:1px solid #ddebe1;padding:.55rem .75rem}
  .chip input{border:0;outline:0;background:transparent;font-size:1rem;width:180px}
  .num{width:44px;text-align:center;font-weight:700}
  .sel{appearance:none;border:0;background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path d="M5 7l5 6 5-6" fill="none" stroke="%23123" stroke-width="2" stroke-linecap="round"/></svg>') no-repeat right .5rem center;background-size:18px;border-radius:12px;padding:.55rem .9rem;width:120px;border:1px solid #e0ece3}
  .tot{font-weight:800}
  .actions{display:flex;gap:.5rem}
  .act{width:48px;height:48px;border-radius:14px;background:#1e6b3a;color:#fff;display:grid;place-items:center;border:0}
  .fab{position:fixed;left:16px;bottom:22px;width:72px;height:72px;border-radius:22px;background:#1e6b3a;color:#cfe8d8;border:0;display:grid;place-items:center;box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:4}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:20}
  .sheet{width:min(520px,92vw);background:#fff;border-radius:20px;padding:18px;border:1px solid #dfeae3;box-shadow:0 16px 50px rgba(0,0,0,.22)}
  .form{display:grid;gap:14px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .field label{font-size:.9rem;color:#335846;display:block;margin-bottom:6px}
  .field input[type="text"], .field select{width:100%;border:1px solid #d7e6dc;border-radius:12px;padding:.6rem .7rem;font-size:1rem}
  .range{display:flex;align-items:center;gap:.7rem}
  .close{float:right;border:0;background:#0f1a14;color:#fff;border-radius:12px;padding:.4rem .7rem}
  .wm{position:fixed;right:14px;bottom:70px;opacity:.7;pointer-events:none;z-index:0}
  .wm img{width:240px;max-width:45vw;opacity:inherit;filter:grayscale(.05)}
  .note{font-size:.82rem;color:#537462}
  .switcher{display:flex;gap:.4rem}
  .mini{border:1px dashed #c9dacf;border-radius:10px;padding:.35rem .55rem;background:#f7fbf8}
  .hidden{display:none}
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">
    <img id="logo" alt="logo" src="tnh-tree-192.png">
    <h1 id="title">Tannenhofs tidtabell</h1>
  </div>
  <div class="bar-actions">
    <button class="pill" id="shareBtn">Dela / Skicka</button>
    <button class="pill dark" id="printBtn">Skriv ut / PDF</button>
  </div>
</header>

<section class="section">
  <div class="totalbar">
    <div id="totalTitle">‚è≥ Totalt ‚Äì <span id="monthLabel"></span></div>
    <div id="grandTotal">0.00</div>
  </div>
</section>

<div class="table-wrap">
  <table aria-label="timesheet">
    <thead>
      <tr>
        <th class="num" id="thDay">Dag</th>
        <th id="thFrom">Fr√•n</th>
        <th id="thTo">Till</th>
        <th id="thBreak">Paus</th>
        <th id="thTot">Totalt</th>
        <th id="thProj">Projekt/plats</th>
        <th id="thAct">√Ötg√§rd</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- watermark -->
<div class="wm" id="wm"><img id="wmImg" src="tnh-tree-512.png" alt=""></div>

<!-- Settings FAB -->
<button class="fab" id="fab">‚öôÔ∏è</button>

<!-- Settings modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <button class="close" id="closeModal">St√§ng</button>
    <h2 style="margin:.3rem 0 1rem">Inst√§llningar</h2>
    <div class="form">
      <div class="row2">
        <div class="field">
          <label id="lblCompany">F√∂retagsnamn</label>
          <input id="company" type="text" placeholder="TH√úRINGER TANNENHOF">
        </div>
        <div class="field">
          <label id="lblLang">Spr√•k</label>
          <select id="lang">
            <option value="sv">Svenska</option>
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label id="lblWm">Vattenst√§mpel</label>
          <div class="range">
            <input id="wmRange" type="range" min="0" max="100" value="70">
            <span id="wmVal">70%</span>
          </div>
          <div class="note" id="wmNote">0% = av, 100% = fullt</div>
        </div>
        <div class="field">
          <label id="lblLogo">Byt logga</label>
          <input id="logoFile" type="file" accept="image/*">
          <div class="note" id="logoNote">Visas uppe till v√§nster och i vattenst√§mpeln</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- I18N ---------- */
const i18n = {
  sv:{
    title:"Tannenhofs tidtabell",
    share:"Dela / Skicka",
    print:"Skriv ut / PDF",
    total:"Totalt",
    th:{day:"Dag",from:"Fr√•n",to:"Till",break:"Paus",tot:"Totalt",proj:"Projekt/plats",act:"√Ötg√§rd"},
    ph:{project:"Projekt/plats"},
    labels:{company:"F√∂retagsnamn",lang:"Spr√•k",wm:"Vattenst√§mpel",logo:"Byt logga",
            wmNote:"0% = av, 100% = fullt",logoNote:"Visas uppe till v√§nster och i vattenst√§mpeln"}
  },
  de:{
    title:"Tannenhofs Zeittabelle",
    share:"Teilen / Senden",
    print:"Drucken / PDF",
    total:"Gesamt",
    th:{day:"Tag",from:"Von",to:"Bis",break:"Pause",tot:"Gesamt",proj:"Projekt/Ort",act:"Aktion"},
    ph:{project:"Projekt/Ort"},
    labels:{company:"Firmenname",lang:"Sprache",wm:"Wasserzeichen",logo:"Logo wechseln",
            wmNote:"0% = aus, 100% = voll",logoNote:"Oben links & als Wasserzeichen"}
  },
  en:{
    title:"Tannenhof Timesheet",
    share:"Share / Send",
    print:"Print / PDF",
    total:"Total",
    th:{day:"Day",from:"From",to:"To",break:"Break",tot:"Total",proj:"Project/site",act:"Action"},
    ph:{project:"Project/site"},
    labels:{company:"Company",lang:"Language",wm:"Watermark",logo:"Change logo",
            wmNote:"0% = off, 100% = full",logoNote:"Shown in header & watermark"}
  }
};

/* ---------- STATE ---------- */
const state = {
  year: (new Date()).getFullYear(),
  month: (new Date()).getMonth(), // 0-11
  lang: localStorage.getItem("tnh_lang") || "sv",
  company: localStorage.getItem("tnh_company") || "TH√úRINGER TANNENHOF",
  wm: Number(localStorage.getItem("tnh_wm") ?? 70),
  logo: localStorage.getItem("tnh_logo") || null, // dataURL
  entries: JSON.parse(localStorage.getItem("tnh_entries")||"{}") // { 'YYYY-MM': { d:{from,to,break,project,photos:[..]} } }
};

const monthLabel = document.getElementById('monthLabel');
const tbody = document.getElementById('tbody');
const grandTotal = document.getElementById('grandTotal');

/* ---------- UTIL ---------- */
function daysInMonth(y,m){return new Date(y, m+1, 0).getDate();}
function fmt(n){return n.toFixed(2);}
function parseTime(s){
  if(!s) return 0;
  const [h,mm]=s.split(":").map(Number);
  return h*60+mm;
}
function minutesToHHMM(min){
  const h=Math.floor(min/60), m=min%60;
  return (h<10?"0":"")+h+":"+(m<10?"0":"")+m;
}

/* Workday helpers */
function isWorkday(y,m,d){
  const w = new Date(y, m, d).getDay(); // 0 Sun .. 6 Sat
  return w>=1 && w<=5;
}
function firstWorkdayOfMonth(y,m){
  const max = daysInMonth(y,m);
  for(let d=1; d<=max; d++) if(isWorkday(y,m,d)) return d;
  return 1;
}

/* ---------- BUILD ---------- */
function optionsHHMM(step=15){
  const out=[];
  for(let h=0; h<24; h++){
    for(let m=0; m<60; m+=step){
      const t=(h<10?"0":"")+h+":"+(m<10?"0":"")+m;
      out.push(`<option value="${t}">${t}</option>`);
    }
  }
  return out.join("");
}

function buildRows(){
  tbody.innerHTML="";
  const key = `${state.year}-${String(state.month+1).padStart(2,'0')}`;
  if(!state.entries[key]) state.entries[key]={};
  const days = daysInMonth(state.year,state.month);
  const opts = optionsHHMM(15);

  for(let d=1; d<=days; d++){
    const tr = document.createElement("tr");
    tr.className="row";
    tr.dataset.day=d;

    const dayTd = document.createElement("td");
    dayTd.className="num cell";
    dayTd.innerHTML = `<span> ${d}</span>`;
    tr.appendChild(dayTd);

    const fromTd = document.createElement("td"); fromTd.className="cell";
    const toTd   = document.createElement("td"); toTd.className="cell";
    const brTd   = document.createElement("td"); brTd.className="cell";
    fromTd.innerHTML = `<select class="sel from"><option value=""></option>${opts}</select>`;
    toTd.innerHTML   = `<select class="sel to"><option value=""></option>${opts}</select>`;
    brTd.innerHTML   = `<select class="sel br">
      <option value="00:00">00:00</option>
      <option value="00:15">00:15</option>
      <option value="00:30">00:30</option>
      <option value="00:45">00:45</option>
      <option value="01:00">01:00</option>
      <option value="01:30">01:30</option>
      <option value="02:00">02:00</option>
    </select>`;
    tr.append(fromTd,toTd,brTd);

    const totTd = document.createElement("td"); totTd.className="tot";
    totTd.textContent="0.00";
    tr.appendChild(totTd);

    const projTd = document.createElement("td");
    projTd.innerHTML = `<div class="chip">üß± <input type="text" class="project" placeholder="${i18n[state.lang].ph.project}"></div>`;
    tr.appendChild(projTd);

    const actTd = document.createElement("td");
    actTd.className="actions";
    actTd.innerHTML = `
      <button class="act noteBtn" title="Anteckning">üìù</button>
      <button class="act camBtn"  title="Kamera/Galleri">üì∑</button>
    `;
    tr.appendChild(actTd);

    tbody.appendChild(tr);
  }

  restoreMonthState();
  attachRowHandlers();
  highlightToday();
  updateTexts(); // ensure placeholders etc are correct
  saveAll();
}

function attachRowHandlers(){
  tbody.querySelectorAll("tr.row").forEach(tr=>{
    const d = Number(tr.dataset.day);
    const selFrom = tr.querySelector("select.from");
    const selTo   = tr.querySelector("select.to");
    const selBr   = tr.querySelector("select.br");
    const proj    = tr.querySelector("input.project");
    const totTd   = tr.querySelector(".tot");
    const key = monthKey();
    if(!state.entries[key][d]) state.entries[key][d]={photos:[]};

    function recalc(){
      const f=selFrom.value, t=selTo.value, b=selBr.value;
      let tot=0;
      if(f && t){
        const mins = parseTime(t)-parseTime(f)-parseTime(b);
        tot = Math.max(0, mins)/60;
      }
      totTd.textContent=fmt(tot);
      state.entries[key][d].from=f;
      state.entries[key][d].to=t;
      state.entries[key][d].break=b;
      updateGrandTotal();
      saveAll();
    }
    selFrom.addEventListener("change",recalc);
    selTo.addEventListener("change",recalc);
    selBr.addEventListener("change",recalc);
    proj.addEventListener("input",()=>{
      state.entries[key][d].project=proj.value; saveAll();
    });

    tr.querySelector(".camBtn").addEventListener("click",()=>openCameraMenu(d));
    tr.querySelector(".noteBtn").addEventListener("click",()=>{
      const cur = state.entries[key][d].note || "";
      const txt = prompt("Anteckning / Notiz / Note:", cur);
      if(txt!==null){ state.entries[key][d].note=txt; saveAll(); }
    });
  });
}

function updateGrandTotal(){
  let sum=0;
  tbody.querySelectorAll(".tot").forEach(td=>{ sum+=Number(td.textContent); });
  grandTotal.textContent = fmt(sum);
}

function monthKey(){return `${state.year}-${String(state.month+1).padStart(2,'0')}`;}

function restoreMonthState(){
  const key = monthKey();
  const map = state.entries[key]||{};
  tbody.querySelectorAll("tr.row").forEach(tr=>{
    const d = Number(tr.dataset.day);
    const e = map[d]||{};
    if(e.from) tr.querySelector("select.from").value=e.from;
    if(e.to)   tr.querySelector("select.to").value=e.to;
    if(e.break)tr.querySelector("select.br").value=e.break;
    if(e.project) tr.querySelector("input.project").value=e.project;
  });
  updateGrandTotal();
}

/* ---------- TODAY HIGHLIGHT ---------- */
function highlightToday(){
  document.querySelectorAll("tr.row.today").forEach(tr=>tr.classList.remove("today"));
  const now = new Date();
  const sameMonth = (state.year===now.getFullYear() && state.month===now.getMonth());
  const days = daysInMonth(state.year,state.month);
  let dToMark;

  if(sameMonth){
    dToMark = now.getDate();
  }else{
    dToMark = firstWorkdayOfMonth(state.year,state.month);
  }
  dToMark = Math.max(1, Math.min(days, dToMark));
  const tr = tbody.querySelector(`tr.row[data-day="${dToMark}"]`);
  if(tr) tr.classList.add("today");
}

/* ---------- CAMERA / GALLERY ---------- */
function openCameraMenu(day){
  const lang = state.lang;
  const txt = (lang==="de")?"Was m√∂chtest du tun?\n1 = Foto aufnehmen\n2 = Aus Galerie w√§hlen\n3 = Letztes Foto ansehen"
            : (lang==="en")?"What do you want to do?\n1 = Take photo\n2 = Pick from gallery\n3 = View last photo"
            : "Vad vill du g√∂ra?\n1 = Ta foto\n2 = V√§lj fr√•n galleri\n3 = Visa senaste foto";
  const choice = prompt(txt,"1");
  if(choice===null) return;
  if(choice.trim()==="3"){ viewLastPhoto(day); return; }
  const input = document.createElement('input');
  input.type='file';
  input.accept="image/*";
  if(choice.trim()==="1") input.capture="environment"; // √∂ppna kamera
  input.onchange = async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const dataURL = await fileToDataURL(file);
    const key = monthKey();
    if(!state.entries[key][day]) state.entries[key][day]={photos:[]};
    state.entries[key][day].photos.push(dataURL);
    saveAll();
    alert( (lang==="de")?"Foto gespeichert":"Bild sparad" );
  };
  input.click();
}
function viewLastPhoto(day){
  const key = monthKey();
  const arr = (state.entries[key]?.[day]?.photos)||[];
  if(!arr.length){ alert( state.lang==="de" ? "Kein Foto gespeichert" : (state.lang==="en"?"No photo saved":"Ingen bild sparad") ); return; }
  const w = window.open();
  const img = arr[arr.length-1];
  w.document.write(`<img style="max-width:100%;height:auto" src="${img}">`);
}
function fileToDataURL(file){
  return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });
}

/* ---------- SETTINGS ---------- */
const modal = document.getElementById('modal');
document.getElementById('fab').onclick = ()=>{
  document.getElementById('company').value = state.company;
  document.getElementById('lang').value = state.lang;
  document.getElementById('wmRange').value = state.wm;
  document.getElementById('wmVal').textContent = state.wm+"%";
  modal.style.display='flex';
};
document.getElementById('closeModal').onclick=()=>modal.style.display='none';

document.getElementById('company').addEventListener('input',(e)=>{
  state.company = e.target.value || "TH√úRINGER TANNENHOF";
  localStorage.setItem("tnh_company", state.company);
  updateTexts();
});
document.getElementById('lang').addEventListener('change',(e)=>{
  state.lang = e.target.value;
  localStorage.setItem("tnh_lang", state.lang);
  updateTexts();
});
document.getElementById('wmRange').addEventListener('input',(e)=>{
  state.wm = Number(e.target.value);
  document.getElementById('wmVal').textContent = state.wm+"%";
  applyWatermark();
  localStorage.setItem("tnh_wm", state.wm);
});
document.getElementById('logoFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  state.logo = await fileToDataURL(file);
  localStorage.setItem("tnh_logo", state.logo);
  applyLogo();
  applyWatermark();
});

/* ---------- TEXTS / UI ---------- */
function updateTexts(){
  const L = i18n[state.lang];
  document.getElementById('title').textContent = L.title;
  document.getElementById('shareBtn').textContent = L.share;
  document.getElementById('printBtn').textContent = L.print;
  document.getElementById('totalTitle').firstChild.textContent = "‚è≥ "+L.total+" ‚Äì ";
  document.getElementById('thDay').textContent = L.th.day;
  document.getElementById('thFrom').textContent = L.th.from;
  document.getElementById('thTo').textContent = L.th.to;
  document.getElementById('thBreak').textContent = L.th.break;
  document.getElementById('thTot').textContent = L.th.tot;
  document.getElementById('thProj').textContent = L.th.proj;
  document.getElementById('thAct').textContent = L.th.act;

  document.getElementById('lblCompany').textContent = L.labels.company;
  document.getElementById('lblLang').textContent = L.labels.lang;
  document.getElementById('lblWm').textContent = L.labels.wm;
  document.getElementById('wmNote').textContent = L.labels.wmNote;
  document.getElementById('lblLogo').textContent = L.labels.logo;
  document.getElementById('logoNote').textContent = L.labels.logoNote;

  document.getElementById('company').placeholder = state.company;
  document.getElementById('title').textContent = state.company? `${state.company} ‚Äì ${L.title.split(" ").slice(-1)[0]==="Timesheet"?L.title: L.title}` : L.title;

  // uppdatera placeholders i projektf√§lt
  document.querySelectorAll('input.project').forEach(inp=>{ inp.placeholder = L.ph.project; });

  // uppdatera m√•nadsetikett
  const monthName = new Date(state.year, state.month, 1).toLocaleDateString(
    state.lang==="de"?"de-DE":(state.lang==="en"?"en-GB":"sv-SE"),
    {month:'long', year:'numeric'}
  );
  monthLabel.textContent = monthName.charAt(0).toUpperCase()+monthName.slice(1);

  // uppdatera tops i appbar (f√∂retagsnamn visas i title redan)
}

function applyWatermark(){
  const wm = document.getElementById('wm');
  wm.style.opacity = (state.wm/100).toString();
}
function applyLogo(){
  const el = document.getElementById('logo');
  if(state.logo) el.src = state.logo;
  const wmImg = document.getElementById('wmImg');
  wmImg.src = state.logo || "tnh-tree-512.png";
}

/* ---------- SAVE ---------- */
function saveAll(){
  localStorage.setItem("tnh_entries", JSON.stringify(state.entries));
}

/* ---------- INIT ---------- */
function init(){
  // header company
  document.getElementById('company').value = state.company;
  applyLogo();
  applyWatermark();
  buildRows();
}

init();
</script>
</body>
</html>
