<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tannenhofs tidtabell</title>
<style>
  :root{
    --brand:#2f6f3a;         /* huvudgr√∂n */
    --brand-2:#245730;       /* m√∂rkare gr√∂n */
    --ink:#20322a;           /* textf√§rg */
    --muted:#6b7f72;
    --bg:#f5faf7;
    --card:#ffffff;
    --ring:#cfe3d6;
    --row:#f0f7f2;
    --radius:14px;
    --gap:14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink);
    background:var(--bg);
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:5;
    background:var(--brand);
    color:#fff;
    border-bottom:3px solid #1d4024;
  }
  .container{
    max-width:1100px;
    margin:0 auto;
    padding:0 12px;
  }
  .bar{
    display:flex; align-items:center; gap:12px;
    padding:12px 0;
  }
  header img{
    height:60px !important;   /* st√∂rre logga */
    width:auto !important;
    object-fit:contain;
    border-radius:10px;
    background:#1e5130;
    padding:6px;
  }
  .title{
    font-weight:700; font-size:20px; letter-spacing:.2px;
  }

  /* Panel med kontroller */
  .panel{
    margin:16px auto;
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:var(--radius);
    padding:14px;
    display:grid;
    grid-template-columns:1fr;
    gap:var(--gap);
  }
  .row{
    display:grid; gap:10px;
  }
  @media (min-width:760px){
    .panel{grid-template-columns:2fr 1fr 1fr 1fr}
  }
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  .field{width:100%}
  input[type="text"], input[type="file"], select, textarea{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid var(--ring);
    background:#fff;
    font:inherit;
  }
  .btn{
    appearance:none; border:0;
    background:var(--brand); color:#fff;
    padding:12px 14px; border-radius:12px;
    font-weight:600;
    box-shadow:0 1px 0 #174022 inset, 0 1px 2px rgba(0,0,0,.08);
    cursor:pointer;
  }
  .btn.secondary{
    background:#fff; color:var(--brand);
    border:1px solid var(--ring);
  }
  .btn:active{transform:translateY(1px)}

  /* Tabell */
  .tableWrap{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:var(--radius);
    overflow:hidden;
    margin:16px 0 70px;
  }
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{
    position:sticky; top:0; z-index:3;
    background:#eaf4ee; color:#315342;
    font-size:13px; text-align:left; padding:10px 12px;
    border-bottom:1px solid var(--ring);
  }
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:var(--row)}
  td{padding:10px 8px; vertical-align:middle}
  td .cell{
    display:flex; gap:8px; align-items:center;
  }
  input[type="time"], input[type="number"]{
    width:100%; padding:10px 10px; height:40px;
    border-radius:10px; border:1px solid var(--ring); background:#fff; font:inherit;
  }
  .narrow{max-width:110px}
  .totalCell{
    min-width:78px; text-align:right; font-variant-numeric:tabular-nums;
    padding-right:6px; color:#123d27; font-weight:600;
  }
  .right{ text-align:right }

  .actionBtn{
    background:var(--brand); color:#fff; border:0;
    width:40px; height:40px; border-radius:10px; cursor:pointer;
    display:inline-flex; align-items:center; justify-content:center;
  }
  .gear{
    position:fixed; right:16px; bottom:16px;
    width:54px; height:54px; border-radius:16px; z-index:4;
    background:var(--brand-2); color:#fff; border:0; box-shadow:0 8px 24px rgba(0,0,0,.18);
  }

  /* Summarader */
  .summary{
    display:flex; gap:14px; flex-wrap:wrap;
    margin:12px 0 6px;
    color:#214735;
  }
  .chip{
    background:#eaf4ee; border:1px solid var(--ring);
    padding:8px 10px; border-radius:10px; font-weight:600;
  }

  /* Modal f√∂r anteckningar */
  dialog#noteModal{
    width:min(720px, 95vw);
    border:0; border-radius:16px; padding:0; overflow:hidden;
    box-shadow:0 24px 60px rgba(0,0,0,.35);
  }
  dialog::backdrop{background:rgba(18,29,23,.55)}
  .modalHead{
    background:var(--brand); color:#fff;
    padding:12px 14px; display:flex; justify-content:space-between; align-items:center;
  }
  .modalBody{padding:14px; background:#fff}
  #noteTextarea{
    width:100%; min-height:38vh; max-height:70vh; resize:vertical;
    border:1px solid var(--ring); border-radius:12px; padding:12px; font:inherit;
  }

  /* Vattenst√§mpel nere till h√∂ger ‚Äì uppdateras via JS */
  #watermark{
    position:fixed; right:14px; bottom:14px;
    opacity:.35; pointer-events:none; z-index:0;
    display:flex; align-items:center; justify-content:center;
  }
  #watermark img{
    max-width:min(40vw, 240px);
    max-height:min(25vh, 160px);
    object-fit:contain;
    filter:grayscale(20%);
  }
  #watermark .emoji{
    font-size:clamp(72px, 12vw, 160px);
    line-height:1;
    opacity:.35;
  }

  /* Print */
  @media print{
    header, .panel, .gear{display:none !important}
    body{background:#fff}
    .tableWrap{border:0}
    thead th{background:#e8f2ec !important; -webkit-print-color-adjust:exact; print-color-adjust:exact}
    #watermark{opacity:.18} /* svagare i PDF/utskrift */
  }
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="bar">
      <!-- Liten logga uppe till v√§nster (v√§xer via CSS) -->
      <img id="headerLogo" alt="Logga" src="" />
      <div class="title">Tannenhofs tidtabell</div>
    </div>
  </div>
</header>

<main class="container">

  <!-- Kontrollpanel -->
  <section class="panel" id="panel">
    <div class="row">
      <div>
        <label for="company">F√∂retag</label>
        <input id="company" class="field" type="text" placeholder="TH√úRINGER TANNENHOF" value="TH√úRINGER TANNENHOF">
      </div>

      <div>
        <label for="logoEmoji">Logga (bild eller emoji)</label>
        <input id="logoEmoji" class="field" type="text" placeholder="t.ex. üå≤ eller ü¶å">
      </div>

      <div>
        <label for="logoFile">V√§lj bildfil (PNG/JPG/SVG)</label>
        <input id="logoFile" class="field" type="file" accept="image/*">
      </div>

      <div>
        <label for="lang">Spr√•k</label>
        <select id="lang" class="field">
          <option value="sv" selected>Svenska</option>
          <option value="de">Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>

      <div>
        <label for="month">M√•nad</label>
        <select id="month" class="field"></select>
      </div>

      <div>
        <label for="year">√Ör</label>
        <select id="year" class="field"></select>
      </div>

      <div>
        <label>&nbsp;</label>
        <button id="genDays" class="btn field">Skapa dagar</button>
      </div>

      <div>
        <label>&nbsp;</label>
        <div style="display:flex; gap:8px">
          <button id="shareBtn" class="btn secondary">Dela / Skicka</button>
          <button id="printBtn" class="btn">Skriv ut / PDF</button>
        </div>
      </div>

      <div>
        <label><input type="checkbox" id="autosave"> Autospara</label>
        <div style="margin-top:8px">
          <button id="clearBtn" class="btn secondary" type="button">Rensa allt</button>
        </div>
      </div>
    </div>

    <div class="summary" id="summary">
      <div class="chip">Summa: <span id="sumH">0.00</span> h</div>
      <div class="chip">Flest timmar/dag: <span id="maxH">0.00</span> h</div>
      <div class="chip">Dagar ifyllda: <span id="filledDays">0</span></div>
    </div>
  </section>

  <!-- Tabell -->
  <section class="tableWrap">
    <table id="sheet">
      <thead>
        <tr>
          <th>Dag</th>
          <th>Fr√•n</th>
          <th>Till</th>
          <th>Paus (h:mm)</th>
          <th>Totalt (h)</th>
          <th>Projekt</th>
          <th class="right">√Ötg√§rder</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

</main>

<!-- Flytande inst√§llningsknapp (valfri att anv√§nda senare) -->
<button class="gear" title="Inst√§llningar" id="gear" aria-label="Inst√§llningar">‚öôÔ∏è</button>

<!-- Vattenst√§mpel (uppdateras via JS) -->
<div id="watermark" aria-hidden="true"></div>

<!-- Modal f√∂r anteckningar -->
<dialog id="noteModal">
  <div class="modalHead">
    <strong>Anteckningar</strong>
    <button id="noteClose" class="btn secondary">St√§ng</button>
  </div>
  <div class="modalBody">
    <textarea id="noteTextarea" placeholder="Skriv dina anteckningar h√§r..."></textarea>
    <div style="display:flex; gap:10px; margin-top:10px; justify-content:flex-end">
      <button id="noteSave" class="btn">Spara</button>
    </div>
  </div>
</dialog>

<script>
/* ====== Spr√•k ====== */
const STR = {
  sv: {
    title: "Tannenhofs tidtabell",
    company: "F√∂retag",
    chooseFile: "V√§lj bildfil (PNG/JPG/SVG)",
    lang: "Spr√•k",
    month: "M√•nad",
    year: "√Ör",
    createDays: "Skapa dagar",
    share: "Dela / Skicka",
    print: "Skriv ut / PDF",
    autosave: "Autospara",
    clear: "Rensa allt",
    day: "Dag", from: "Fr√•n", to: "Till", break: "Paus (h:mm)", total: "Totalt (h)", project: "Projekt", actions:"√Ötg√§rder",
    notes: "Anteckningar", save:"Spara", close:"St√§ng",
    sum:"Summa", maxDay:"Flest timmar/dag", filled:"Dagar ifyllda"
  },
  de: {
    title: "Tannenhof Stundenliste",
    company: "Arbeitgeber",
    chooseFile: "Bilddatei w√§hlen (PNG/JPG/SVG)",
    lang: "Sprache",
    month: "Monat",
    year: "Jahr",
    createDays: "Tage erstellen",
    share: "Teilen / Senden",
    print: "Drucken / PDF",
    autosave: "Autospeichern",
    clear: "Alles l√∂schen",
    day: "Tag", from: "Von", to: "Bis", break: "Pause (Std:Min)", total: "Gesamt (Std)", project:"Projekt", actions:"Aktionen",
    notes:"Notizen", save:"Speichern", close:"Schlie√üen",
    sum:"Summe", maxDay:"Meiste Std/Tag", filled:"Tage gef√ºllt"
  },
  en: {
    title: "Tannenhof Timesheet",
    company: "Company",
    chooseFile: "Choose image (PNG/JPG/SVG)",
    lang: "Language",
    month: "Month",
    year: "Year",
    createDays: "Generate days",
    share: "Share / Send",
    print: "Print / PDF",
    autosave: "Autosave",
    clear: "Clear all",
    day:"Day", from:"From", to:"To", break:"Break (h:mm)", total:"Total (h)", project:"Project", actions:"Actions",
    notes:"Notes", save:"Save", close:"Close",
    sum:"Total", maxDay:"Max hours/day", filled:"Days filled"
  }
};

/* ====== Hj√§lpfunktioner ====== */
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

function pad2(n){return String(n).padStart(2,'0')}

function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

function parseBreakToHours(v){
  if(!v) return 0;
  const [h,mm] = v.split(':').map(n=>parseInt(n||0,10));
  return (h||0) + (mm||0)/60;
}
function diffTime(from,to){
  if(!from || !to) return 0;
  const [fh,fm]=from.split(':').map(Number);
  const [th,tm]=to.split(':').map(Number);
  let start = fh*60+fm, end = th*60+tm;
  if(end < start) end += 24*60; // √∂ver midnatt
  return (end-start)/60;
}

/* ====== Element ====== */
const headerLogo = $('#headerLogo');
const titleEl = $('.title');
const langSel = $('#lang');
const companyEl = $('#company');
const monthSel = $('#month');
const yearSel = $('#year');
const genBtn = $('#genDays');
const tbody = $('#tbody');
const sumH = $('#sumH'), maxH = $('#maxH'), filledDays = $('#filledDays');
const autosave = $('#autosave');
const clearBtn = $('#clearBtn');
const shareBtn = $('#shareBtn');
const printBtn = $('#printBtn');
const logoFile = $('#logoFile');
const logoEmoji = $('#logoEmoji');
const watermark = $('#watermark');

const noteModal = $('#noteModal');
const noteClose = $('#noteClose');
const noteSave = $('#noteSave');
const noteTextarea = $('#noteTextarea');

let currentLang = 'sv';
let noteRowIndex = null;

/* ====== Init val f√∂r √•r & m√•nad ====== */
(function initMonthYear(){
  const now = new Date();
  const months = [
    ['Jan','Januari'],['Feb','Februari'],['Mar','Mars'],['Apr','April'],['Maj','Maj'],['Jun','Juni'],
    ['Jul','Juli'],['Aug','Augusti'],['Sep','September'],['Okt','Oktober'],['Nov','November'],['Dec','December']
  ];
  monthSel.innerHTML = months.map((m,idx)=>`<option value="${idx}" ${idx===now.getMonth()?'selected':''}>${m[1].slice(0,3)}</option>`).join('');
  const y = now.getFullYear();
  let ys = '';
  for(let i=y-1;i<=y+2;i++){
    ys += `<option value="${i}" ${i===y?'selected':''}>${i}</option>`;
  }
  yearSel.innerHTML = ys;
})();

/* ====== Byt spr√•k (UI-texter) ====== */
function applyLang(){
  const L = STR[currentLang];
  titleEl.textContent = L.title;
  $('label[for="company"]').textContent = L.company;
  $('label[for="logoEmoji"]').textContent = "Logga (bild eller emoji)";
  $('label[for="logoFile"]').textContent = L.chooseFile;
  $('label[for="lang"]').textContent = L.lang;
  $('label[for="month"]').textContent = L.month;
  $('label[for="year"]').textContent = L.year;
  $('#genDays').textContent = L.createDays;
  $('#shareBtn').textContent = L.share;
  $('#printBtn').textContent = L.print;
  $('#clearBtn').textContent = L.clear;
  $('label[for="autosave"]')?.remove(); // vi s√§tter om etiketten nedan
  autosave.parentElement.firstChild.textContent = `${L.autosave} `;
  // Tabellhuvud
  const th = $$('thead th');
  if(th.length){
    th[0].textContent = L.day;
    th[1].textContent = L.from;
    th[2].textContent = L.to;
    th[3].textContent = L.break;
    th[4].textContent = L.total;
    th[5].textContent = L.project;
    th[6].textContent = L.actions;
  }
}

/* ====== Skapa dagarader ====== */
function buildRows(){
  const m = parseInt(monthSel.value,10);
  const y = parseInt(yearSel.value,10);
  const n = daysInMonth(y,m);
  let html = '';
  for(let d=1; d<=n; d++){
    html += `
      <tr data-day="${d}">
        <td>${d}</td>
        <td><input type="time" class="from narrow"></td>
        <td><input type="time" class="to narrow"></td>
        <td><input type="time" class="break narrow" value="00:00"></td>
        <td class="totalCell">0.00</td>
        <td><input type="text" class="project" placeholder="Projekt / plats"></td>
        <td class="right">
          <button class="actionBtn noteBtn" title="Anteckningar">üìù</button>
        </td>
      </tr>
    `;
  }
  tbody.innerHTML = html;
  attachRowEvents();
  restoreData();  // ladda ev. tidigare tider
  recalcAll();
}

/* ====== H√§ndelser i rader ====== */
function attachRowEvents(){
  $$('#sheet input[type="time"], #sheet input[type="text"]').forEach(el=>{
    el.addEventListener('input', ()=>{ recalcAll(); if(autosave.checked) saveData(); });
  });
  $$('.noteBtn').forEach((btn,idx)=>{
    btn.addEventListener('click', ()=>{
      noteRowIndex = idx;
      const data = loadAllData();
      noteTextarea.value = (data.notes?.[idx]||'');
      noteModal.showModal();
      noteTextarea.focus();
    });
  });
}

/* ====== R√§kna om totals & summary ====== */
function recalcAll(){
  let sum = 0, max=0, filled=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const from = $('.from',tr).value;
    const to = $('.to',tr).value;
    const br = $('.break',tr).value;
    const h = Math.max(0, diffTime(from,to) - parseBreakToHours(br));
    $('.totalCell',tr).textContent = h.toFixed(2);
    if(h>0){ filled++; sum+=h; if(h>max) max=h; }
  });
  sumH.textContent = sum.toFixed(2);
  maxH.textContent = max.toFixed(2);
  filledDays.textContent = filled;
}

/* ====== Lokalt lager ====== */
const KEY = 'tannenhof_timesheet_v2';

function loadAllData(){
  try{
    const raw = localStorage.getItem(KEY);
    return raw ? JSON.parse(raw) : {};
  }catch(e){ return {}; }
}
function restoreData(){
  const data = loadAllData();
  if(!data || !data.rows) return;
  const rows = $$('#tbody tr');
  rows.forEach((tr,i)=>{
    const r = data.rows[i]; if(!r) return;
    $('.from',tr).value = r.from || '';
    $('.to',tr).value = r.to || '';
    $('.break',tr).value = r.break || '00:00';
    $('.project',tr).value = r.project || '';
  });
  if(data.company) companyEl.value = data.company;
  if(data.emoji) logoEmoji.value = data.emoji;
  if(data.lang) { currentLang = data.lang; langSel.value=currentLang; applyLang(); }
  if(data.month!=null) monthSel.value = data.month;
  if(data.year) yearSel.value = data.year;
  // √•terst√§ll headerlogga om dataUrl fanns sparad
  if(data.logoSrc) { headerLogo.src = data.logoSrc; updateWatermark(); }
}
function saveData(){
  const rows = $$('#tbody tr').map(tr=>({
    from: $('.from',tr).value,
    to: $('.to',tr).value,
    break: $('.break',tr).value,
    project: $('.project',tr).value
  }));
  const out = {
    rows,
    notes: loadAllData().notes || [],
    company: companyEl.value,
    emoji: logoEmoji.value,
    lang: currentLang,
    month: parseInt(monthSel.value,10),
    year: parseInt(yearSel.value,10),
    logoSrc: headerLogo.src || ''
  };
  localStorage.setItem(KEY, JSON.stringify(out));
}

/* ====== Logga: fil/emoji + vattenst√§mpel ====== */
function setWatermarkToImage(src){
  watermark.innerHTML = '';
  const img = new Image();
  img.alt='';
  img.decoding='async'; img.loading='lazy';
  img.src = src;
  watermark.appendChild(img);
}
function setWatermarkToEmoji(txt){
  watermark.innerHTML='';
  const span = document.createElement('span');
  span.className='emoji';
  span.textContent = txt.trim();
  watermark.appendChild(span);
}
function updateWatermark(){
  if(headerLogo.src) { setWatermarkToImage(headerLogo.src); return; }
  if(logoEmoji.value && /\p{Extended_Pictographic}/u.test(logoEmoji.value)){
    setWatermarkToEmoji(logoEmoji.value);
    return;
  }
  watermark.innerHTML='';
}

logoEmoji.addEventListener('input', ()=>{
  headerLogo.removeAttribute('src');
  updateWatermark();
  if(autosave.checked) saveData();
});

logoFile.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    headerLogo.src = ev.target.result;
    logoEmoji.value = '';
    updateWatermark();
    if(autosave.checked) saveData();
  };
  reader.readAsDataURL(f);
});

/* ====== Anteckningsmodal ====== */
noteClose.addEventListener('click', ()=>noteModal.close());
noteSave.addEventListener('click', ()=>{
  if(noteRowIndex==null) return;
  const data = loadAllData();
  if(!data.notes) data.notes=[];
  data.notes[noteRowIndex] = noteTextarea.value || '';
  localStorage.setItem(KEY, JSON.stringify(data));
  noteModal.close();
});
/* Klick p√• ESC st√§nger ocks√• dialog ‚Äì st√∂ds nativt */

/* ====== Dela / skriva ut ====== */
printBtn.addEventListener('click', ()=>window.print());

shareBtn.addEventListener('click', async ()=>{
  // enkel sammanst√§llning
  const lines = [];
  lines.push(`${companyEl.value}\n`);
  $$('#tbody tr').forEach(tr=>{
    const d = tr.dataset.day;
    const fr = $('.from',tr).value||'';
    const till = $('.to',tr).value||'';
    const br = $('.break',tr).value||'00:00';
    const tot = $('.totalCell',tr).textContent;
    const proj = $('.project',tr).value||'-';
    lines.push(`${pad2(d)}  ${fr}‚Äì${till}  paus ${br}  = ${tot} h  (${proj})`);
  });
  lines.push(`\nSumma: ${sumH.textContent} h`);
  const txt = lines.join('\n');
  if(navigator.share){
    try{ await navigator.share({title:'Tidrapport', text:txt}); }
    catch(e){}
  }else{
    // fallback: kopiera
    await navigator.clipboard.writeText(txt);
    alert('Sammanfattning kopierad till urklipp.');
  }
});

/* ====== Clear & Autosave ====== */
clearBtn.addEventListener('click', ()=>{
  if(confirm('Rensa alla tider och lokalt sparad data?')){
    localStorage.removeItem(KEY);
    buildRows();
  }
});
autosave.addEventListener('change', ()=>{ if(autosave.checked) saveData(); });

/* ====== Byten ====== */
langSel.addEventListener('change', ()=>{
  currentLang = langSel.value;
  applyLang();
  if(autosave.checked) saveData();
});
genBtn.addEventListener('click', ()=>{
  buildRows();
  if(autosave.checked) saveData();
});

/* ====== Start ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  applyLang();
  buildRows();
  // k√∂r n√•gra g√•nger f√∂r att s√§kert s√§tta vattenst√§mpel (om logga laddas lite senare)
  updateWatermark();
  setTimeout(updateWatermark, 200);
  setTimeout(updateWatermark, 800);
});
</script>
</body>
</html>
